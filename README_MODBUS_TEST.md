# VoltageEMS Modbus é€šä¿¡æµ‹è¯•æŒ‡å—

## æ¦‚è¿°

è¿™ä¸ªæµ‹è¯•å¥—ä»¶ä¸º VoltageEMS ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„ Modbus TCP é€šä¿¡æµ‹è¯•åŠŸèƒ½ã€‚åŒ…æ‹¬ï¼š

1. **Python Modbus æ¨¡æ‹Ÿå™¨** (`modbus_simulator.py`) - åœ¨ localhost:5020 ç«¯å£è¿è¡Œ
2. **æµ‹è¯•é…ç½®æ–‡ä»¶** (`test_modbus_5020.yaml`) - comsrv è¿æ¥åˆ°æ¨¡æ‹Ÿå™¨çš„é…ç½®
3. **è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬** (`test_modbus_communication.py`) - å…¨è‡ªåŠ¨æµ‹è¯•æµç¨‹

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### å‰ç½®æ¡ä»¶
- Python 3.8+
- Rust ç¼–è¯‘ç¯å¢ƒ (cargo)
- Redis å®¹å™¨è¿è¡Œåœ¨ localhost:6379
- å¿…éœ€çš„ Python åŒ…ï¼š`requests` (æµ‹è¯•è„šæœ¬éœ€è¦)

### å®‰è£…ä¾èµ–
```bash
# å®‰è£… Python ä¾èµ–
pip install requests

# ç¡®ä¿ Redis å®¹å™¨è¿è¡Œ
docker run -d -p 6379:6379 redis:latest
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•ä¸€ï¼šè‡ªåŠ¨åŒ–æµ‹è¯• (æ¨è)
```bash
# è¿è¡Œå®Œæ•´çš„è‡ªåŠ¨åŒ–æµ‹è¯•
python test_modbus_communication.py
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. å¯åŠ¨ Modbus æ¨¡æ‹Ÿå™¨
2. ç¼–è¯‘å¹¶å¯åŠ¨ comsrv
3. æ‰§è¡Œè¿æ¥æµ‹è¯•
4. ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
5. æ¸…ç†ç¯å¢ƒ

### æ–¹æ³•äºŒï¼šæ‰‹åŠ¨æ­¥éª¤æµ‹è¯•

#### æ­¥éª¤ 1: å¯åŠ¨ Modbus æ¨¡æ‹Ÿå™¨
```bash
# åœ¨ç»ˆç«¯ 1 ä¸­å¯åŠ¨æ¨¡æ‹Ÿå™¨
python modbus_simulator.py --host localhost --port 5020 --devices 1 2 3
```

ä½ åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
```
============================================================
ğŸ”Œ VoltageEMS Modbus TCP Simulator
============================================================
Host: localhost
Port: 5020
Devices: [1, 2, 3]
============================================================

Simulated Data Points:
â€¢ Voltage measurements (3-phase)
â€¢ Current measurements (3-phase)
â€¢ Frequency, Power Factor
â€¢ Temperature monitoring
â€¢ Power calculations (Active/Reactive)
â€¢ Energy counters
â€¢ Status indicators and control outputs
...
```

#### æ­¥éª¤ 2: å¯åŠ¨ comsrv
```bash
# åœ¨ç»ˆç«¯ 2 ä¸­è¿›å…¥ comsrv ç›®å½•å¹¶å¯åŠ¨
cd services/comsrv
cargo run --release -- --config ../../test_modbus_5020.yaml
```

#### æ­¥éª¤ 3: éªŒè¯è¿æ¥
```bash
# æ£€æŸ¥ API å¥åº·çŠ¶æ€
curl http://localhost:8080/health

# æŸ¥çœ‹é€šé“çŠ¶æ€
curl http://localhost:8080/channels

# è¯»å–æ•°æ®ç‚¹
curl http://localhost:8080/points/voltage_a
```

## ğŸ“Š æ¨¡æ‹Ÿå™¨åŠŸèƒ½

### æ”¯æŒçš„è®¾å¤‡
- **è®¾å¤‡ 1-3**: æ¯ä¸ªè®¾å¤‡éƒ½æœ‰å®Œæ•´çš„ç”µåŠ›ç³»ç»Ÿæ•°æ®æ¨¡æ‹Ÿ

### æ•°æ®ç‚¹ç±»å‹

#### è¾“å…¥å¯„å­˜å™¨ (åªè¯»æµ‹é‡å€¼)
| åœ°å€ | åç§° | æ•°æ®ç±»å‹ | ç¼©æ”¾ | å•ä½ | æè¿° |
|------|------|----------|------|------|------|
| 0-2  | voltage_a/b/c | uint16 | Ã—0.1 | V | ä¸‰ç›¸ç”µå‹ |
| 3-5  | current_a/b/c | uint16 | Ã—0.1 | A | ä¸‰ç›¸ç”µæµ |
| 6    | frequency | uint16 | Ã—0.01 | Hz | ç³»ç»Ÿé¢‘ç‡ |
| 7    | power_factor | uint16 | Ã—0.001 | - | åŠŸç‡å› æ•° |
| 8    | temperature | uint16 | Ã—0.1 | Â°C | æ¸©åº¦ |
| 9    | active_power | uint16 | Ã—0.1 | kW | æœ‰åŠŸåŠŸç‡ |
| 10   | reactive_power | uint16 | Ã—0.1 | kVAR | æ— åŠŸåŠŸç‡ |

#### ä¿æŒå¯„å­˜å™¨ (å¯è¯»å†™é…ç½®)
| åœ°å€ | åç§° | æ•°æ®ç±»å‹ | ç¼©æ”¾ | å•ä½ | æè¿° |
|------|------|----------|------|------|------|
| 0    | voltage_setpoint | uint16 | Ã—0.1 | V | ç”µå‹è®¾å®šå€¼ |
| 1    | current_limit | uint16 | Ã—0.1 | A | ç”µæµé™åˆ¶ |
| 2    | frequency_setpoint | uint16 | Ã—0.01 | Hz | é¢‘ç‡è®¾å®šå€¼ |

#### çº¿åœˆ (å¯è¯»å†™æ§åˆ¶)
| åœ°å€ | åç§° | æè¿° |
|------|------|------|
| 0-1  | cb1/cb2_control | æ–­è·¯å™¨æ§åˆ¶ |
| 2    | alarm_ack | æŠ¥è­¦ç¡®è®¤ |

#### ç¦»æ•£è¾“å…¥ (åªè¯»çŠ¶æ€)
| åœ°å€ | åç§° | æè¿° |
|------|------|------|
| 0    | power_available | ç”µæºå¯ç”¨ |
| 1    | fault_detected | æ•…éšœæ£€æµ‹ |
| 2    | comm_ok | é€šä¿¡æ­£å¸¸ |

### å®æ—¶æ•°æ®æ›´æ–°
æ¨¡æ‹Ÿå™¨ä¼šæ¯ç§’æ›´æ–°æ•°æ®ï¼Œæ¨¡æ‹ŸçœŸå®çš„ç”µåŠ›ç³»ç»Ÿå˜åŒ–ï¼š
- ç”µå‹ï¼šÂ±2% å˜åŒ–
- ç”µæµï¼šÂ±5% å˜åŒ–
- é¢‘ç‡ï¼šÂ±0.1Hz å˜åŒ–
- æ¸©åº¦ï¼šç¼“æ…¢å‘¨æœŸæ€§å˜åŒ–

## ğŸ§ª æµ‹è¯•åŠŸèƒ½

### æ”¯æŒçš„ Modbus åŠŸèƒ½ç 
- **FC 01**: è¯»çº¿åœˆ (Read Coils)
- **FC 02**: è¯»ç¦»æ•£è¾“å…¥ (Read Discrete Inputs)
- **FC 03**: è¯»ä¿æŒå¯„å­˜å™¨ (Read Holding Registers)
- **FC 04**: è¯»è¾“å…¥å¯„å­˜å™¨ (Read Input Registers)
- **FC 05**: å†™å•ä¸ªçº¿åœˆ (Write Single Coil)
- **FC 06**: å†™å•ä¸ªå¯„å­˜å™¨ (Write Single Register)
- **FC 15**: å†™å¤šä¸ªçº¿åœˆ (Write Multiple Coils)
- **FC 16**: å†™å¤šä¸ªå¯„å­˜å™¨ (Write Multiple Registers)

### æµ‹è¯•åœºæ™¯
1. **è¿æ¥æµ‹è¯•**: éªŒè¯ TCP è¿æ¥å»ºç«‹
2. **è¯»å–æµ‹è¯•**: æµ‹è¯•å„ç§å¯„å­˜å™¨ç±»å‹çš„è¯»å–
3. **å†™å…¥æµ‹è¯•**: æµ‹è¯•å¯„å­˜å™¨å†™å…¥åŠŸèƒ½
4. **é”™è¯¯å¤„ç†**: æµ‹è¯•å¼‚å¸¸å“åº”å¤„ç†
5. **æ€§èƒ½æµ‹è¯•**: æµ‹è¯•é«˜é¢‘è¯·æ±‚å¤„ç†èƒ½åŠ›

## ğŸ“ˆ API æµ‹è¯•ç¤ºä¾‹

### è¯»å–æ•°æ®ç‚¹
```bash
# è¯»å– A ç›¸ç”µå‹
curl http://localhost:8080/points/voltage_a

# é¢„æœŸå“åº”
{
  "name": "voltage_a",
  "value": 228.5,
  "unit": "V",
  "timestamp": "2024-01-20T10:30:00Z",
  "quality": "good"
}
```

### å†™å…¥æ•°æ®ç‚¹
```bash
# è®¾ç½®ç”µå‹è®¾å®šå€¼ä¸º 240.0V
curl -X POST http://localhost:8080/points/voltage_setpoint \
     -H "Content-Type: application/json" \
     -d '{"value": 240.0}'

# é¢„æœŸå“åº”
{
  "success": true,
  "message": "Value written successfully"
}
```

### æŸ¥çœ‹é€šé“çŠ¶æ€
```bash
curl http://localhost:8080/channels

# é¢„æœŸå“åº”
[
  {
    "id": 1,
    "name": "Modbus_Test_Channel_5020",
    "protocol": "ModbusTcp",
    "connected": true,
    "last_update": "2024-01-20T10:30:00Z",
    "status": "active"
  }
]
```

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### 1. æ¨¡æ‹Ÿå™¨å¯åŠ¨å¤±è´¥
```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tlnp | grep 5020

# å¦‚æœç«¯å£è¢«å ç”¨ï¼Œæ€æ­»è¿›ç¨‹æˆ–æ¢ç«¯å£
python modbus_simulator.py --port 5021
```

#### 2. comsrv è¿æ¥å¤±è´¥
- ç¡®ä¿æ¨¡æ‹Ÿå™¨å…ˆå¯åŠ¨
- æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£å·
- æŸ¥çœ‹ comsrv æ—¥å¿—è¾“å‡º

#### 3. Redis è¿æ¥é—®é¢˜
```bash
# æµ‹è¯• Redis è¿æ¥
redis-cli ping

# å¦‚æœå¤±è´¥ï¼Œå¯åŠ¨ Redis å®¹å™¨
docker run -d -p 6379:6379 redis:latest
```

#### 4. API ä¸å¯è®¿é—®
- ç­‰å¾… comsrv å®Œå…¨å¯åŠ¨ (é€šå¸¸éœ€è¦ 5-10 ç§’)
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
- æŸ¥çœ‹ comsrv è¾“å‡ºçš„é”™è¯¯ä¿¡æ¯

### æ—¥å¿—æ–‡ä»¶ä½ç½®
- **comsrv æ—¥å¿—**: `logs/comsrv_modbus_test.log`
- **æµ‹è¯•æŠ¥å‘Š**: `modbus_test_report_*.json`

## ğŸ“‹ æµ‹è¯•æ£€æŸ¥è¡¨

æµ‹è¯•å‰ç¡®è®¤ï¼š
- [ ] Redis å®¹å™¨è¿è¡Œæ­£å¸¸
- [ ] Python 3.8+ å¯ç”¨
- [ ] Rust/Cargo ç¯å¢ƒå°±ç»ª
- [ ] ç«¯å£ 5020, 6379, 8080 å¯ç”¨

æµ‹è¯•æ­¥éª¤ï¼š
- [ ] å¯åŠ¨æ¨¡æ‹Ÿå™¨
- [ ] å¯åŠ¨ comsrv
- [ ] éªŒè¯ API è¿æ¥
- [ ] æµ‹è¯•æ•°æ®è¯»å–
- [ ] æµ‹è¯•æ•°æ®å†™å…¥
- [ ] æ£€æŸ¥ Redis å­˜å‚¨

## ğŸ¯ æ€§èƒ½æŒ‡æ ‡

### é¢„æœŸæ€§èƒ½
- **è¿æ¥æ—¶é—´**: < 5 ç§’
- **å“åº”æ—¶é—´**: < 100ms
- **ååé‡**: > 100 è¯·æ±‚/ç§’
- **å¯ç”¨æ€§**: > 99%

### ç›‘æ§æŒ‡æ ‡
- è¿æ¥çŠ¶æ€
- å“åº”æ—¶é—´
- é”™è¯¯ç‡
- æ•°æ®æ›´æ–°é¢‘ç‡

## ğŸ“š è¿›é˜¶ä½¿ç”¨

### è‡ªå®šä¹‰é…ç½®
ä¿®æ”¹ `test_modbus_5020.yaml` æ–‡ä»¶æ¥ï¼š
- æ·»åŠ æ›´å¤šæ•°æ®ç‚¹
- è°ƒæ•´è½®è¯¢é¢‘ç‡
- é…ç½®æ—¥å¿—çº§åˆ«
- è®¾ç½®è¶…æ—¶å‚æ•°

### æ‰©å±•æµ‹è¯•
åœ¨ `test_modbus_communication.py` ä¸­æ·»åŠ ï¼š
- æ›´å¤šæµ‹è¯•åœºæ™¯
- è‡ªå®šä¹‰éªŒè¯é€»è¾‘
- æ€§èƒ½åŸºå‡†æµ‹è¯•
- å‹åŠ›æµ‹è¯•

## ğŸ”§ å¼€å‘æç¤º

### æ·»åŠ æ–°æ•°æ®ç‚¹
1. åœ¨æ¨¡æ‹Ÿå™¨ä¸­æ·»åŠ å¯„å­˜å™¨æ•°æ®
2. åœ¨é…ç½®æ–‡ä»¶ä¸­å®šä¹‰ç‚¹æ˜ å°„
3. æµ‹è¯•è¯»å†™åŠŸèƒ½

### è°ƒè¯•æŠ€å·§
- ä½¿ç”¨ `--log-level debug` è·å–è¯¦ç»†æ—¥å¿—
- ç›‘æ§ Redis é”®å€¼å˜åŒ–
- ä½¿ç”¨ Wireshark åˆ†æ Modbus æŠ¥æ–‡

---

## ğŸ“ æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ç³»ç»Ÿæ—¥å¿—
2. é”™è¯¯æ¶ˆæ¯
3. ç½‘ç»œè¿æ¥çŠ¶æ€
4. é…ç½®æ–‡ä»¶è¯­æ³•

æµ‹è¯•æˆåŠŸåï¼Œä½ å°±å¯ä»¥ç¡®ä¿¡ VoltageEMS çš„ Modbus é€šä¿¡åŠŸèƒ½å·¥ä½œæ­£å¸¸ï¼ 