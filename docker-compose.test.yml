version: '3.8'

services:
  redis:
    build:
      context: .
      dockerfile: docker/redis/Dockerfile
    container_name: redis-test
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - voltageems-test

  comsrv:
    build:
      context: .
      dockerfile: services/comsrv/Dockerfile
    container_name: comsrv-test
    ports:
      - "6000:6000"
    environment:
      - RUST_LOG=debug,comsrv=trace
      - REDIS_URL=redis://redis:6379
      - CSV_BASE_PATH=/app/config
    volumes:
      - ./services/comsrv/config:/app/config:ro
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - voltageems-test

  modsrv:
    build:
      context: .
      dockerfile: services/modsrv/Dockerfile
    container_name: modsrv-test
    ports:
      - "6001:6001"
    environment:
      - RUST_LOG=debug,modsrv=trace
      - REDIS_URL=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - voltageems-test

  alarmsrv:
    build:
      context: .
      dockerfile: services/alarmsrv/Dockerfile
    container_name: alarmsrv-test
    ports:
      - "6002:6002"
    environment:
      - RUST_LOG=debug,alarmsrv=trace
      - REDIS_URL=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - voltageems-test

  rulesrv:
    build:
      context: .
      dockerfile: services/rulesrv/Dockerfile
    container_name: rulesrv-test
    ports:
      - "6003:6003"
    environment:
      - RUST_LOG=debug,rulesrv=trace
      - REDIS_URL=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - voltageems-test

  hissrv:
    build:
      context: .
      dockerfile: services/hissrv/Dockerfile
    container_name: hissrv-test
    ports:
      - "6004:6004"
    environment:
      - RUST_LOG=debug,hissrv=trace
      - REDIS_URL=redis://redis:6379
    volumes:
      - ./services/hissrv/config:/app/config
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - voltageems-test

  apigateway:
    build:
      context: .
      dockerfile: services/apigateway/Dockerfile
    container_name: apigateway-test
    ports:
      - "6005:6005"
    environment:
      - RUST_LOG=debug,apigateway=trace
      - REDIS_URL=redis://redis:6379
      - APIGATEWAY_REDIS_URL=redis://redis:6379
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - voltageems-test

  # Modbus simulator for testing
  modbus-sim:
    image: oitc/modbus-server
    container_name: modbus-sim
    ports:
      - "5020:5020"
    networks:
      - voltageems-test

volumes:
  redis-data:

networks:
  voltageems-test:
    driver: bridge