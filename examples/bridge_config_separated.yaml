# =====================================================================================
# Communication Service Configuration with Separated Four-Telemetry & Protocol Tables
# =====================================================================================
# 分离式架构:
# - 四遥点表: 工程意义上的点位定义 (four_telemetry.csv)
# - 协议映射表: 通讯协议相关参数 (protocol_mapping.csv)
# =====================================================================================

version: "1.0"

# =====================================================================================
# Service Configuration
# =====================================================================================
service:
  name: "comsrv"
  description: "Communication Service with Separated Table Architecture"
  
  api:
    enabled: true
    bind_address: "127.0.0.1:8080"
    version: "v1"
  
  redis:
    enabled: true
    url: "redis://127.0.0.1:6379/1"
    database: 1
    timeout_ms: 5000
    max_retries: 3
  
  logging:
    level: "info"
    console: true
    max_size: 104857600 # 100MB
    max_files: 5

# =====================================================================================
# Communication Channels with Separated Tables
# =====================================================================================
channels:
  # ==================================================================================
  # Modbus TCP Channel - Tank Farm
  # ==================================================================================
  - id: 1001
    name: "TankFarmModbusTCP"
    description: "油罐区Modbus TCP通信"
    protocol: "modbus_tcp"
    parameters:
      host: "192.168.1.100"
      port: 502
      slave_id: 1
      timeout_ms: 1000
      max_retries: 3
    table_config:
      # 四遥点表路径
      four_telemetry_route: "config/TankFarmModbusTCP"
      four_telemetry_files:
        telemetry_file: "telemetry.csv"      # YC 遥测
        signal_file: "signal.csv"            # YX 遥信
        adjustment_file: "adjustment.csv"    # YT 遥调
        control_file: "control.csv"          # YK 遥控
      
      # 协议映射表路径
      protocol_mapping_route: "config/TankFarmModbusTCP"
      protocol_mapping_files:
        telemetry_mapping: "mapping_telemetry.csv"   # YC协议映射
        signal_mapping: "mapping_signal.csv"         # YX协议映射
        adjustment_mapping: "mapping_adjustment.csv" # YT协议映射
        control_mapping: "mapping_control.csv"       # YK协议映射

  # ==================================================================================
  # Modbus RTU Channel - Pump Station
  # ==================================================================================
  - id: 1002
    name: "PumpStationModbusRTU"
    description: "泵站Modbus RTU通信"
    protocol: "modbus_rtu"
    parameters:
      port: "/dev/ttyUSB0"
      baud_rate: 9600
      data_bits: 8
      parity: "none"
      stop_bits: 1
      slave_id: 2
      timeout_ms: 2000
    table_config:
      four_telemetry_route: "config/PumpStationModbusRTU"
      four_telemetry_files:
        telemetry_file: "telemetry.csv"
        signal_file: "signal.csv"
        adjustment_file: "adjustment.csv"
        control_file: "control.csv"
      
      protocol_mapping_route: "config/PumpStationModbusRTU"
      protocol_mapping_files:
        telemetry_mapping: "mapping_telemetry.csv"
        signal_mapping: "mapping_signal.csv"
        adjustment_mapping: "mapping_adjustment.csv"
        control_mapping: "mapping_control.csv"

  # ==================================================================================
  # CAN Bus Channel - Engine Monitoring
  # ==================================================================================
  - id: 1003
    name: "EngineCANBus"
    description: "发动机CAN总线通信"
    protocol: "can"
    parameters:
      interface: "can0"
      bitrate: 250000
      sample_point: 0.875
    table_config:
      four_telemetry_route: "config/EngineCANBus"
      four_telemetry_files:
        telemetry_file: "telemetry.csv"
        signal_file: "signal.csv"      # 可以是空文件
        adjustment_file: "adjustment.csv"  # 可以是空文件
        control_file: "control.csv"    # 可以是空文件
      
      protocol_mapping_route: "config/EngineCANBus"
      protocol_mapping_files:
        telemetry_mapping: "mapping_telemetry.csv"
        signal_mapping: "mapping_signal.csv"
        adjustment_mapping: "mapping_adjustment.csv"
        control_mapping: "mapping_control.csv"

  # ==================================================================================
  # IEC 60870-5-104 Channel - Substation
  # ==================================================================================
  - id: 4
    name: "Substation IEC104"
    description: "Substation monitoring via IEC 60870-5-104"
    protocol: "iec104"
    parameters:
      host: "192.168.1.200"
      port: 2404
      common_address: 1
      timeout_ms: 10000
    table_config:
      four_telemetry_file: "config/tables/substation_four_telemetry.csv"
      protocol_mapping_file: "config/tables/substation_iec104_mapping.csv"

# =====================================================================================
# Table Configuration
# =====================================================================================
table_config:
  # 表文件根目录
  tables_root: "config/tables"
  
  # 表文件命名规则
  naming_convention:
    four_telemetry_suffix: "_four_telemetry.csv"
    protocol_mapping_suffix: "_mapping.csv"
  
  # 验证规则
  validation:
    require_point_id_match: true    # 要求两表中的point_id必须匹配
    allow_orphaned_telemetry: false # 不允许四遥表中有孤立点位
    allow_orphaned_protocol: false  # 不允许协议表中有孤立点位

# =====================================================================================
# Default Path Configuration  
# =====================================================================================
defaults:
  channels_root: "channels"
  tables_root: "config/tables"
  combase_dir: "combase"
  protocol_dir: "protocol" 