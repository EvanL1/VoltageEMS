#!/usr/bin/env bash

# è·å–æäº¤ä¿¡æ¯
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# å®šä¹‰æœ‰æ•ˆçš„æäº¤ç±»å‹
VALID_TYPES="feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert"

# æ£€æŸ¥æäº¤ä¿¡æ¯æ ¼å¼
if ! echo "$COMMIT_MSG" | grep -qE "^($VALID_TYPES)(\(.+\))?: .{1,100}"; then
    echo -e "${RED}âŒ Invalid commit message format!${NC}"
    echo ""
    echo "Commit message must follow the format:"
    echo "  <type>(<scope>): <subject>"
    echo ""
    echo "Valid types: feat, fix, docs, style, refactor, perf, test, build, ci, chore, revert"
    echo ""
    echo "Examples:"
    echo "  feat(comsrv): add modbus RTU support"
    echo "  fix(apigateway): resolve memory leak in websocket handler"
    echo "  docs: update installation guide"
    echo ""
    echo "Your commit message:"
    echo "$COMMIT_MSG"
    exit 1
fi

# æ£€æŸ¥æäº¤ä¿¡æ¯é•¿åº¦
FIRST_LINE=$(echo "$COMMIT_MSG" | head -n 1)
if [ ${#FIRST_LINE} -gt 100 ]; then
    echo -e "${YELLOW}âš ï¸  Warning: First line of commit message is too long (${#FIRST_LINE} > 100 characters)${NC}"
fi

# æ£€æŸ¥æ˜¯å¦åŒ…å« issue å¼•ç”¨ï¼ˆå¯é€‰ï¼‰
if ! echo "$COMMIT_MSG" | grep -qE "(#[0-9]+|[A-Z]+-[0-9]+)"; then
    echo -e "${YELLOW}ğŸ’¡ Tip: Consider referencing an issue (e.g., #123 or JIRA-456)${NC}"
fi

echo -e "${GREEN}âœ… Commit message format is valid${NC}"