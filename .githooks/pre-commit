#!/usr/bin/env bash
set -e

echo "ğŸ¦€ Running pre-commit checks..."

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# æ£€æŸ¥æ˜¯å¦æœ‰ Rust æ–‡ä»¶å˜æ›´
if ! git diff --cached --name-only | grep -q '\.rs$'; then
    echo "No Rust files changed, skipping Rust checks"
    exit 0
fi

echo "ğŸ“‹ Running Rust formatting check..."
if ! cargo fmt --all -- --check; then
    echo -e "${RED}âŒ Rust formatting check failed!${NC}"
    echo "Run 'cargo fmt --all' to fix formatting issues"
    exit 1
fi

echo "ğŸ” Running clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings 2>/dev/null; then
    echo -e "${RED}âŒ Clippy check failed!${NC}"
    echo "Running clippy again to show errors:"
    cargo clippy --all-targets --all-features -- -D warnings
    exit 1
fi

# æµ‹è¯•åº”è¯¥åœ¨ CI ä¸­è¿è¡Œï¼Œä¸åœ¨ pre-commit ä¸­è¿è¡Œ
# echo "ğŸ§ª Running tests..."
# if ! cargo test --workspace --quiet; then
#     echo -e "${RED}âŒ Tests failed!${NC}"
#     exit 1
# fi

echo "ğŸ” Checking for common issues..."

# æ£€æŸ¥ println! ä½¿ç”¨ï¼ˆç”Ÿäº§ä»£ç åº”ä½¿ç”¨æ—¥å¿—ï¼‰- ä»…è­¦å‘Šï¼Œä¸é˜»æ­¢æäº¤
PRINTLN_FILES=$(git diff --cached --name-only | grep '\.rs$' | xargs grep -l "println!" 2>/dev/null | grep -v "src/bin/" | grep -v "examples/" | grep -v "tests/" || true)
if [ -n "$PRINTLN_FILES" ]; then
    echo -e "${YELLOW}âš ï¸  Info: Found println! in the following files (consider using tracing/log):${NC}"
    echo "$PRINTLN_FILES" | head -5
    if [ $(echo "$PRINTLN_FILES" | wc -l) -gt 5 ]; then
        echo "... and $(($(echo "$PRINTLN_FILES" | wc -l) - 5)) more files"
    fi
fi

# æ£€æŸ¥ unwrap() ä½¿ç”¨ - æé«˜é˜ˆå€¼ï¼Œæ›´åˆç†
UNWRAP_COUNT=$(git diff --cached --name-only | grep '\.rs$' | xargs grep -n "\.unwrap()" 2>/dev/null | grep -v "tests/" | grep -v "test_" | grep -v "examples/" | wc -l || true)
if [ "$UNWRAP_COUNT" -gt 20 ]; then
    echo -e "${YELLOW}âš ï¸  Info: Many unwrap() calls detected ($UNWRAP_COUNT). Consider using ? or proper error handling where appropriate.${NC}"
fi

# æ£€æŸ¥ TODO æ³¨é‡Š - ä»…æ˜¾ç¤ºæ–°å¢çš„
NEW_TODOS=$(git diff --cached -U0 | grep '^+' | grep -E 'TODO|FIXME|HACK|XXX' | wc -l || true)
if [ "$NEW_TODOS" -gt 0 ]; then
    echo -e "${YELLOW}â„¹ï¸  Info: Found $NEW_TODOS new TODO/FIXME comments in this commit${NC}"
fi

# æ£€æŸ¥å¤§æ–‡ä»¶
LARGE_FILES=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ]; then wc -l "{}" | awk "\$1 > 1000 {print \$2}"; fi' 2>/dev/null || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}âš ï¸  Warning: Large files detected (>1000 lines):${NC}"
    echo "$LARGE_FILES"
fi

# æ£€æŸ¥ Cargo.lock æ˜¯å¦è¢«æäº¤ï¼ˆåº“é¡¹ç›®ä¸åº”æäº¤ï¼‰
if git diff --cached --name-only | grep -q "Cargo.lock" && [ -f "Cargo.toml" ]; then
    if grep -q '\[lib\]' Cargo.toml; then
        echo -e "${YELLOW}âš ï¸  Warning: Cargo.lock should not be committed for library projects${NC}"
    fi
fi

echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"