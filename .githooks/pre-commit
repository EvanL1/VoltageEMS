#!/usr/bin/env bash
set -e

echo "ğŸ¦€ Running pre-commit checks..."

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# æ£€æŸ¥æ˜¯å¦æœ‰ Rust æ–‡ä»¶å˜æ›´
if ! git diff --cached --name-only | grep -q '\.rs$'; then
    echo "No Rust files changed, skipping Rust checks"
    exit 0
fi

echo "ğŸ“‹ Running Rust formatting check..."
if ! cargo fmt --all -- --check; then
    echo -e "${RED}âŒ Rust formatting check failed!${NC}"
    echo "Run 'cargo fmt --all' to fix formatting issues"
    exit 1
fi

echo "ğŸ” Running clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings; then
    echo -e "${RED}âŒ Clippy check failed!${NC}"
    exit 1
fi

echo "ğŸ§ª Running tests..."
if ! cargo test --workspace --quiet; then
    echo -e "${RED}âŒ Tests failed!${NC}"
    exit 1
fi

echo "ğŸ” Checking for common issues..."

# æ£€æŸ¥ println! ä½¿ç”¨ï¼ˆç”Ÿäº§ä»£ç åº”ä½¿ç”¨æ—¥å¿—ï¼‰
PRINTLN_COUNT=$(git diff --cached --name-only | grep '\.rs$' | xargs grep -l "println!" 2>/dev/null | grep -v "src/bin/" | grep -v "examples/" | wc -l || true)
if [ "$PRINTLN_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  Warning: Found println! in production code (use tracing/log instead)${NC}"
    git diff --cached --name-only | grep '\.rs$' | xargs grep -n "println!" 2>/dev/null | grep -v "src/bin/" | grep -v "examples/" || true
fi

# æ£€æŸ¥ unwrap() ä½¿ç”¨
UNWRAP_COUNT=$(git diff --cached --name-only | grep '\.rs$' | xargs grep -n "\.unwrap()" 2>/dev/null | grep -v "tests/" | grep -v "test_" | wc -l || true)
if [ "$UNWRAP_COUNT" -gt 5 ]; then
    echo -e "${YELLOW}âš ï¸  Warning: High usage of unwrap() detected (consider proper error handling)${NC}"
fi

# æ£€æŸ¥ TODO æ³¨é‡Š
TODO_COUNT=$(git diff --cached --name-only | grep '\.rs$' | xargs grep -n "TODO\|FIXME\|HACK\|XXX" 2>/dev/null | wc -l || true)
if [ "$TODO_COUNT" -gt 0 ]; then
    echo -e "${YELLOW}âš ï¸  Found TODO/FIXME comments:${NC}"
    git diff --cached --name-only | grep '\.rs$' | xargs grep -n "TODO\|FIXME\|HACK\|XXX" 2>/dev/null || true
fi

# æ£€æŸ¥å¤§æ–‡ä»¶
LARGE_FILES=$(git diff --cached --name-only | xargs -I {} sh -c 'if [ -f "{}" ]; then wc -l "{}" | awk "\$1 > 1000 {print \$2}"; fi' 2>/dev/null || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}âš ï¸  Warning: Large files detected (>1000 lines):${NC}"
    echo "$LARGE_FILES"
fi

# æ£€æŸ¥ Cargo.lock æ˜¯å¦è¢«æäº¤ï¼ˆåº“é¡¹ç›®ä¸åº”æäº¤ï¼‰
if git diff --cached --name-only | grep -q "Cargo.lock" && [ -f "Cargo.toml" ]; then
    if grep -q '\[lib\]' Cargo.toml; then
        echo -e "${YELLOW}âš ï¸  Warning: Cargo.lock should not be committed for library projects${NC}"
    fi
fi

echo -e "${GREEN}âœ… All pre-commit checks passed!${NC}"