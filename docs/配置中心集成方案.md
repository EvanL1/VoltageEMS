# VoltageEMS 配置中心集成方案

## 概述

VoltageEMS 采用纯微服务架构的配置管理方案，通过独立的配置中心服务为所有微服务提供统一的配置管理能力。

## 架构设计

### 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     配置中心服务 (端口 8000)                      │
│  ┌─────────────┐  ┌──────────────┐  ┌────────────────────────┐ │
│  │  REST API   │  │ 配置管理逻辑  │  │   SQLite 存储         │ │
│  │  ├─ GET     │  │  ├─ 版本管理  │  │  ├─ configs 表       │ │
│  │  ├─ PUT     │  │  ├─ 验证器    │  │  ├─ config_history表 │ │
│  │  └─ POST    │  │  └─ 通知机制  │  │  └─ point_tables表   │ │
│  └─────────────┘  └──────────────┘  └────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                                │
                                │ HTTP/REST
                                │
    ┌───────────────────────────┴───────────────────────────────┐
    │                                                           │
┌───┴────────┐  ┌──────────────┐  ┌──────────────┐  ┌─────────┴──────┐
│ API Gateway│  │    ComSrv    │  │    ModSrv    │  │   其他服务...  │
│  (8080)    │  │    (8001)    │  │    (8002)    │  │                │
└────────────┘  └──────────────┘  └──────────────┘  └────────────────┘
```

### 配置数据流

1. **配置获取流程**
   ```
   服务启动 → 连接配置中心 → 拉取配置 → 应用配置 → 启动监听
   ```

2. **配置更新流程**
   ```
   定时轮询 → 版本检查 → 发现更新 → 拉取新配置 → 热更新应用
   ```

3. **配置变更通知**
   ```
   配置修改 → 版本递增 → Webhook通知 → 服务更新配置
   ```

## 配置中心服务设计

### 核心功能

1. **配置存储管理**
   - 基于 SQLite 的持久化存储
   - 支持键值对和结构化配置
   - 配置版本自动管理

2. **多格式支持**
   - YAML（推荐）
   - JSON
   - TOML
   - 环境变量

3. **版本控制**
   - 每次修改自动递增版本号
   - 完整的变更历史记录
   - 支持回滚到任意版本

4. **配置验证**
   - 类型验证
   - 业务规则验证
   - 依赖关系检查

### REST API 设计

#### 基础端点

| 方法 | 路径 | 功能 | 说明 |
|------|------|------|------|
| GET | `/api/v1/config/{service}` | 获取服务配置 | 返回完整配置和版本信息 |
| GET | `/api/v1/config/{service}/version` | 检查配置版本 | 仅返回版本号和更新时间 |
| PUT | `/api/v1/config/{service}/update` | 更新配置项 | 支持单个或批量更新 |
| GET | `/api/v1/config/{service}/history` | 查看变更历史 | 支持分页和时间筛选 |
| POST | `/api/v1/config/{service}/rollback` | 回滚配置 | 回滚到指定版本 |

#### 高级功能

| 方法 | 路径 | 功能 | 说明 |
|------|------|------|------|
| GET | `/api/v1/config/{service}/export` | 导出配置 | 支持多种格式导出 |
| POST | `/api/v1/config/{service}/import` | 导入配置 | 支持合并或覆盖模式 |
| POST | `/api/v1/config/{service}/validate` | 验证配置 | 不应用，仅验证 |
| POST | `/api/v1/config/subscribe` | 订阅变更通知 | Webhook 订阅管理 |

### 数据库设计

```sql
-- 主配置表
CREATE TABLE configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    service VARCHAR(50) NOT NULL,
    key VARCHAR(255) NOT NULL,
    value TEXT NOT NULL,
    value_type VARCHAR(20) NOT NULL,
    version INTEGER NOT NULL DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(service, key)
);

-- 配置历史表
CREATE TABLE config_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    service VARCHAR(50) NOT NULL,
    key VARCHAR(255) NOT NULL,
    version INTEGER NOT NULL,
    operation VARCHAR(20) NOT NULL,
    old_value TEXT,
    new_value TEXT,
    reason TEXT,
    user VARCHAR(50),
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 配置订阅表
CREATE TABLE config_subscriptions (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    subscription_id VARCHAR(50) UNIQUE NOT NULL,
    service VARCHAR(50) NOT NULL,
    callback_url TEXT NOT NULL,
    events TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_notified TIMESTAMP
);
```

## 客户端集成方案

### API Gateway 集成示例

#### 1. 配置客户端实现

```rust
pub struct ConfigClient {
    config_service_url: String,
    service_name: String,
    cached_config: Arc<RwLock<Option<Config>>>,
    current_version: Arc<RwLock<u64>>,
    http_client: reqwest::Client,
}

impl ConfigClient {
    // 获取配置
    pub async fn fetch_config(&self) -> Result<Config, Error> {
        let url = format!("{}/api/v1/config/{}", 
            self.config_service_url, 
            self.service_name
        );
        
        let response = self.http_client
            .get(&url)
            .header("X-Service-Name", &self.service_name)
            .send()
            .await?;
            
        // 解析响应，验证校验和，更新缓存
        // ...
    }
    
    // 自动更新循环
    pub async fn start_watch_loop(&self, interval: Duration) {
        tokio::spawn(async move {
            loop {
                tokio::time::sleep(interval).await;
                if let Ok(true) = self.check_for_updates().await {
                    let _ = self.fetch_config().await;
                }
            }
        });
    }
}
```

#### 2. 服务启动集成

```rust
#[actix_web::main]
async fn main() -> std::io::Result<()> {
    // 初始化配置客户端
    let config_client = Arc::new(ConfigClient::new(
        env::var("CONFIG_SERVICE_URL").unwrap_or("http://localhost:8000".into()),
        "apigateway".into()
    ));
    
    // 获取初始配置（带回退机制）
    let config = match config_client.fetch_config().await {
        Ok(cfg) => Arc::new(cfg),
        Err(e) => {
            warn!("Failed to fetch config: {}, using local", e);
            Arc::new(Config::load()?)
        }
    };
    
    // 启动配置监听
    config_client.start_watch_loop(Duration::from_secs(30)).await;
    
    // 启动服务...
}
```

### 其他服务集成指南

#### 1. 环境变量配置

```bash
# 必需的环境变量
export CONFIG_SERVICE_URL=http://localhost:8000
export SERVICE_NAME=comsrv

# 可选的环境变量
export CONFIG_UPDATE_INTERVAL=30  # 更新检查间隔（秒）
export CONFIG_TIMEOUT=10          # 请求超时时间（秒）
export CONFIG_RETRY_COUNT=3       # 失败重试次数
```

#### 2. 启动脚本模板

```bash
#!/bin/bash

SERVICE_NAME="your-service"
CONFIG_SERVICE_URL=${CONFIG_SERVICE_URL:-"http://localhost:8000"}

# 检查配置服务可用性
if curl -f -s "$CONFIG_SERVICE_URL/health" > /dev/null; then
    echo "✓ Config service is available"
else
    echo "⚠ Config service unavailable, using local config"
fi

# 启动服务
exec ./target/release/$SERVICE_NAME
```

#### 3. 配置结构示例

```yaml
# API Gateway 配置示例
server:
  host: "0.0.0.0"
  port: 8080
  workers: 4

redis:
  url: "redis://localhost:6379"
  pool_size: 10
  timeout_seconds: 5

services:
  comsrv:
    url: "http://localhost:8001"
    timeout_seconds: 30
  modsrv:
    url: "http://localhost:8002"
    timeout_seconds: 30
  # ... 其他服务

cors:
  allowed_origins:
    - "http://localhost:8082"
  allowed_methods:
    - "GET"
    - "POST"
    - "PUT"
    - "DELETE"
  allowed_headers:
    - "Content-Type"
    - "Authorization"
  max_age: 3600

logging:
  level: "info"
  format: "json"
```

## 部署指南

### 1. 配置中心服务部署

```bash
# 构建配置中心服务
cd services/config-service
cargo build --release

# 运行配置中心
CONFIG_DB_PATH=./config.db \
CONFIG_PORT=8000 \
./target/release/config-service
```

### 2. 微服务启动顺序

1. **启动基础设施**
   - Redis
   - InfluxDB
   - 配置中心服务

2. **启动核心服务**
   - API Gateway（依赖配置中心）
   - ComSrv
   - ModSrv
   - HisSrv
   - NetSrv
   - AlarmSrv

3. **启动前端**
   - Frontend
   - Grafana

### 3. Docker Compose 集成

```yaml
version: '3.8'

services:
  config-service:
    image: voltageems/config-service:latest
    ports:
      - "8000:8000"
    environment:
      - CONFIG_DB_PATH=/data/config.db
    volumes:
      - config-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  apigateway:
    image: voltageems/apigateway:latest
    ports:
      - "8080:8080"
    environment:
      - CONFIG_SERVICE_URL=http://config-service:8000
      - SERVICE_NAME=apigateway
    depends_on:
      config-service:
        condition: service_healthy
    
  # ... 其他服务

volumes:
  config-data:
```

## 最佳实践

### 1. 配置管理原则

- **分层配置**：基础配置 + 环境特定配置
- **最小权限**：服务只能访问自己的配置
- **版本控制**：所有变更必须有原因说明
- **验证优先**：修改前必须通过验证

### 2. 错误处理策略

- **优雅降级**：配置中心不可用时使用本地配置
- **重试机制**：临时失败自动重试
- **缓存策略**：本地缓存最近的有效配置
- **告警机制**：配置获取失败触发告警

### 3. 安全考虑

- **传输加密**：使用 HTTPS 保护配置传输
- **访问控制**：基于服务名的访问控制
- **敏感信息**：密码等敏感信息加密存储
- **审计日志**：记录所有配置变更操作

### 4. 性能优化

- **批量更新**：减少配置更新请求次数
- **增量更新**：只传输变更的配置项
- **压缩传输**：大配置使用 gzip 压缩
- **连接池**：复用 HTTP 连接

## 监控和运维

### 1. 健康检查

```bash
# 配置中心健康检查
curl http://localhost:8000/health

# 服务配置状态检查
curl http://localhost:8080/api/v1/config/status
```

### 2. 关键指标

- 配置获取延迟
- 配置更新频率
- 版本落后数量
- 错误率和失败次数

### 3. 告警规则

- 配置中心不可用超过 5 分钟
- 服务配置版本落后超过 3 个版本
- 配置获取失败率超过 10%
- 配置验证失败

## 故障排查

### 常见问题

1. **配置获取失败**
   - 检查网络连接
   - 验证服务名是否正确
   - 查看配置中心日志

2. **配置不生效**
   - 确认版本号是否更新
   - 检查配置格式是否正确
   - 查看服务日志中的错误信息

3. **性能问题**
   - 调整更新检查间隔
   - 启用配置压缩
   - 优化配置结构

### 调试工具

```bash
# 查看服务当前配置版本
curl http://localhost:8080/api/v1/debug/config-version

# 强制刷新配置
curl -X POST http://localhost:8080/api/v1/admin/refresh-config

# 查看配置差异
curl http://localhost:8000/api/v1/config/apigateway/diff?from=10&to=12
```

## 迁移指南

### 从本地配置迁移

1. **导出现有配置**
   ```bash
   # 将 YAML 配置转换为配置中心格式
   ./config-migrate export --input apigateway.yaml --service apigateway
   ```

2. **导入到配置中心**
   ```bash
   # 导入配置
   ./config-migrate import --file apigateway.json --service apigateway
   ```

3. **验证配置**
   ```bash
   # 对比配置
   ./config-migrate verify --service apigateway
   ```

4. **切换到配置中心**
   ```bash
   # 更新启动脚本
   export CONFIG_SERVICE_URL=http://localhost:8000
   ./start-with-config-service.sh
   ```

## 总结

配置中心服务为 VoltageEMS 提供了统一、可靠、灵活的配置管理能力，支持微服务架构下的配置动态更新、版本管理和集中管控。通过标准的 REST API 和客户端库，各服务可以轻松集成配置中心，实现配置的统一管理和动态更新。