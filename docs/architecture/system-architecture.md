# VoltageEMS 系统架构

## 概述

VoltageEMS 是一个基于 Rust 构建的分布式能源管理系统，采用微服务架构设计，通过 Redis 作为中央消息总线实现服务间的松耦合通信。系统专注于工业物联网场景下的实时数据采集、处理和控制。

## 架构原则

1. **服务自治**：每个服务独立部署、独立扩展
2. **数据去中心化**：通过 Redis Pub/Sub 实现事件驱动架构
3. **高性能优先**：采用 Rust 语言，优化内存使用和并发处理
4. **容错设计**：服务故障隔离，支持优雅降级

## 系统架构图

```
┌───────────────────────────────────────────────────────────────────────┐
│                           前端应用层                                    │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │   Web UI    │  │  Mobile App │  │   HMI/SCADA │  │  Third Party│   │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘   │
└─────────┼─────────────────┼─────────────────┼─────────────────┼────────┘
          │                 │                 │                 │
          └─────────────────┴─────────────────┴─────────────────┘
                                    │
                         ┌──────────┴──────────┐
                         │    API Gateway      │
                         │   (RESTful/WS)      │
                         └──────────┬──────────┘
                                    │
     ┌──────────────────────────────┼──────────────────────────────┐
     │                         Redis 消息总线                        │
     │  ┌────────────────────────────────────────────────────────┐ │
     │  │  Pub/Sub Channels  │  Key-Value Storage  │  Streams   │ │
     │  └────────────────────────────────────────────────────────┘ │
     └─────┬───────────┬───────────┬───────────┬───────────┬──────┘
           │           │           │           │           │
    ┌──────┴──────┐ ┌──┴──┐ ┌──┴───┐ ┌─────┴─────┐ ┌──┴──┐ ┌──────┴──────┐
    │   comsrv    │ │modsrv│ │rulesrv│ │  hissrv   │ │netsrv│ │  alarmsrv   │
    │ (通信服务)   │ │(模型) │ │(规则) │ │ (历史存储)  │ │(云端)│ │  (告警服务)  │
    └──────┬──────┘ └─────┘ └──────┘ └───────────┘ └─────┘ └─────────────┘
           │
    ┌──────┴───────────────────────────────────────┐
    │              工业设备层                        │
    │  ┌─────────┐ ┌─────────┐ ┌─────────┐       │
    │  │ Modbus  │ │IEC60870 │ │   CAN   │  ...  │
    │  └─────────┘ └─────────┘ └─────────┘       │
    └─────────────────────────────────────────────┘
```

## 核心服务说明

### 1. comsrv - 通信服务
- **职责**：工业协议数据采集与设备控制
- **特性**：
  - 插件化协议支持（Modbus、IEC60870、CAN 等）
  - 统一传输层抽象（TCP、Serial、CAN、GPIO）
  - 实时数据发布到 Redis
  - 订阅控制命令并执行

### 2. modsrv - 模型服务
- **职责**：物模型管理与实时计算
- **特性**：
  - 设备物模型定义
  - 实例管理系统
  - DAG 计算引擎
  - 高性能缓存

### 3. rulesrv - 规则服务
- **职责**：规则引擎与自动化控制
- **特性**：
  - 条件规则配置
  - 表达式引擎
  - 动作执行器
  - 调度管理

### 4. hissrv - 历史数据服务
- **职责**：时序数据存储与查询
- **特性**：
  - Redis 到 InfluxDB 桥接
  - 批量写入优化
  - 数据压缩与归档
  - 灵活的查询 API

### 5. netsrv - 网络转发服务
- **职责**：云端数据同步
- **特性**：
  - 多云平台支持（AWS IoT、阿里云等）
  - 协议转换（MQTT、HTTP）
  - 断线重连与缓存
  - 数据过滤与聚合

### 6. alarmsrv - 告警服务
- **职责**：实时告警检测与管理
- **特性**：
  - 多级告警规则
  - 告警抑制与聚合
  - 通知渠道管理
  - 告警历史追踪

### 7. apigateway - API 网关
- **职责**：统一的外部访问入口
- **特性**：
  - RESTful API
  - WebSocket 实时推送
  - JWT 认证授权
  - 请求路由与负载均衡

## 数据流设计

### 实时数据流
```
设备 → comsrv → Redis → modsrv → Redis → apigateway → 前端
                  ↓        ↓         ↓
                hissrv  alarmsrv  netsrv
```

### 控制命令流
```
前端 → apigateway → Redis → comsrv → 设备
                      ↓
                   modsrv (验证/计算)
```

## 技术栈

- **编程语言**：Rust (性能关键服务)、Go (API 网关)
- **消息中间件**：Redis 7.0+
- **时序数据库**：InfluxDB 2.0
- **容器化**：Docker、Kubernetes
- **监控**：Prometheus + Grafana
- **日志**：ELK Stack

## 部署架构

### 开发环境
- Docker Compose 一键部署
- 本地 Redis 实例
- 模拟器支持

### 生产环境
- Kubernetes 集群部署
- Redis Cluster 高可用
- 服务网格（可选）
- 自动扩缩容

## 性能指标

- **数据采集延迟**：< 100ms
- **单点写入性能**：10,000+ points/s
- **计算延迟**：< 50ms (P99)
- **API 响应时间**：< 200ms (P95)

## 安全架构

- **网络隔离**：工业网络与业务网络分离
- **认证授权**：JWT + RBAC
- **数据加密**：TLS 传输加密
- **审计日志**：完整的操作追踪

## 扩展性设计

1. **水平扩展**：所有服务支持多实例部署
2. **协议扩展**：插件化协议开发框架
3. **存储扩展**：支持多种时序数据库
4. **功能扩展**：微服务架构便于新增服务

## 故障处理

1. **服务降级**：核心服务故障不影响数据采集
2. **数据缓存**：网络中断时本地缓存
3. **自动重试**：指数退避重试策略
4. **健康检查**：主动服务健康监控

## 未来规划

1. **边缘计算**：支持边缘节点部署
2. **AI 集成**：智能告警与预测维护
3. **多租户**：SaaS 化部署支持
4. **标准协议**：OPC UA 支持
