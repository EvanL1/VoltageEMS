name: Comsrv CI/CD

on:
  push:
    branches: [ main, develop, feature/comsrv ]
    paths:
      - 'services/comsrv/**'
      - 'scripts/**'
      - '.github/workflows/comsrv-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'services/comsrv/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SERVICE_NAME: comsrv

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
        components: rustfmt, clippy
    
    - name: Cache cargo registry
      uses: actions/cache@v3
      with:
        path: ~/.cargo/registry
        key: ${{ runner.os }}-cargo-registry-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache cargo index
      uses: actions/cache@v3
      with:
        path: ~/.cargo/git
        key: ${{ runner.os }}-cargo-index-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Cache target
      uses: actions/cache@v3
      with:
        path: services/comsrv/target
        key: ${{ runner.os }}-cargo-target-${{ hashFiles('**/Cargo.lock') }}
    
    - name: Check formatting
      working-directory: services/comsrv
      run: cargo fmt -- --check
    
    - name: Run clippy
      working-directory: services/comsrv
      run: cargo clippy -- -D warnings
    
    - name: Run tests
      working-directory: services/comsrv
      run: cargo test --all-features
    
    - name: Build
      working-directory: services/comsrv
      run: cargo build --release

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: |
          localhost:5000/voltageems/comsrv
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: services/comsrv
        push: false
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Save Docker image
      run: |
        docker save localhost:5000/voltageems/comsrv:${{ github.sha }} -o comsrv-image.tar
    
    - name: Upload Docker image
      uses: actions/upload-artifact@v3
      with:
        name: comsrv-docker-image
        path: comsrv-image.tar
        retention-days: 1

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push'
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download Docker image
      uses: actions/download-artifact@v3
      with:
        name: comsrv-docker-image
    
    - name: Load Docker image
      run: docker load -i comsrv-image.tar
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      working-directory: services/comsrv
      run: |
        pip install -r requirements.txt
    
    - name: Start test servers
      working-directory: services/comsrv
      run: ./scripts/start-test-servers.sh
    
    - name: Run integration tests
      working-directory: services/comsrv
      run: ./scripts/run-integration-test.sh
      env:
        REDIS_URL: redis://localhost:6379
    
    - name: Stop test servers
      if: always()
      working-directory: services/comsrv
      run: ./scripts/stop-test-servers.sh
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-results
        path: |
          services/comsrv/tests/logs/
          services/comsrv/integration-test-report.txt