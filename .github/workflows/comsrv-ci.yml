name: Comsrv CI/CD

on:
  push:
    branches: [ main, develop, feature/comsrv ]
    paths:
      - 'services/comsrv/**'
      - 'scripts/**'
      - '.github/workflows/comsrv-ci.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'services/comsrv/**'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  SERVICE_NAME: comsrv

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
        components: rustfmt, clippy
    
    # ä½¿ç”¨æ›´é«˜æ•ˆçš„ç¼“å­˜æ–¹æ¡ˆ
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: services/comsrv
        cache-on-failure: true
    
    - name: Check formatting
      working-directory: services/comsrv
      run: cargo fmt -- --check
    
    # Clippy æ£€æŸ¥ - åªå¯¹ä¸¥é‡é—®é¢˜æŠ¥é”™
    - name: Run clippy (critical checks)
      working-directory: services/comsrv
      run: |
        cargo clippy --all-targets --all-features -- \
          -D clippy::correctness \
          -D clippy::suspicious \
          -D deprecated
    
    # Clippy å®Œæ•´æ£€æŸ¥ - ä»…ä¾›å‚è€ƒï¼Œä¸é˜»å¡ CI
    - name: Run clippy (full check - informational)
      working-directory: services/comsrv
      continue-on-error: true
      run: |
        echo "Running full clippy check (informational only)..."
        cargo clippy --all-targets --all-features 2>&1 | tee clippy-full-report.txt || true
        echo "Clippy check completed. See clippy-full-report.txt for details."
    
    # ä¸Šä¼  clippy æŠ¥å‘Š
    - name: Upload clippy report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: clippy-report
        path: services/comsrv/clippy-full-report.txt
    
    - name: Run tests
      working-directory: services/comsrv
      run: cargo test --all-features
    
    - name: Build
      working-directory: services/comsrv
      run: cargo build --release

  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v4
      with:
        images: |
          localhost:5000/voltageems/comsrv
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build Docker image
      uses: docker/build-push-action@v4
      with:
        context: services/comsrv
        push: false
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Save Docker image
      run: |
        docker save localhost:5000/voltageems/comsrv:${{ github.sha }} -o comsrv-image.tar
    
    - name: Upload Docker image
      uses: actions/upload-artifact@v3
      with:
        name: comsrv-docker-image
        path: comsrv-image.tar
        retention-days: 1

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push'
    services:
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Download Docker image
      uses: actions/download-artifact@v3
      with:
        name: comsrv-docker-image
    
    - name: Load Docker image
      run: docker load -i comsrv-image.tar
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
    
    - name: Install Python dependencies
      working-directory: services/comsrv
      run: |
        pip install -r requirements.txt
    
    - name: Start test servers
      working-directory: services/comsrv
      run: ./scripts/start-test-servers.sh
    
    - name: Run integration tests
      working-directory: services/comsrv
      run: ./scripts/run-integration-test.sh
      env:
        REDIS_URL: redis://localhost:6379
    
    - name: Stop test servers
      if: always()
      working-directory: services/comsrv
      run: ./scripts/stop-test-servers.sh
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: integration-test-results
        path: |
          services/comsrv/tests/logs/
          services/comsrv/integration-test-report.txt

  # ä»£ç è´¨é‡æ£€æŸ¥ - éé˜»å¡ï¼Œä»…ä¾›å‚è€ƒ
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    continue-on-error: true  # ä¸é˜»å¡æ•´ä¸ªå·¥ä½œæµ
    steps:
    - uses: actions/checkout@v3
    
    - name: Install Rust
      uses: actions-rs/toolchain@v1
      with:
        profile: minimal
        toolchain: stable
        override: true
        components: clippy
    
    - name: Cache dependencies
      uses: Swatinem/rust-cache@v2
      with:
        workspaces: services/comsrv
    
    # å®Œæ•´çš„ clippy æ£€æŸ¥ï¼ŒåŒ…å«æ‰€æœ‰å»ºè®®
    - name: Full clippy analysis
      working-directory: services/comsrv
      run: |
        echo "=== Running comprehensive clippy analysis ===" | tee code-quality-report.txt
        echo "" | tee -a code-quality-report.txt
        cargo clippy --all-targets --all-features -- \
          -W clippy::all \
          -W clippy::pedantic \
          -W clippy::nursery \
          -A clippy::module_inception \
          -A clippy::too_many_arguments \
          -A clippy::type_complexity \
          2>&1 | tee -a code-quality-report.txt || true
    
    # æ£€æŸ¥æœªä½¿ç”¨çš„ä¾èµ–
    - name: Check unused dependencies
      working-directory: services/comsrv
      run: |
        echo "" | tee -a code-quality-report.txt
        echo "=== Checking for unused dependencies ===" | tee -a code-quality-report.txt
        cargo install cargo-udeps --locked || true
        cargo +nightly udeps 2>&1 | tee -a code-quality-report.txt || true
    
    # å®‰å…¨å®¡è®¡
    - name: Security audit
      working-directory: services/comsrv
      run: |
        echo "" | tee -a code-quality-report.txt
        echo "=== Security audit ===" | tee -a code-quality-report.txt
        cargo install cargo-audit --locked || true
        cargo audit 2>&1 | tee -a code-quality-report.txt || true
    
    # ä»£ç ç»Ÿè®¡
    - name: Code statistics
      working-directory: services/comsrv
      run: |
        echo "" | tee -a code-quality-report.txt
        echo "=== Code statistics ===" | tee -a code-quality-report.txt
        cargo install tokei --locked || true
        tokei . 2>&1 | tee -a code-quality-report.txt || true
    
    # ä¸Šä¼ è´¨é‡æŠ¥å‘Š
    - name: Upload quality report
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: code-quality-report
        path: services/comsrv/code-quality-report.txt
    
    # åœ¨ PR ä¸­æ·»åŠ è¯„è®ºï¼ˆå¯é€‰ï¼‰
    - name: Comment PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      continue-on-error: true
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('services/comsrv/code-quality-report.txt', 'utf8');
          const comment = `## ğŸ“Š Code Quality Report\n\n<details>\n<summary>Click to expand</summary>\n\n\`\`\`\n${report}\n\`\`\`\n</details>`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });