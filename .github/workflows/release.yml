name: Release Multi-Arch Installer

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
      - 'v[0-9]+.[0-9]+.[0-9]+-*'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # ============================================================================
  # Job 1: Pre-Release Quality Check
  # ============================================================================
  pre-check:
    name: Pre-Release Check
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "23.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Quick Quality Check
        run: |
          cargo fmt --all -- --check
          cargo clippy --workspace -- -D warnings

  # ============================================================================
  # Job 2: Build Multi-Arch Installers (Parallel Matrix)
  # ============================================================================
  build:
    name: Build ${{ matrix.arch }} Installer
    runs-on: ubuntu-latest
    needs: pre-check
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: arm64
            target: aarch64-unknown-linux-musl
            docker_platform: linux/arm64
          - arch: amd64
            target: x86_64-unknown-linux-musl
            docker_platform: linux/amd64

    steps:
      - uses: actions/checkout@v4
        with:
          submodules: true
          fetch-depth: 0

      - name: Free Disk Space
        run: |
          echo "=== Before cleanup ==="
          df -h /
          sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo rm -rf /usr/local/lib/android /usr/share/swift /opt/hostedtoolcache/CodeQL
          sudo apt-get clean
          docker system prune -af --volumes || true
          echo "=== After cleanup ==="
          df -h /

      - name: Extract Version
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "artifact_name=MonarchEdge-${{ matrix.arch }}-${VERSION}.run" >> $GITHUB_OUTPUT
          echo "Building version $VERSION for ${{ matrix.arch }}"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Cache Cargo Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ matrix.arch }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ matrix.arch }}-
            ${{ runner.os }}-cargo-

      - name: Install Cross-Compilation Tools
        run: |
          ZIG_VERSION="0.13.0"
          echo "Installing Zig ${ZIG_VERSION}..."
          wget -q "https://ziglang.org/download/${ZIG_VERSION}/zig-linux-x86_64-${ZIG_VERSION}.tar.xz"
          tar -xf "zig-linux-x86_64-${ZIG_VERSION}.tar.xz"
          sudo mv "zig-linux-x86_64-${ZIG_VERSION}" /opt/zig
          echo "/opt/zig" >> $GITHUB_PATH

          echo "Installing cargo-zigbuild..."
          cargo install cargo-zigbuild --locked || true

      - name: Install Packaging Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y makeself

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: ${{ matrix.docker_platform }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          platforms: ${{ matrix.docker_platform }}

      - name: Build Installer
        run: |
          chmod +x scripts/build-installer.sh
          ./scripts/build-installer.sh "${{ steps.version.outputs.version }}" "${{ matrix.arch }}" "${{ matrix.target }}"

      - name: Verify Build Artifacts
        run: |
          ARTIFACT="release/${{ steps.version.outputs.artifact_name }}"
          if [[ ! -f "$ARTIFACT" ]]; then
            echo "ERROR: Build artifact not found: $ARTIFACT"
            ls -la release/ || echo "release directory not found"
            exit 1
          fi
          echo "Build artifact:"
          ls -lh "$ARTIFACT"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.arch }}-installer
          path: release/${{ steps.version.outputs.artifact_name }}
          retention-days: 7
          if-no-files-found: error

  # ============================================================================
  # Job 3: Create GitHub Release
  # ============================================================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract Version
        id: version
        run: |
          VERSION=${GITHUB_REF_NAME#v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release/
          pattern: '*-installer'
          merge-multiple: true

      - name: List Downloaded Artifacts
        run: ls -la release/

      - name: Generate Release Notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG_NAME="${GITHUB_REF_NAME}"

          cat > release_notes.md << EOF
          ## MonarchEdge ${VERSION}

          ### Downloads

          | Architecture | Installer |
          |--------------|-----------|
          | ARM64 (树莓派/ARM开发板) | MonarchEdge-arm64-${VERSION}.run |
          | AMD64 (x86_64 服务器) | MonarchEdge-amd64-${VERSION}.run |

          ### Installation

          1. Download the installer for your architecture
          2. Copy to target device:
             \`\`\`bash
             scp MonarchEdge-<arch>-${VERSION}.run user@device:/tmp/
             \`\`\`
          3. Run installer:
             \`\`\`bash
             chmod +x /tmp/MonarchEdge-<arch>-${VERSION}.run
             sudo /tmp/MonarchEdge-<arch>-${VERSION}.run
             \`\`\`
          4. Start services:
             \`\`\`bash
             cd /opt/MonarchEdge
             docker-compose up -d
             monarch sync all
             \`\`\`

          ### Package Contents

          - **Rust Services**: comsrv (6001), modsrv (6002)
          - **Python Services**: hissrv (6004), apigateway (6005), netsrv (6006), alarmsrv (6007)
          - **Infrastructure**: Redis 8, InfluxDB 2
          - **CLI Tool**: monarch

          EOF

          # Add tag message if exists
          TAG_MESSAGE=$(git tag -l --format='%(contents)' "$TAG_NAME" 2>/dev/null || echo "")
          if [[ -n "$TAG_MESSAGE" ]]; then
            echo "" >> release_notes.md
            echo "### Release Notes" >> release_notes.md
            echo "" >> release_notes.md
            echo "$TAG_MESSAGE" >> release_notes.md
          fi

          # Add commits since previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [[ -n "$PREV_TAG" ]]; then
            echo "" >> release_notes.md
            echo "### Changes since $PREV_TAG" >> release_notes.md
            echo "" >> release_notes.md
            git log --pretty=format:"- %s" "$PREV_TAG".."$TAG_NAME" >> release_notes.md || true
          fi

          cat release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: MonarchEdge ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}
          files: |
            release/MonarchEdge-arm64-${{ steps.version.outputs.version }}.run
            release/MonarchEdge-amd64-${{ steps.version.outputs.version }}.run
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
