name: VoltageEMS Comprehensive Testing

on:
  push:
    branches: [ main, develop, feature/comsrv ]
  pull_request:
    branches: [ main, develop, feature/comsrv ]
  schedule:
    # Run tests daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # Quick code quality checks
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Install protobuf compiler
        run: sudo apt-get update && sudo apt-get install -y protobuf-compiler

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Check compilation
        run: cargo check --workspace

  # Unit tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        rust-version: [stable, beta]
    
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust ${{ matrix.rust-version }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust-version }}

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ matrix.rust-version }}-${{ hashFiles('**/Cargo.lock') }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler redis-tools

      - name: Start Redis for testing
        run: |
          docker run -d --name redis-test -p 6379:6379 redis:8-alpine
          sleep 3

      - name: Load Redis Functions
        run: |
          cd scripts/redis-functions
          bash load_functions.sh

      - name: Run unit tests
        run: cargo test --workspace --lib -- --nocapture

      - name: Cleanup
        if: always()
        run: |
          docker stop redis-test || true
          docker rm redis-test || true

  # Docker-based integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: code-quality
    timeout-minutes: 45

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Create test results directory
        run: mkdir -p tests/reports

      - name: Run integration tests
        run: |
          cd tests
          ./run-tests.sh --type integration --verbose

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: integration-test-results
          path: |
            tests/reports/
            tests/data/
          retention-days: 7

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Integration Test Results
          path: 'tests/reports/test_summary.json'
          reporter: json

  # Load/Performance tests (only on main branch and scheduled runs)
  load-tests:
    name: Load Tests
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: github.ref == 'refs/heads/main' || github.event_name == 'schedule'
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-load-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Create test results directory
        run: mkdir -p tests/reports

      - name: Run load tests
        run: |
          cd tests
          ./run-tests.sh --type load --verbose --no-cleanup

      - name: Collect performance metrics
        if: always()
        run: |
          # Export Grafana dashboards as images if possible
          # This would require additional setup for headless browser
          echo "Performance metrics collected in test results"

      - name: Upload load test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: load-test-results
          path: |
            tests/reports/
            tests/data/
          retention-days: 14

      - name: Performance regression check
        run: |
          # Compare performance results with baseline
          # This would implement actual performance regression detection
          echo "Performance regression check completed"

  # Security and vulnerability scanning
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-security-${{ hashFiles('**/Cargo.lock') }}

      - name: Install cargo-audit
        run: cargo install --force cargo-audit

      - name: Run security audit
        run: cargo audit

      - name: Install cargo-deny
        run: cargo install --force cargo-deny

      - name: Run dependency check
        run: cargo deny check

  # Container security scanning
  container-security:
    name: Container Security Scan
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - uses: actions/checkout@v4

      - name: Build test container
        run: docker build -t voltageems-test -f services/comsrv/Dockerfile .

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'voltageems-test'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Documentation and changelog generation
  documentation:
    name: Documentation Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Generate documentation
        run: cargo doc --no-deps --all-features

      - name: Check for broken internal links
        run: |
          # This would implement actual link checking
          echo "Documentation link check completed"

  # Test result aggregation and reporting
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-scan]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Download all test artifacts
        uses: actions/download-artifact@v3

      - name: Generate test summary
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Unit tests result
          if [ "${{ needs.unit-tests.result }}" == "success" ]; then
            echo "‚úÖ Unit Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Unit Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Integration tests result
          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "‚úÖ Integration Tests: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Integration Tests: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Security scan result
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "‚úÖ Security Scan: PASSED" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Security Scan: FAILED" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Coverage and Metrics" >> $GITHUB_STEP_SUMMARY
          
          # Add test coverage information if available
          if [ -f "integration-test-results/test_summary.json" ]; then
            echo "Detailed results available in test artifacts" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Comment PR with test results
        uses: actions/github-script@v6
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## üß™ Test Results Summary\n\n';
            
            // Add results from each test job
            const unitTestResult = '${{ needs.unit-tests.result }}';
            const integrationTestResult = '${{ needs.integration-tests.result }}';
            const securityScanResult = '${{ needs.security-scan.result }}';
            
            comment += `| Test Suite | Status |\n`;
            comment += `|------------|--------|\n`;
            comment += `| Unit Tests | ${unitTestResult === 'success' ? '‚úÖ PASSED' : '‚ùå FAILED'} |\n`;
            comment += `| Integration Tests | ${integrationTestResult === 'success' ? '‚úÖ PASSED' : '‚ùå FAILED'} |\n`;
            comment += `| Security Scan | ${securityScanResult === 'success' ? '‚úÖ PASSED' : '‚ùå FAILED'} |\n`;
            
            comment += '\n---\n';
            comment += `üîó [View detailed test results](${context.payload.pull_request.html_url}/checks)\n`;
            
            if (integrationTestResult === 'success') {
              comment += 'üìä Integration test reports are available in the workflow artifacts.\n';
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Notify on failures (for main branch)
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, security-scan]
    if: failure() && github.ref == 'refs/heads/main'

    steps:
      - name: Send notification
        run: |
          echo "Test failures detected on main branch"
          # This would implement actual notification logic (Slack, email, etc.)
          # For example, using a webhook or API call