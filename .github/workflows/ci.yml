name: CI

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  # 代码质量检查
  check:
    name: Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Install Protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Check compilation
        run: cargo check --workspace
      
      - name: Run Clippy
        run: |
          cargo clippy --all-targets --all-features -- \
            -D warnings \
            -A clippy::new_without_default \
            -A clippy::uninlined_format_args \
            -A clippy::approx_constant \
            -A clippy::derivable_impls

  # 运行测试
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: check
    services:
      redis:
        image: redis:8-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Protoc
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Load Redis Functions
        run: |
          # Install Redis CLI if not available
          sudo apt-get update && sudo apt-get install -y redis-tools
          
          # Load Lua functions
          cd scripts/redis-functions
          for lua_file in *.lua; do
            echo "Loading $lua_file..."
            redis-cli -h localhost -p 6379 FUNCTION LOAD REPLACE "$(cat $lua_file)" || true
          done
      
      - name: Run tests
        env:
          REDIS_URL: redis://localhost:6379
          VOLTAGE_REDIS_URL: redis://localhost:6379
        run: |
          # Run workspace tests
          cargo test --workspace -- --test-threads=1
      
      - name: Test individual services
        env:
          REDIS_URL: redis://localhost:6379
        run: |
          # Test services
          cargo test -p voltage-libs --lib
          cargo test -p comsrv
          
          # Skip unit tests for lightweight services (binary-only, no lib targets)
          # These services are lightweight and delegate to Redis Lua functions
          # Currently they have no unit tests - integration tests would be more appropriate
          echo "Skipping unit tests for lightweight services (modsrv, alarmsrv, rulesrv, hissrv, apigateway, netsrv)"
          echo "These services have no library targets and no unit tests currently"

  # 构建 Docker 镜像
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push'
    strategy:
      matrix:
        service: [comsrv, modsrv, alarmsrv, rulesrv, hissrv, apigateway, netsrv]
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./services/${{ matrix.service }}/Dockerfile
          push: false
          tags: voltageems-${{ matrix.service }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            GIT_COMMIT=${{ github.sha }}
          outputs: type=docker,dest=/tmp/${{ matrix.service }}.tar
      
      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-${{ matrix.service }}
          path: /tmp/${{ matrix.service }}.tar
          retention-days: 1

  # 集成测试
  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Download Docker images
        uses: actions/download-artifact@v4
        with:
          pattern: docker-*
          path: /tmp/docker-images
      
      - name: Load Docker images
        run: |
          for image in /tmp/docker-images/docker-*/*.tar; do
            echo "Loading $image..."
            docker load --input $image
          done
          docker images | grep voltageems
      
      - name: Start Redis and InfluxDB
        run: |
          # Start Redis
          docker run -d --name redis-test \
            -p 6379:6379 \
            --health-cmd "redis-cli ping" \
            --health-interval 5s \
            --health-timeout 3s \
            --health-retries 5 \
            redis:8-alpine
          
          # Wait for Redis to be healthy
          timeout 30 sh -c 'until docker exec redis-test redis-cli ping; do sleep 1; done'
          
          # Load Redis functions
          for lua_file in scripts/redis-functions/*.lua; do
            echo "Loading $(basename $lua_file)..."
            docker exec -i redis-test redis-cli FUNCTION LOAD REPLACE "$(cat $lua_file)" || true
          done
      
      - name: Start services
        run: |
          # Create network
          docker network create voltageems-test || true
          
          # Connect Redis to network
          docker network connect voltageems-test redis-test
          
          # Start comsrv
          docker run -d --name comsrv-test \
            --network voltageems-test \
            -p 6000:8081 \
            -e RUST_LOG=info \
            -e REDIS_URL=redis://redis-test:6379 \
            voltageems-comsrv:latest
          
          # Start modsrv
          docker run -d --name modsrv-test \
            --network voltageems-test \
            -p 6001:6001 \
            -e RUST_LOG=info \
            -e REDIS_URL=redis://redis-test:6379 \
            voltageems-modsrv:latest
          
          # Start alarmsrv
          docker run -d --name alarmsrv-test \
            --network voltageems-test \
            -p 6002:6002 \
            -e RUST_LOG=info \
            -e REDIS_URL=redis://redis-test:6379 \
            voltageems-alarmsrv:latest
          
          # Start rulesrv
          docker run -d --name rulesrv-test \
            --network voltageems-test \
            -p 6003:6003 \
            -e RUST_LOG=info \
            -e REDIS_URL=redis://redis-test:6379 \
            voltageems-rulesrv:latest
          
          # Start hissrv (without InfluxDB for now)
          docker run -d --name hissrv-test \
            --network voltageems-test \
            -p 6004:6004 \
            -e RUST_LOG=info \
            -e REDIS_URL=redis://redis-test:6379 \
            voltageems-hissrv:latest
          
          # Start apigateway
          docker run -d --name apigateway-test \
            --network voltageems-test \
            -p 6005:8080 \
            -e RUST_LOG=info \
            -e REDIS_URL=redis://redis-test:6379 \
            voltageems-apigateway:latest
          
          # Wait for services to be ready
          sleep 15
      
      - name: Check service health
        run: |
          # Show running containers
          docker ps
          
          # Check individual service logs for errors
          for service in comsrv modsrv alarmsrv rulesrv hissrv apigateway; do
            echo "=== Checking $service-test logs ==="
            docker logs --tail 20 $service-test || true
          done
          
          # Test health endpoints
          echo "=== Testing health endpoints ==="
          
          # comsrv on port 6000 (mapped from 8081)
          curl -f http://localhost:6000/health || echo "comsrv health check failed"
          
          # modsrv on port 6001
          curl -f http://localhost:6001/health || echo "modsrv health check failed"
          
          # alarmsrv on port 6002
          curl -f http://localhost:6002/health || echo "alarmsrv health check failed"
          
          # rulesrv on port 6003
          curl -f http://localhost:6003/health || echo "rulesrv health check failed"
          
          # hissrv on port 6004
          curl -f http://localhost:6004/health || echo "hissrv health check failed"
          
          # apigateway on port 6005 (mapped from 8080)
          curl -f http://localhost:6005/health || echo "apigateway health check failed"
      
      - name: Run basic API tests
        run: |
          echo "=== Running API tests ==="
          
          # Test comsrv channels API
          echo "Testing comsrv /api/channels..."
          curl -X GET http://localhost:6000/api/channels || true
          
          # Test modsrv templates API
          echo "Testing modsrv /api/templates..."
          curl -X GET http://localhost:6001/api/templates || true
          
          # Test alarmsrv alarms API
          echo "Testing alarmsrv /api/alarms..."
          curl -X GET http://localhost:6002/api/alarms || true
          
          # Test rulesrv rules API
          echo "Testing rulesrv /api/rules..."
          curl -X GET http://localhost:6003/api/rules || true
      
      - name: Collect logs
        if: always()
        run: |
          mkdir -p logs
          for service in redis comsrv modsrv alarmsrv rulesrv hissrv apigateway; do
            docker logs $service-test > logs/$service.log 2>&1 || true
          done
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-logs
          path: logs/
      
      - name: Stop services
        if: always()
        run: |
          # Stop all test containers
          docker stop redis-test comsrv-test modsrv-test alarmsrv-test rulesrv-test hissrv-test apigateway-test || true
          docker rm redis-test comsrv-test modsrv-test alarmsrv-test rulesrv-test hissrv-test apigateway-test || true
          docker network rm voltageems-test || true