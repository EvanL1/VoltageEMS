name: VoltageEMS CI/CD Pipeline

on:
  push:
    branches: [ main, develop, feature/* ]
  pull_request:
    branches: [ main, develop ]
  release:
    types: [ created ]

env:
  CARGO_TERM_COLOR: always
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # 代码质量检查
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
      
      - name: Cache Cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Check formatting
        run: cargo fmt --all -- --check
      
      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings
      
      # 可选的严格检查（仅在特定分支或标签上运行）
      # - name: Run strict Clippy checks (optional)
      #   if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      #   run: |
      #     cargo clippy --all-targets --all-features -- \
      #       -D warnings \
      #       -W clippy::unwrap_used \
      #       -W clippy::expect_used
      
      - name: Check compilation
        run: cargo check --workspace

  # 单元测试
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        service: [libs, comsrv, modsrv, alarmsrv, rulesrv, hissrv, netsrv, apigateway]
    steps:
      - uses: actions/checkout@v4
      
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      
      - name: Install Protoc
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
      
      - name: Cache Cargo dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      
      - name: Run tests for ${{ matrix.service }}
        run: |
          if [ "${{ matrix.service }}" = "libs" ]; then
            cargo test -p voltage-libs
          else
            cargo test -p ${{ matrix.service }}
          fi
      
      - name: Generate test report
        if: always()
        run: |
          cargo install cargo-junit --locked
          if [ "${{ matrix.service }}" = "libs" ]; then
            cargo test -p voltage-libs -- -Z unstable-options --format json | cargo-junit > test-results-${{ matrix.service }}.xml
          else
            cargo test -p ${{ matrix.service }} -- -Z unstable-options --format json | cargo-junit > test-results-${{ matrix.service }}.xml
          fi
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-results-${{ matrix.service }}
          path: test-results-${{ matrix.service }}.xml

  # 构建 Docker 镜像
  build-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      matrix:
        service: [apigateway, comsrv, modsrv, alarmsrv, rulesrv, hissrv, netsrv]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          target: ${{ matrix.service }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}
            VERSION=${{ github.ref_name }}

  # 集成测试
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: build-images
    steps:
      - uses: actions/checkout@v4
      
      - name: Create .env file
        run: |
          cat > .env << EOF
          VOLTAGE_LOG_LEVEL=debug
          VOLTAGE_REDIS_URL=redis://redis:6379
          VOLTAGE_INFLUXDB_URL=http://influxdb:8086
          VOLTAGE_INFLUXDB_TOKEN=test-token-for-ci
          VOLTAGE_INFLUXDB_ORG=voltage
          VOLTAGE_INFLUXDB_BUCKET=ems
          VOLTAGE_JWT_SECRET=test-jwt-secret-for-ci
          API_TOKEN=test-api-token
          EOF
      
      - name: Start services
        run: |
          docker-compose up -d
          sleep 30  # 等待服务启动
      
      - name: Check service health
        run: |
          docker-compose ps
          docker-compose logs --tail=50
      
      - name: Load Redis Functions
        run: |
          docker exec $(docker-compose ps -q redis) sh -c "cd /scripts && sh load_all_functions.sh"
      
      - name: Run integration tests
        run: |
          # Install Python test dependencies
          pip install pytest pytest-html pytest-junit-xml requests redis influxdb-client pymodbus
          
          # Run integration tests
          python -m pytest tests/test_integration.py tests/test_services.py \
            -v --tb=short \
            --junit-xml=test-results.xml \
            --html=test-results.html
      
      - name: Collect logs
        if: always()
        run: |
          docker-compose logs > integration-test-logs.txt
      
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-logs
          path: integration-test-logs.txt
      
      - name: Stop services
        if: always()
        run: docker-compose down -v

  # 性能测试
  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      
      - name: Start services
        run: |
          docker-compose up -d
          sleep 30
      
      - name: Run performance tests
        run: |
          docker run --rm --network=host \
            -v $PWD/tests/performance:/scripts \
            grafana/k6:latest run /scripts/load-test.js
      
      - name: Upload performance results
        uses: actions/upload-artifact@v3
        with:
          name: performance-results
          path: performance-results/

  # 部署到测试环境
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: integration-tests
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to staging
        env:
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_KEY: ${{ secrets.STAGING_KEY }}
        run: |
          echo "$STAGING_KEY" > deploy_key
          chmod 600 deploy_key
          
          # 复制 docker-compose 和配置文件
          scp -i deploy_key -o StrictHostKeyChecking=no \
            docker-compose.yml \
            .env.staging \
            $STAGING_USER@$STAGING_HOST:/opt/voltage-ems/
          
          # 部署
          ssh -i deploy_key -o StrictHostKeyChecking=no $STAGING_USER@$STAGING_HOST << 'EOF'
            cd /opt/voltage-ems
            docker-compose pull
            docker-compose up -d
            docker-compose ps
          EOF
          
          rm deploy_key

  # 部署到生产环境
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [integration-tests, performance-tests]
    if: github.event_name == 'release'
    environment: production
    steps:
      - uses: actions/checkout@v4
      
      - name: Deploy to production
        env:
          PROD_HOST: ${{ secrets.PROD_HOST }}
          PROD_USER: ${{ secrets.PROD_USER }}
          PROD_KEY: ${{ secrets.PROD_KEY }}
        run: |
          echo "$PROD_KEY" > deploy_key
          chmod 600 deploy_key
          
          # 备份当前版本
          ssh -i deploy_key -o StrictHostKeyChecking=no $PROD_USER@$PROD_HOST << 'EOF'
            cd /opt/voltage-ems
            docker-compose down
            tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz .
          EOF
          
          # 部署新版本
          scp -i deploy_key -o StrictHostKeyChecking=no \
            docker-compose.yml \
            .env.production \
            $PROD_USER@$PROD_HOST:/opt/voltage-ems/
          
          ssh -i deploy_key -o StrictHostKeyChecking=no $PROD_USER@$PROD_HOST << 'EOF'
            cd /opt/voltage-ems
            docker-compose pull
            docker-compose up -d
            
            # 健康检查
            sleep 30
            docker-compose ps
            
            # 验证服务
            curl -f http://localhost:8087/health || exit 1
          EOF
          
          rm deploy_key
      
      - name: Create release notes
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          body: |
            ## Changes in this Release
            - See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
            
            ## Docker Images
            - ghcr.io/${{ github.repository }}/apigateway:${{ github.ref_name }}
            - ghcr.io/${{ github.repository }}/comsrv:${{ github.ref_name }}
            - ghcr.io/${{ github.repository }}/modsrv:${{ github.ref_name }}
            - ghcr.io/${{ github.repository }}/alarmsrv:${{ github.ref_name }}
            - ghcr.io/${{ github.repository }}/rulesrv:${{ github.ref_name }}
            - ghcr.io/${{ github.repository }}/hissrv:${{ github.ref_name }}
            - ghcr.io/${{ github.repository }}/netsrv:${{ github.ref_name }}
          draft: false
          prerelease: false