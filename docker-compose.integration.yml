version: '3.8'

# Integration Testing Environment for VoltageEMS
# Focuses on cross-service communication and end-to-end workflows

services:
  # Test Infrastructure
  redis-integration:
    build:
      context: .
      dockerfile: docker/redis/Dockerfile
    container_name: voltageems-redis-integration
    ports:
      - "6381:6379"
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10

  influxdb-integration:
    image: influxdb:2.7-alpine
    container_name: voltageems-influxdb-integration
    ports:
      - "8088:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=integration
      - DOCKER_INFLUXDB_INIT_PASSWORD=integration123
      - DOCKER_INFLUXDB_INIT_ORG=voltageems-integration
      - DOCKER_INFLUXDB_INIT_BUCKET=integration_data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=integration-token-123
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Modbus Simulators for different test scenarios
  modbus-device-factory:
    image: oitc/modbus-server
    container_name: voltageems-modbus-factory
    ports:
      - "5030:5020"
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "5020"]
      interval: 10s
      timeout: 3s
      retries: 3

  modbus-device-warehouse:
    image: oitc/modbus-server
    container_name: voltageems-modbus-warehouse
    ports:
      - "5031:5020"
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "5020"]
      interval: 10s
      timeout: 3s
      retries: 3

  modbus-device-office:
    image: oitc/modbus-server
    container_name: voltageems-modbus-office
    ports:
      - "5032:5020"
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "5020"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Mock External Services
  mock-notification-service:
    build:
      context: ./tests/mocks
      dockerfile: Dockerfile.notification-mock
    container_name: voltageems-notification-mock
    ports:
      - "8090:8080"
    networks:
      - integration-network
    environment:
      - MOCK_SERVICE_TYPE=notification
      - LOG_LEVEL=debug

  mock-scada-system:
    build:
      context: ./tests/mocks
      dockerfile: Dockerfile.scada-mock
    container_name: voltageems-scada-mock
    ports:
      - "8091:8080"
    networks:
      - integration-network
    environment:
      - MOCK_SERVICE_TYPE=scada
      - LOG_LEVEL=debug

  # VoltageEMS Services for Integration Testing
  comsrv-integration:
    build:
      context: .
      dockerfile: services/comsrv/Dockerfile
    container_name: voltageems-comsrv-integration
    ports:
      - "6100:6000"
      - "3100:3000"
    environment:
      - RUST_LOG=debug,comsrv=trace
      - REDIS_URL=redis://redis-integration:6379
      - CSV_BASE_PATH=/app/config
    depends_on:
      redis-integration:
        condition: service_healthy
      modbus-device-factory:
        condition: service_healthy
      modbus-device-warehouse:
        condition: service_healthy
      modbus-device-office:
        condition: service_healthy
    volumes:
      - ./tests/integration/config:/app/config:ro
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6000/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  modsrv-integration:
    build:
      context: .
      dockerfile: services/modsrv/Dockerfile
    container_name: voltageems-modsrv-integration
    ports:
      - "6101:6001"
    environment:
      - RUST_LOG=debug,modsrv=trace
      - REDIS_URL=redis://redis-integration:6379
    depends_on:
      redis-integration:
        condition: service_healthy
    volumes:
      - ./tests/integration/config/modsrv:/app/config:ro
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6001/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  alarmsrv-integration:
    build:
      context: .
      dockerfile: services/alarmsrv/Dockerfile
    container_name: voltageems-alarmsrv-integration
    ports:
      - "6102:6002"
    environment:
      - RUST_LOG=debug,alarmsrv=trace
      - REDIS_URL=redis://redis-integration:6379
    depends_on:
      redis-integration:
        condition: service_healthy
    volumes:
      - ./tests/integration/config/alarmsrv:/app/config:ro
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6002/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  rulesrv-integration:
    build:
      context: .
      dockerfile: services/rulesrv/Dockerfile
    container_name: voltageems-rulesrv-integration
    ports:
      - "6103:6003"
    environment:
      - RUST_LOG=debug,rulesrv=trace
      - REDIS_URL=redis://redis-integration:6379
    depends_on:
      redis-integration:
        condition: service_healthy
    volumes:
      - ./tests/integration/config/rulesrv:/app/config:ro
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6003/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  hissrv-integration:
    build:
      context: .
      dockerfile: services/hissrv/Dockerfile
    container_name: voltageems-hissrv-integration
    ports:
      - "6104:6004"
    environment:
      - RUST_LOG=debug,hissrv=trace
      - REDIS_URL=redis://redis-integration:6379
      - INFLUXDB_URL=http://influxdb-integration:8086
      - INFLUXDB_TOKEN=integration-token-123
      - INFLUXDB_ORG=voltageems-integration
      - INFLUXDB_BUCKET=integration_data
    depends_on:
      redis-integration:
        condition: service_healthy
      influxdb-integration:
        condition: service_healthy
    volumes:
      - ./tests/integration/config/hissrv:/app/config:ro
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6004/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  apigateway-integration:
    build:
      context: .
      dockerfile: services/apigateway/Dockerfile
    container_name: voltageems-apigateway-integration
    ports:
      - "6105:6005"
    environment:
      - RUST_LOG=debug,apigateway=trace
      - REDIS_URL=redis://redis-integration:6379
      - JWT_SECRET=integration-secret-key-123
    depends_on:
      redis-integration:
        condition: service_healthy
    volumes:
      - ./tests/integration/config/apigateway:/app/config:ro
    networks:
      - integration-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6005/health"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Nginx for integration testing
  nginx-integration:
    image: nginx:alpine
    container_name: voltageems-nginx-integration
    ports:
      - "8080:80"
    volumes:
      - ./tests/integration/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - apigateway-integration
      - comsrv-integration
      - modsrv-integration
      - alarmsrv-integration
      - rulesrv-integration
      - hissrv-integration
    networks:
      - integration-network

  # Integration Test Runner
  integration-test-runner:
    build:
      context: .
      dockerfile: tests/docker/Dockerfile.integration-runner
    container_name: voltageems-integration-runner
    depends_on:
      comsrv-integration:
        condition: service_healthy
      modsrv-integration:
        condition: service_healthy
      alarmsrv-integration:
        condition: service_healthy
      rulesrv-integration:
        condition: service_healthy
      hissrv-integration:
        condition: service_healthy
      apigateway-integration:
        condition: service_healthy
      nginx-integration:
        condition: service_started
    environment:
      - RUST_LOG=debug
      - REDIS_URL=redis://redis-integration:6379
      - INFLUXDB_URL=http://influxdb-integration:8086
      - COMSRV_URL=http://comsrv-integration:6000
      - MODSRV_URL=http://modsrv-integration:6001
      - ALARMSRV_URL=http://alarmsrv-integration:6002
      - RULESRV_URL=http://rulesrv-integration:6003
      - HISSRV_URL=http://hissrv-integration:6004
      - APIGATEWAY_URL=http://apigateway-integration:6005
      - NGINX_URL=http://nginx-integration:80
    volumes:
      - ./tests/integration:/app/tests:ro
      - integration-test-results:/app/results
    networks:
      - integration-network
    command: ["python", "run_integration_tests.py"]

  # End-to-End Test Scenarios
  e2e-data-flow-test:
    build:
      context: ./tests/e2e
      dockerfile: Dockerfile.e2e-tests
    container_name: voltageems-e2e-data-flow
    depends_on:
      integration-test-runner:
        condition: service_completed_successfully
    environment:
      - TEST_SCENARIO=data_flow
      - NGINX_URL=http://nginx-integration:80
      - MODBUS_FACTORY=modbus-device-factory:5020
      - MODBUS_WAREHOUSE=modbus-device-warehouse:5020
      - MODBUS_OFFICE=modbus-device-office:5020
    volumes:
      - ./tests/e2e/scenarios:/app/scenarios:ro
      - e2e-test-results:/app/results
    networks:
      - integration-network
    command: ["pytest", "test_data_flow.py", "-v"]

  e2e-alarm-workflow-test:
    build:
      context: ./tests/e2e
      dockerfile: Dockerfile.e2e-tests
    container_name: voltageems-e2e-alarm-workflow
    depends_on:
      integration-test-runner:
        condition: service_completed_successfully
    environment:
      - TEST_SCENARIO=alarm_workflow
      - NGINX_URL=http://nginx-integration:80
      - NOTIFICATION_SERVICE=http://mock-notification-service:8080
    volumes:
      - ./tests/e2e/scenarios:/app/scenarios:ro
      - e2e-test-results:/app/results
    networks:
      - integration-network
    command: ["pytest", "test_alarm_workflow.py", "-v"]

  e2e-rule-engine-test:
    build:
      context: ./tests/e2e
      dockerfile: Dockerfile.e2e-tests
    container_name: voltageems-e2e-rule-engine
    depends_on:
      integration-test-runner:
        condition: service_completed_successfully
    environment:
      - TEST_SCENARIO=rule_engine
      - NGINX_URL=http://nginx-integration:80
      - SCADA_SYSTEM=http://mock-scada-system:8080
    volumes:
      - ./tests/e2e/scenarios:/app/scenarios:ro
      - e2e-test-results:/app/results
    networks:
      - integration-network
    command: ["pytest", "test_rule_engine.py", "-v"]

networks:
  integration-network:
    driver: bridge
    name: voltageems-integration-network

volumes:
  integration-test-results:
    name: voltageems-integration-test-results
  e2e-test-results:
    name: voltageems-e2e-test-results