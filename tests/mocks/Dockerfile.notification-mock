# Mock Notification Service
FROM python:3.11-slim

WORKDIR /app

RUN pip install --no-cache-dir \
    fastapi \
    uvicorn \
    pydantic

# Create mock notification service
RUN cat > /app/mock_notification_service.py << 'EOF'
#!/usr/bin/env python3
"""
Mock Notification Service for VoltageEMS Testing
Simulates external notification service behavior
"""

from fastapi import FastAPI, Request
from pydantic import BaseModel
import json
import logging
import time
from datetime import datetime
from typing import List, Optional

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

app = FastAPI(title="Mock Notification Service", version="1.0.0")

# Data models
class NotificationRequest(BaseModel):
    title: str
    message: str
    level: str = "info"
    recipients: List[str] = []
    metadata: Optional[dict] = None

class NotificationResponse(BaseModel):
    id: str
    status: str
    message: str
    timestamp: str

# In-memory storage for notifications
notifications_store = []

@app.get("/health")
async def health_check():
    """Health check endpoint"""
    return {"status": "healthy", "service": "mock-notification", "timestamp": datetime.now().isoformat()}

@app.post("/notifications", response_model=NotificationResponse)
async def send_notification(notification: NotificationRequest):
    """Mock notification sending"""
    
    # Simulate processing time
    time.sleep(0.1)
    
    notification_id = f"notif_{int(time.time() * 1000)}"
    
    # Store notification
    stored_notification = {
        "id": notification_id,
        "title": notification.title,
        "message": notification.message,
        "level": notification.level,
        "recipients": notification.recipients,
        "metadata": notification.metadata,
        "timestamp": datetime.now().isoformat(),
        "status": "sent"
    }
    
    notifications_store.append(stored_notification)
    
    logger.info(f"Mock notification sent: {notification_id} - {notification.title}")
    
    # Simulate different response scenarios
    success_rate = 0.95  # 95% success rate
    if len(notifications_store) % int(1/0.05) == 0:  # Occasional failure
        return NotificationResponse(
            id=notification_id,
            status="failed",
            message="Mock failure: Network timeout",
            timestamp=datetime.now().isoformat()
        )
    
    return NotificationResponse(
        id=notification_id,
        status="sent",
        message="Notification sent successfully",
        timestamp=datetime.now().isoformat()
    )

@app.get("/notifications/{notification_id}")
async def get_notification(notification_id: str):
    """Get notification by ID"""
    for notification in notifications_store:
        if notification["id"] == notification_id:
            return notification
    return {"error": "Notification not found"}, 404

@app.get("/notifications")
async def list_notifications(limit: int = 100):
    """List recent notifications"""
    return {
        "notifications": notifications_store[-limit:],
        "total": len(notifications_store)
    }

@app.post("/webhooks/alarm")
async def alarm_webhook(request: Request):
    """Webhook endpoint for alarm notifications"""
    body = await request.json()
    
    logger.info(f"Received alarm webhook: {json.dumps(body, indent=2)}")
    
    # Create notification from alarm data
    notification = NotificationRequest(
        title=f"Alarm: {body.get('title', 'Unknown')}",
        message=body.get('description', 'No description'),
        level=body.get('level', 'warning').lower(),
        recipients=["admin@voltageems.com"],
        metadata={"source": "alarm_webhook", "alarm_id": body.get("id")}
    )
    
    return await send_notification(notification)

@app.get("/stats")
async def get_stats():
    """Get notification statistics"""
    total = len(notifications_store)
    sent = len([n for n in notifications_store if n["status"] == "sent"])
    failed = len([n for n in notifications_store if n["status"] == "failed"])
    
    return {
        "total_notifications": total,
        "sent": sent,
        "failed": failed,
        "success_rate": sent / total if total > 0 else 0,
        "uptime": time.time()
    }

@app.delete("/notifications")
async def clear_notifications():
    """Clear all notifications (for testing)"""
    notifications_store.clear()
    logger.info("All notifications cleared")
    return {"message": "All notifications cleared"}

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8080)
EOF

RUN chmod +x /app/mock_notification_service.py

EXPOSE 8080

CMD ["python", "/app/mock_notification_service.py"]