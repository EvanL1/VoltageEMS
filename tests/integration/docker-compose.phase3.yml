version: '3.8'

# Phase 3: 压力测试配置 - 50个通道，10000个点位

services:
  # 覆盖环境变量以设置Phase 3规模
  modbus_tcp_simulator:
    environment:
      - SIMULATOR_MODE=tcp
      - DEVICE_COUNT=15  # 15个通道
      - POINTS_PER_DEVICE=200  # 每通道200个点
      - LOG_LEVEL=WARN  # 减少日志输出
      - START_PORT=5020
      - MULTI_PORT=true
      - UPDATE_INTERVAL=100  # 快速更新
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'

  modbus_rtu_simulator:
    environment:
      - SIMULATOR_MODE=rtu
      - DEVICE_COUNT=10  # 10个通道
      - POINTS_PER_DEVICE=200  # 每通道200个点
      - SERIAL_PORT=/dev/ttyV0
      - BAUD_RATE=38400

  can_simulator:
    environment:
      - CAN_INTERFACE=vcan0
      - NODE_COUNT=15  # 15个通道
      - MESSAGE_RATE=500  # 高频率消息
      - POINTS_PER_NODE=200  # 每通道200个点
      - USE_EXTENDED_ID=true
      - BATCH_MODE=true

  iec104_simulator:
    environment:
      - STATION_COUNT=10  # 10个通道
      - POINTS_PER_STATION=200  # 每通道200个点
      - LOG_LEVEL=WARN
      - ENABLE_TIME_SYNC=true
      - ENABLE_COMMANDS=true
      - UPDATE_RATE=10  # 10Hz更新率

  comsrv:
    environment:
      - RUST_LOG=comsrv=warn
      - REDIS_URL=redis://redis:6379
      - CONFIG_PATH=/config/phase3
      - COMSRV_CSV_BASE_PATH=/config/phase3/csv
      - COMSRV_BATCH_SIZE=500
      - COMSRV_SCAN_INTERVAL=500
      - COMSRV_BUFFER_SIZE=10000
      - COMSRV_MAX_CONNECTIONS=100
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4'

  redis:
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'
    command: redis-server --maxmemory 1gb --maxmemory-policy allkeys-lru

  apigateway:
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1'

  test_runner:
    environment:
      - API_URL=http://apigateway:8080
      - REDIS_URL=redis://redis:6379
      - TEST_PHASE=phase3
      - TEST_TYPE=all
      - TEST_TIMEOUT=2700  # 45分钟超时
      - EXPECTED_CHANNELS=50
      - EXPECTED_POINTS=10000
      - PERFORMANCE_CHECK=true
      - STRESS_TEST=true
      - MIN_SUCCESS_RATE=0.95
      - MAX_LATENCY_MS=100
      - MIN_THROUGHPUT_OPS=1000
    volumes:
      - ./configs/phase3:/configs:ro
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'