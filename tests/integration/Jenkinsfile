pipeline {
    agent any
    
    environment {
        // Docker registry settings
        DOCKER_REGISTRY = "${env.DOCKER_REGISTRY ?: 'docker.io'}"
        DOCKER_NAMESPACE = "${env.DOCKER_NAMESPACE ?: 'voltageems'}"
        
        // Build settings
        RUST_BACKTRACE = '1'
        CARGO_HOME = "${WORKSPACE}/.cargo"
        
        // Test settings
        TEST_RESULTS_DIR = "${WORKSPACE}/test-results"
        INTEGRATION_TEST_DIR = "${WORKSPACE}/tests/integration"
    }
    
    options {
        // Keep builds for 30 days
        buildDiscarder(logRotator(numToKeepStr: '30'))
        
        // Timeout for entire pipeline
        timeout(time: 2, unit: 'HOURS')
        
        // Disable concurrent builds
        disableConcurrentBuilds()
    }
    
    stages {
        stage('Preparation') {
            steps {
                echo 'Preparing build environment...'
                
                // Clean workspace
                sh 'rm -rf ${TEST_RESULTS_DIR}'
                sh 'mkdir -p ${TEST_RESULTS_DIR}'
                
                // Check Docker and Docker Compose
                sh 'docker version'
                sh 'docker-compose version'
                
                // Check Rust/Cargo
                sh 'cargo --version'
            }
        }
        
        stage('Build Services') {
            parallel {
                stage('Build comsrv') {
                    steps {
                        dir('services/comsrv') {
                            sh 'cargo build --release'
                        }
                    }
                }
                
                stage('Build apigateway') {
                    steps {
                        dir('services/apigateway') {
                            sh 'cargo build --release'
                        }
                    }
                }
                
                stage('Build modsrv') {
                    steps {
                        dir('services/modsrv') {
                            sh 'cargo build --release'
                        }
                    }
                }
                
                stage('Build hissrv') {
                    steps {
                        dir('services/hissrv') {
                            sh 'cargo build --release'
                        }
                    }
                }
            }
        }
        
        stage('Build Docker Images') {
            steps {
                dir('${INTEGRATION_TEST_DIR}') {
                    sh '''
                        # Build all Docker images
                        docker-compose build --parallel
                        
                        # Tag images
                        docker tag voltageems_comsrv:latest ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/comsrv:${BUILD_NUMBER}
                        docker tag voltageems_apigateway:latest ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/apigateway:${BUILD_NUMBER}
                    '''
                }
            }
        }
        
        stage('Phase 1: Functional Tests') {
            steps {
                script {
                    dir('${INTEGRATION_TEST_DIR}') {
                        try {
                            // Generate Phase 1 configurations
                            sh 'python3 scripts/generate_test_configs.py phase1 configs/phase1'
                            
                            // Run Phase 1 tests
                            sh '''
                                export TEST_PHASE=phase1
                                docker-compose -f docker-compose.yml -f docker-compose.phase1.yml up -d
                                
                                # Wait for services to be ready
                                sleep 30
                                
                                # Run tests
                                docker-compose -f docker-compose.yml -f docker-compose.phase1.yml \
                                    run --rm test_runner
                            '''
                            
                            // Collect results
                            sh 'cp -r test_results/* ${TEST_RESULTS_DIR}/'
                            
                        } finally {
                            // Cleanup
                            sh 'docker-compose -f docker-compose.yml -f docker-compose.phase1.yml down -v'
                        }
                    }
                }
            }
        }
        
        stage('Phase 2: Scale Tests') {
            when {
                expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                script {
                    dir('${INTEGRATION_TEST_DIR}') {
                        try {
                            // Generate Phase 2 configurations
                            sh 'python3 scripts/generate_test_configs.py phase2 configs/phase2'
                            
                            // Run Phase 2 tests
                            sh '''
                                export TEST_PHASE=phase2
                                docker-compose -f docker-compose.yml -f docker-compose.phase2.yml up -d
                                
                                # Wait for services to be ready
                                sleep 45
                                
                                # Run tests
                                docker-compose -f docker-compose.yml -f docker-compose.phase2.yml \
                                    run --rm test_runner
                            '''
                            
                            // Collect results
                            sh 'cp -r test_results/* ${TEST_RESULTS_DIR}/'
                            
                        } finally {
                            // Cleanup
                            sh 'docker-compose -f docker-compose.yml -f docker-compose.phase2.yml down -v'
                        }
                    }
                }
            }
        }
        
        stage('Phase 3: Stress Tests') {
            when {
                allOf {
                    expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
                    branch 'main'  // Only run stress tests on main branch
                }
            }
            steps {
                script {
                    dir('${INTEGRATION_TEST_DIR}') {
                        try {
                            // Generate Phase 3 configurations
                            sh 'python3 scripts/generate_test_configs.py phase3 configs/phase3'
                            
                            // Run Phase 3 tests
                            sh '''
                                export TEST_PHASE=phase3
                                docker-compose -f docker-compose.yml -f docker-compose.phase3.yml up -d
                                
                                # Wait for services to be ready
                                sleep 60
                                
                                # Run tests with extended timeout
                                docker-compose -f docker-compose.yml -f docker-compose.phase3.yml \
                                    run --rm test_runner
                            '''
                            
                            // Collect results
                            sh 'cp -r test_results/* ${TEST_RESULTS_DIR}/'
                            
                        } finally {
                            // Cleanup
                            sh 'docker-compose -f docker-compose.yml -f docker-compose.phase3.yml down -v'
                        }
                    }
                }
            }
        }
        
        stage('Unit Tests') {
            parallel {
                stage('Protocol Tests') {
                    steps {
                        dir('tests') {
                            sh './run_all_protocol_tests.sh'
                        }
                    }
                }
                
                stage('API Tests') {
                    steps {
                        dir('tests') {
                            sh './scripts/test_api.sh'
                        }
                    }
                }
            }
        }
    }
    
    post {
        always {
            // Archive test results
            archiveArtifacts artifacts: 'test-results/**/*', allowEmptyArchive: true
            
            // Publish test reports
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'test-results',
                reportFiles: '*.html,*.md',
                reportName: 'Integration Test Report'
            ])
            
            // Clean up Docker resources
            sh '''
                docker-compose -f ${INTEGRATION_TEST_DIR}/docker-compose.yml down -v || true
                docker system prune -f || true
            '''
        }
        
        success {
            echo 'Pipeline completed successfully!'
            
            // Tag and push Docker images on success
            script {
                if (env.BRANCH_NAME == 'main') {
                    sh '''
                        docker tag ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/comsrv:${BUILD_NUMBER} \
                                   ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/comsrv:latest
                        docker tag ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/apigateway:${BUILD_NUMBER} \
                                   ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/apigateway:latest
                        
                        # Push images (requires Docker login in Jenkins)
                        # docker push ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/comsrv:${BUILD_NUMBER}
                        # docker push ${DOCKER_REGISTRY}/${DOCKER_NAMESPACE}/comsrv:latest
                    '''
                }
            }
        }
        
        failure {
            echo 'Pipeline failed!'
            
            // Collect logs for debugging
            sh '''
                mkdir -p ${TEST_RESULTS_DIR}/logs
                docker-compose -f ${INTEGRATION_TEST_DIR}/docker-compose.yml logs > ${TEST_RESULTS_DIR}/logs/docker-compose.log || true
            '''
        }
        
        unstable {
            echo 'Pipeline is unstable'
        }
    }
}