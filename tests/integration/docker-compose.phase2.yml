version: '3.8'

# Phase 2: 规模测试配置 - 30个通道，3000个点位

services:
  # 覆盖环境变量以设置Phase 2规模
  modbus_tcp_simulator:
    environment:
      - SIMULATOR_MODE=tcp
      - DEVICE_COUNT=10  # 10个通道
      - POINTS_PER_DEVICE=100  # 每通道100个点
      - LOG_LEVEL=INFO
      - START_PORT=5020
      - MULTI_PORT=true  # 使用多个端口

  modbus_rtu_simulator:
    environment:
      - SIMULATOR_MODE=rtu
      - DEVICE_COUNT=5  # 5个通道
      - POINTS_PER_DEVICE=100  # 每通道100个点
      - SERIAL_PORT=/dev/ttyV0
      - BAUD_RATE=19200

  can_simulator:
    environment:
      - CAN_INTERFACE=vcan0
      - NODE_COUNT=8  # 8个通道
      - MESSAGE_RATE=200
      - POINTS_PER_NODE=100  # 每通道100个点
      - USE_EXTENDED_ID=true

  iec104_simulator:
    environment:
      - STATION_COUNT=7  # 7个通道
      - POINTS_PER_STATION=100  # 每通道100个点
      - LOG_LEVEL=INFO
      - ENABLE_TIME_SYNC=true

  comsrv:
    environment:
      - RUST_LOG=comsrv=info
      - REDIS_URL=redis://redis:6379
      - CONFIG_PATH=/config/phase2
      - COMSRV_CSV_BASE_PATH=/config/phase2/csv
      - COMSRV_BATCH_SIZE=100
      - COMSRV_SCAN_INTERVAL=1000
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2'

  test_runner:
    environment:
      - API_URL=http://apigateway:8080
      - REDIS_URL=redis://redis:6379
      - TEST_PHASE=phase2
      - TEST_TYPE=all
      - TEST_TIMEOUT=1800  # 30分钟超时
      - EXPECTED_CHANNELS=30
      - EXPECTED_POINTS=3000
      - PERFORMANCE_CHECK=true
    volumes:
      - ./configs/phase2:/configs:ro