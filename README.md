# VoltageEMS - å·¥ä¸šç‰©è”ç½‘èƒ½æºç®¡ç†ç³»ç»Ÿ

é«˜æ€§èƒ½çš„å¾®æœåŠ¡æ¶æ„å·¥ä¸šç‰©è”ç½‘èƒ½æºç®¡ç†ç³»ç»Ÿï¼ŒåŸºäºRustæ„å»ºï¼Œæ”¯æŒå¤šç§å·¥ä¸šåè®®å’Œå®æ—¶æ•°æ®å¤„ç†ã€‚

[![CI/CD Pipeline](https://github.com/your-org/VoltageEMS/actions/workflows/ci-cd.yml/badge.svg)](https://github.com/your-org/VoltageEMS/actions/workflows/ci-cd.yml)

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### å¾®æœåŠ¡æ¶æ„
- **API Gateway** (8089) - ç»Ÿä¸€APIç½‘å…³ï¼ŒJWTè®¤è¯å’Œè¯·æ±‚è·¯ç”±
- **comsrv** (3000) - å·¥ä¸šåè®®ç½‘å…³ï¼Œæ”¯æŒModbusã€CANã€IEC60870ç­‰åè®®
- **modsrv** (8092) - è®¾å¤‡æ¨¡å‹è®¡ç®—å¼•æ“ï¼Œå®æ—¶æ•°æ®å¤„ç†
- **hissrv** (8082) - å†å²æ•°æ®æœåŠ¡ï¼Œæ—¶åºæ•°æ®ç®¡ç†
- **alarmsrv** (8080) - å‘Šè­¦ç®¡ç†æœåŠ¡ï¼Œå®æ—¶å‘Šè­¦æ£€æµ‹
- **rulesrv** (8080) - è§„åˆ™å¼•æ“ï¼Œè‡ªåŠ¨åŒ–æ§åˆ¶é€»è¾‘
- **netsrv** - äº‘ç«¯ç½‘å…³ï¼ˆå¼€å‘ä¸­ï¼‰

### æŠ€æœ¯æ ˆ
- **åç«¯**: Rust + Axumæ¡†æ¶
- **æ•°æ®å­˜å‚¨**: Redis (å®æ—¶æ•°æ®) + InfluxDB (å†å²æ•°æ®)
- **æ¶ˆæ¯æ€»çº¿**: Redis Pub/Sub + Hashå­˜å‚¨
- **æ•°æ®åŒæ­¥**: Luaè„šæœ¬é«˜æ€§èƒ½å¤„ç†
- **å‰ç«¯**: Vue 3 + Tauriæ¡Œé¢åº”ç”¨

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### Redisæ•°æ®æ¶æ„ v3.2

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Web Application                        â”‚
â”‚            Web UI | Mobile App | HMI/SCADA                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
               â”‚ API Gateway â”‚ (8089)
               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Redis Message Bus                        â”‚
â”‚              Pub/Sub | Hash Storage | Streams               â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
   â”‚          â”‚        â”‚         â”‚          â”‚          â”‚
â”Œâ”€â”€â”´â”€â”€â”€â”  â”Œâ”€â”€â”€â”´â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”€â”  â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”
â”‚comsrvâ”‚  â”‚modsrvâ”‚  â”‚hissrvâ”‚  â”‚netsrvâ”‚  â”‚alarmsrvâ”‚  â”‚rulesâ”‚
â”‚(3000)â”‚  â”‚(8092)â”‚  â”‚(8082)â”‚  â”‚ (N/A)â”‚  â”‚ (8080) â”‚  â”‚(8080)â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
   â”‚
â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Devices              â”‚
â”‚   Modbus | IEC60870 | CAN | ... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Hashå­˜å‚¨ç»“æ„

```
# å®æ—¶æ•°æ®å­˜å‚¨
comsrv:{channelID}:m    # é¥æµ‹æ•°æ® (measurements)
comsrv:{channelID}:s    # é¥ä¿¡æ•°æ® (signals)
comsrv:{channelID}:c    # é¥æ§æ•°æ® (controls)
comsrv:{channelID}:a    # é¥è°ƒæ•°æ® (adjustments)

# æ¨¡å‹è®¡ç®—ç»“æœ
modsrv:{modelname}:measurement
modsrv:{modelname}:control

# å‘Šè­¦æ•°æ®
alarm:{alarmID}

# è§„åˆ™å®šä¹‰
rulesrv:rule:{ruleID}
```

**é‡è¦ç‰¹æ€§**ï¼š
- Hashç»“æ„æä¾›O(1)è®¿é—®æ€§èƒ½
- æ”¯æŒç™¾ä¸‡çº§ç‚¹ä½
- 6ä½å°æ•°ç²¾åº¦æ ‡å‡†åŒ–
- ç‚¹ä½IDä»1å¼€å§‹ï¼ˆä¸å†ä½¿ç”¨10001ç­‰åˆ†æ®µï¼‰

### Luaè„šæœ¬æ•°æ®å¤„ç†

VoltageEMSä½¿ç”¨Luaè„šæœ¬è¿›è¡Œç‰¹å®šçš„æ•°æ®å¤„ç†ä»»åŠ¡ï¼š

#### HisSrvæ•°æ®èšåˆ
```lua
-- services/hissrv/scripts/
â””â”€â”€ archive_aggregator.lua  # å†å²æ•°æ®èšåˆè„šæœ¬
    â”œâ”€â”€ 1åˆ†é’Ÿèšåˆï¼šä»å®æ—¶æ•°æ®è®¡ç®—avg/min/max
    â””â”€â”€ 5åˆ†é’Ÿèšåˆï¼šä»1åˆ†é’Ÿæ•°æ®äºŒæ¬¡èšåˆ
```

#### æœåŠ¡é—´æ•°æ®åŒæ­¥
```lua
-- scripts/
â””â”€â”€ sync.lua             # comsrvä¸modsrvåŒå‘æ•°æ®åŒæ­¥
```

Luaè„šæœ¬ä¸»è¦ç”¨äºï¼š
- HisSrvçš„æ—¶åºæ•°æ®èšåˆ
- é«˜æ€§èƒ½çš„æ‰¹é‡æ•°æ®å¤„ç†
- Rediså†…éƒ¨çš„åŸå­æ€§æ“ä½œ
- å‡å°‘æœåŠ¡é—´çš„ç½‘ç»œå¼€é”€

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Docker & Docker Compose
- Rust 1.88+ (ä»…å¼€å‘éœ€è¦)
- Make (å¯é€‰ï¼Œç®€åŒ–å‘½ä»¤)

### ä½¿ç”¨ Docker Compose (æ¨è)

```bash
# 1. å…‹éš†ä»“åº“
git clone https://github.com/your-org/VoltageEMS.git
cd VoltageEMS

# 2. å¤åˆ¶ç¯å¢ƒé…ç½®
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½®å¿…è¦çš„é…ç½®

# 3. å¯åŠ¨æ‰€æœ‰æœåŠ¡
make up
# æˆ–è€…
docker-compose up -d

# 4. æ£€æŸ¥æœåŠ¡çŠ¶æ€
make monitor
# æˆ–è€…
docker-compose ps
```

### æœ¬åœ°å¼€å‘

```bash
# 1. å¯åŠ¨åŸºç¡€è®¾æ–½
docker run -d --name redis-dev -p 6379:6379 redis:8-alpine
docker run -d --name influxdb-dev -p 8086:8086 influxdb:2.7-alpine

# 2. æŒ‰é¡ºåºå¯åŠ¨æœåŠ¡
cargo run -p comsrv      # å·¥ä¸šåè®®ç½‘å…³
cargo run -p modsrv      # è®¡ç®—å¼•æ“
cargo run -p hissrv      # å†å²æ•°æ®æœåŠ¡
cargo run -p alarmsrv    # å‘Šè­¦æœåŠ¡
cargo run -p rulesrv     # è§„åˆ™å¼•æ“
cargo run -p apigateway  # APIç½‘å…³
```

### å¼€å‘å‘½ä»¤

```bash
# æ£€æŸ¥ç¼–è¯‘ï¼ˆæ¨èï¼‰
cargo check --workspace

# æ ¼å¼åŒ–ä»£ç 
cargo fmt --all

# è¿è¡Œclippy
cargo clippy --all-targets --all-features -- -D warnings

# è¿è¡Œæµ‹è¯•
cargo test --workspace

# ç›‘æ§Redisæ•°æ®
redis-cli monitor | grep comsrv

# æŸ¥çœ‹Hashæ•°æ®
redis-cli hgetall "comsrv:1001:T"
```

## ğŸ“Š æ•°æ®æµ

### å®æ—¶æ•°æ®é‡‡é›†
```
è®¾å¤‡ â†’ comsrv â†’ Redis Hash â†’ Luaè„šæœ¬å¤„ç† â†’ modsrv/alarmsrv â†’ å‰ç«¯
```

### æ§åˆ¶å‘½ä»¤ä¸‹å‘
```
å‰ç«¯ â†’ API Gateway â†’ Redis Pub/Sub â†’ comsrv â†’ è®¾å¤‡
```

### å†å²æ•°æ®å­˜å‚¨
```
Redis â†’ hissrv â†’ InfluxDB â†’ æ—¶åºæŸ¥è¯¢API
```

## ğŸ”§ é…ç½®è¯´æ˜

### æœåŠ¡é…ç½®
æ¯ä¸ªæœåŠ¡éƒ½æœ‰ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼š
```
services/{service}/config/default.yml
```

### ç‚¹ä½é…ç½®
ä½¿ç”¨CSVæ–‡ä»¶é…ç½®ç‚¹ä½æ˜ å°„ï¼š
```
services/comsrv/config/{Protocol}_CH{ChannelID}/
â”œâ”€â”€ measurement.csv    # é¥æµ‹ç‚¹
â”œâ”€â”€ signal.csv        # é¥ä¿¡ç‚¹
â”œâ”€â”€ control.csv       # é¥æ§ç‚¹
â””â”€â”€ adjustment.csv    # é¥è°ƒç‚¹
```

### ç¯å¢ƒå˜é‡
```bash
RUST_LOG=debug         # æ—¥å¿—çº§åˆ«
REDIS_URL=redis://localhost:6379
INFLUXDB_URL=http://localhost:8086
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

- JWT Tokenè®¤è¯
- Redis ACLæƒé™éš”ç¦»
- HTTPS/TLSæ”¯æŒ
- æ•æ„Ÿä¿¡æ¯ç¯å¢ƒå˜é‡ç®¡ç†

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- Hashå­˜å‚¨ç»“æ„ï¼ŒO(1)è®¿é—®
- Luaè„šæœ¬æ‰¹é‡å¤„ç†
- è¿æ¥æ± å¤ç”¨
- å¼‚æ­¥I/Oå¤„ç†
- 6ä½å°æ•°ç²¾åº¦æ ‡å‡†åŒ–

## ğŸš¢ CI/CD æµç¨‹

é¡¹ç›®ä½¿ç”¨ GitHub Actions å®ç°å®Œæ•´çš„ CI/CD æµç¨‹ï¼š

### è‡ªåŠ¨åŒ–æµç¨‹
- **ä»£ç è´¨é‡æ£€æŸ¥**: æ¯æ¬¡æ¨é€è‡ªåŠ¨è¿è¡Œæ ¼å¼åŒ–å’Œ lint æ£€æŸ¥
- **å•å…ƒæµ‹è¯•**: å¹¶è¡Œè¿è¡Œæ‰€æœ‰æœåŠ¡çš„æµ‹è¯•
- **Docker æ„å»º**: è‡ªåŠ¨æ„å»ºå¹¶æ¨é€é•œåƒåˆ° GitHub Container Registry
- **é›†æˆæµ‹è¯•**: ä½¿ç”¨ docker-compose å¯åŠ¨å®Œæ•´ç³»ç»Ÿè¿›è¡Œæµ‹è¯•
- **è‡ªåŠ¨éƒ¨ç½²**: 
  - `develop` åˆ†æ”¯è‡ªåŠ¨éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  - åˆ›å»º release æ—¶è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### æ‰‹åŠ¨éƒ¨ç½²
```bash
# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
make deploy-staging

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
make deploy-prod
```

è¯¦ç»†çš„ CI/CD é…ç½®è¯´æ˜è¯·å‚è€ƒ [CI/CD Setup Guide](docs/ci-cd-setup.md)

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…