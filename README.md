# VoltageEMS - å·¥ä¸šç‰©è”ç½‘èƒ½æºç®¡ç†ç³»ç»Ÿ

é«˜æ€§èƒ½çš„å¾®æœåŠ¡æ¶æ„å·¥ä¸šç‰©è”ç½‘èƒ½æºç®¡ç†ç³»ç»Ÿï¼ŒåŸºäºRustæ„å»ºï¼Œæ”¯æŒå¤šç§å·¥ä¸šåè®®å’Œå®æ—¶æ•°æ®å¤„ç†ã€‚

[![CI/CD Pipeline](https://github.com/your-org/VoltageEMS/actions/workflows/ci-cd.yml/badge.svg)](https://github.com/your-org/VoltageEMS/actions/workflows/ci-cd.yml)

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### å¾®æœåŠ¡æ¶æ„
- **API Gateway** (8089) - ç»Ÿä¸€APIç½‘å…³ï¼ŒJWTè®¤è¯å’Œè¯·æ±‚è·¯ç”±
- **comsrv** (3000) - å·¥ä¸šåè®®ç½‘å…³ï¼Œæ”¯æŒModbusã€CANã€IEC60870ç­‰åè®®
- **modsrv** (8092) - è®¾å¤‡æ¨¡å‹è®¡ç®—å¼•æ“ï¼Œå®æ—¶æ•°æ®å¤„ç†
- **hissrv** (8082) - å†å²æ•°æ®æœåŠ¡ï¼Œæ—¶åºæ•°æ®ç®¡ç†
- **alarmsrv** (8080) - å‘Šè­¦ç®¡ç†æœåŠ¡ï¼Œå®æ—¶å‘Šè­¦æ£€æµ‹
- **rulesrv** (8080) - è§„åˆ™å¼•æ“ï¼Œè‡ªåŠ¨åŒ–æ§åˆ¶é€»è¾‘
- **netsrv** - äº‘ç«¯ç½‘å…³ï¼ˆå¼€å‘ä¸­ï¼‰

### æŠ€æœ¯æ ˆ
- **åç«¯**: Rust + Axumæ¡†æ¶
- **æ•°æ®å­˜å‚¨**: Redis (å®æ—¶æ•°æ®) + InfluxDB (å†å²æ•°æ®)
- **æ¶ˆæ¯æ€»çº¿**: Redis Pub/Sub + Hashå­˜å‚¨
- **æ•°æ®åŒæ­¥**: Luaè„šæœ¬é«˜æ€§èƒ½å¤„ç†
- **å‰ç«¯**: Vue 3 + Tauriæ¡Œé¢åº”ç”¨

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### Redisæ•°æ®æ¶æ„ v3.2

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Web Application                        â”‚
â”‚            Web UI | Mobile App | HMI/SCADA                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
               â”‚ API Gateway â”‚ (8089)
               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Redis Message Bus                        â”‚
â”‚              Pub/Sub | Hash Storage | Streams               â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
   â”‚          â”‚        â”‚         â”‚          â”‚          â”‚
â”Œâ”€â”€â”´â”€â”€â”€â”  â”Œâ”€â”€â”€â”´â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”€â”  â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”  â”Œâ”€â”€â”´â”€â”€â”
â”‚comsrvâ”‚  â”‚modsrvâ”‚  â”‚hissrvâ”‚  â”‚netsrvâ”‚  â”‚alarmsrvâ”‚  â”‚rulesâ”‚
â”‚(3000)â”‚  â”‚(8092)â”‚  â”‚(8082)â”‚  â”‚ (N/A)â”‚  â”‚ (8080) â”‚  â”‚(8080)â”‚
â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”˜
   â”‚
â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            Devices              â”‚
â”‚   Modbus | IEC60870 | CAN | ... â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Hashå­˜å‚¨ç»“æ„

```
# å®æ—¶æ•°æ®å­˜å‚¨
comsrv:{channelID}:m    # é¥æµ‹æ•°æ® (measurements)
comsrv:{channelID}:s    # é¥ä¿¡æ•°æ® (signals)
comsrv:{channelID}:c    # é¥æ§æ•°æ® (controls)
comsrv:{channelID}:a    # é¥è°ƒæ•°æ® (adjustments)

# æ¨¡å‹è®¡ç®—ç»“æœ
modsrv:{modelname}:measurement
modsrv:{modelname}:control

# å‘Šè­¦æ•°æ®
alarm:{alarmID}

# è§„åˆ™å®šä¹‰
rulesrv:rule:{ruleID}
```

**é‡è¦ç‰¹æ€§**ï¼š
- Hashç»“æ„æä¾›O(1)è®¿é—®æ€§èƒ½
- æ”¯æŒç™¾ä¸‡çº§ç‚¹ä½
- 6ä½å°æ•°ç²¾åº¦æ ‡å‡†åŒ–
- ç‚¹ä½IDä»1å¼€å§‹ï¼ˆä¸å†ä½¿ç”¨10001ç­‰åˆ†æ®µï¼‰

### Redis Functions (Luaè„šæœ¬)

VoltageEMSä½¿ç”¨Redis Functionsè¿›è¡Œé«˜æ€§èƒ½æ•°æ®å¤„ç†ï¼Œè„šæœ¬æŒ‰åŠŸèƒ½åˆ†å±‚ç»„ç»‡ï¼š

#### æ ¸å¿ƒå‡½æ•°åº“ (core.lua)
é€šç”¨çš„æ•°æ®å¤„ç†é€»è¾‘ï¼Œå 80%çš„åŠŸèƒ½ï¼š
- **generic_store**: é€šç”¨å®ä½“å­˜å‚¨ï¼Œæ”¯æŒå¤šç´¢å¼•
- **generic_batch_sync**: æ‰¹é‡æ•°æ®åŒæ­¥
- **generic_query**: çµæ´»çš„æŸ¥è¯¢åŠŸèƒ½
- **generic_state_machine**: çŠ¶æ€æœºç®¡ç†
- **generic_condition_eval**: æ¡ä»¶è¯„ä¼°å¼•æ“
- **generic_statistics**: ç»Ÿè®¡æ•°æ®æ”¶é›†

#### é¢†åŸŸå‡½æ•°åº“ (domain.lua)
ä¸šåŠ¡é¢†åŸŸç›¸å…³åŠŸèƒ½ï¼š
- **å‘Šè­¦ç®¡ç†**: store_alarm, acknowledge_alarm, resolve_alarm
- **è§„åˆ™å¼•æ“**: save_rule, delete_rule, save_rule_group
- **æ•°æ®åŒæ­¥**: sync_channel_data, sync_all_channels
- **è®¾å¤‡è®¡ç®—**: calculate_device_delta, set_thresholds

#### æœåŠ¡é€‚é…å±‚ (services.lua)
å„å¾®æœåŠ¡çš„ä¸“ç”¨å‡½æ•°ï¼š
- **hissrv**: å†å²æ•°æ®æ”¶é›†ã€InfluxDBè¡Œåè®®è½¬æ¢ã€æ‰¹é‡å¤„ç†
- **modsrv**: æµ‹ç‚¹æ˜ å°„åˆå§‹åŒ–ã€å®æ—¶åŒæ­¥ã€æ§åˆ¶ä¸‹å‘
- **rulesrv**: è§„åˆ™å­˜å‚¨ã€æŸ¥è¯¢ã€DAGæ‰§è¡Œ
- **netsrv**: æ•°æ®è½¬å‘ã€è·¯ç”±é…ç½®ã€é˜Ÿåˆ—ç®¡ç†
- **alarmsrv**: å‘Šè­¦å­˜å‚¨ï¼ˆä½¿ç”¨é€šç”¨å­˜å‚¨ï¼‰

#### ç‰¹æ®Šé€»è¾‘ (specific.lua)
æ— æ³•é€šç”¨åŒ–çš„ç‰¹å®šåŠŸèƒ½ï¼ˆ20%ï¼‰ï¼š
- **dag_executor**: DAGè§„åˆ™æ‰§è¡Œå™¨
- **line_protocol_converter**: InfluxDBè¡Œåè®®è½¬æ¢

#### åŠ è½½ä¸ä½¿ç”¨
```bash
# åŠ è½½æ‰€æœ‰Redis Functions
cd scripts/redis-functions
./load_all_functions.sh

# éªŒè¯å‡½æ•°åŠ è½½
./verify_functions.sh

# åœ¨æœåŠ¡ä¸­è°ƒç”¨ï¼ˆç¤ºä¾‹ï¼‰
redis-cli FCALL hissrv_collect_data 0 "comsrv:1001:m" "60"
```

Redis Functionsçš„ä¼˜åŠ¿ï¼š
- **åŸå­æ€§æ“ä½œ**: é¿å…ç«æ€æ¡ä»¶
- **å‡å°‘ç½‘ç»œå¼€é”€**: æ•°æ®å¤„ç†åœ¨Rediså†…éƒ¨å®Œæˆ
- **é«˜æ€§èƒ½**: é¿å…å¤šæ¬¡å¾€è¿”é€šä¿¡
- **ä»£ç å¤ç”¨**: 80%çš„é€»è¾‘é€šè¿‡é€šç”¨å‡½æ•°å®ç°

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚
- Docker & Docker Compose
- Rust 1.88+ (ä»…å¼€å‘éœ€è¦)
- Make (å¯é€‰ï¼Œç®€åŒ–å‘½ä»¤)

### ä½¿ç”¨ Docker Compose (æ¨è)

```bash
# 1. å…‹éš†ä»“åº“
git clone https://github.com/your-org/VoltageEMS.git
cd VoltageEMS

# 2. å¤åˆ¶ç¯å¢ƒé…ç½®
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶è®¾ç½®å¿…è¦çš„é…ç½®

# 3. å¯åŠ¨æ‰€æœ‰æœåŠ¡
make up
# æˆ–è€…
docker-compose up -d

# 4. æ£€æŸ¥æœåŠ¡çŠ¶æ€
make monitor
# æˆ–è€…
docker-compose ps
```

### æœ¬åœ°å¼€å‘

```bash
# 1. å¯åŠ¨åŸºç¡€è®¾æ–½
docker run -d --name redis-dev -p 6379:6379 redis:8-alpine
docker run -d --name influxdb-dev -p 8086:8086 influxdb:2.7-alpine

# 2. æŒ‰é¡ºåºå¯åŠ¨æœåŠ¡
cargo run -p comsrv      # å·¥ä¸šåè®®ç½‘å…³
cargo run -p modsrv      # è®¡ç®—å¼•æ“
cargo run -p hissrv      # å†å²æ•°æ®æœåŠ¡
cargo run -p alarmsrv    # å‘Šè­¦æœåŠ¡
cargo run -p rulesrv     # è§„åˆ™å¼•æ“
cargo run -p apigateway  # APIç½‘å…³
```

### å¼€å‘å‘½ä»¤

```bash
# æ£€æŸ¥ç¼–è¯‘ï¼ˆæ¨èï¼‰
cargo check --workspace

# æ ¼å¼åŒ–ä»£ç 
cargo fmt --all

# è¿è¡Œclippy
cargo clippy --all-targets --all-features -- -D warnings

# è¿è¡Œæµ‹è¯•
cargo test --workspace

# ç›‘æ§Redisæ•°æ®
redis-cli monitor | grep comsrv

# æŸ¥çœ‹Hashæ•°æ®
redis-cli hgetall "comsrv:1001:T"
```

## ğŸ“Š æ•°æ®æµ

### å®æ—¶æ•°æ®é‡‡é›†
```
è®¾å¤‡ â†’ comsrv â†’ Redis Hash â†’ Luaè„šæœ¬å¤„ç† â†’ modsrv/alarmsrv â†’ å‰ç«¯
```

### æ§åˆ¶å‘½ä»¤ä¸‹å‘
```
å‰ç«¯ â†’ API Gateway â†’ Redis Pub/Sub â†’ comsrv â†’ è®¾å¤‡
```

### å†å²æ•°æ®å­˜å‚¨
```
Redis â†’ hissrv â†’ InfluxDB â†’ æ—¶åºæŸ¥è¯¢API
```

## ğŸ”§ é…ç½®è¯´æ˜

### æœåŠ¡é…ç½®
æ¯ä¸ªæœåŠ¡éƒ½æœ‰ç‹¬ç«‹çš„é…ç½®æ–‡ä»¶ï¼š
```
services/{service}/config/default.yml
```

### ç‚¹ä½é…ç½®
ä½¿ç”¨CSVæ–‡ä»¶é…ç½®ç‚¹ä½æ˜ å°„ï¼š
```
services/comsrv/config/{Protocol}_CH{ChannelID}/
â”œâ”€â”€ measurement.csv    # é¥æµ‹ç‚¹
â”œâ”€â”€ signal.csv        # é¥ä¿¡ç‚¹
â”œâ”€â”€ control.csv       # é¥æ§ç‚¹
â””â”€â”€ adjustment.csv    # é¥è°ƒç‚¹
```

### ç¯å¢ƒå˜é‡
```bash
RUST_LOG=debug         # æ—¥å¿—çº§åˆ«
REDIS_URL=redis://localhost:6379
INFLUXDB_URL=http://localhost:8086
```

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

- JWT Tokenè®¤è¯
- Redis ACLæƒé™éš”ç¦»
- HTTPS/TLSæ”¯æŒ
- æ•æ„Ÿä¿¡æ¯ç¯å¢ƒå˜é‡ç®¡ç†

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

- Hashå­˜å‚¨ç»“æ„ï¼ŒO(1)è®¿é—®
- Luaè„šæœ¬æ‰¹é‡å¤„ç†
- è¿æ¥æ± å¤ç”¨
- å¼‚æ­¥I/Oå¤„ç†
- 6ä½å°æ•°ç²¾åº¦æ ‡å‡†åŒ–

## ğŸ”§ å¼€å‘å·¥å…·ä¸ä»£ç è´¨é‡

### Git Hooks é…ç½®
é¡¹ç›®åŒ…å«é¢„é…ç½®çš„ Git hooks æ¥ç¡®ä¿ä»£ç è´¨é‡ï¼š

```bash
# é…ç½® Git hooks
./scripts/setup-hooks.sh

# å¯ç”¨çš„ hooks:
# - pre-commit: è¿è¡Œæ ¼å¼åŒ–ã€clippy å’Œæµ‹è¯•
# - pre-push: è¿è¡Œä¸¥æ ¼æ£€æŸ¥å’Œå®‰å…¨å®¡è®¡  
# - commit-msg: éªŒè¯æäº¤ä¿¡æ¯æ ¼å¼
```

### æ¨èå®‰è£…çš„å·¥å…·
```bash
# å®‰å…¨æ¼æ´æ‰«æ
cargo install cargo-audit

# æŸ¥æ‰¾æœªä½¿ç”¨çš„ä¾èµ–
cargo install cargo-udeps

# æ£€æŸ¥è¿‡æ—¶çš„ä¾èµ–
cargo install cargo-outdated

# ä»£ç è¦†ç›–ç‡
cargo install cargo-tarpaulin
```

### Cargo åˆ«å
```bash
cargo check-all      # æ£€æŸ¥æ‰€æœ‰ç›®æ ‡
cargo test-all       # è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo clippy-strict  # ä¸¥æ ¼çš„ clippy æ£€æŸ¥
cargo fix-all        # ä¿®å¤æ‰€æœ‰å¯è‡ªåŠ¨ä¿®å¤çš„é—®é¢˜
```

## ğŸš¢ CI/CD æµç¨‹

é¡¹ç›®ä½¿ç”¨ GitHub Actions å®ç°å®Œæ•´çš„ CI/CD æµç¨‹ï¼š

### è‡ªåŠ¨åŒ–æµç¨‹
- **ä»£ç è´¨é‡æ£€æŸ¥**: æ¯æ¬¡æ¨é€è‡ªåŠ¨è¿è¡Œæ ¼å¼åŒ–å’Œ lint æ£€æŸ¥
- **å•å…ƒæµ‹è¯•**: å¹¶è¡Œè¿è¡Œæ‰€æœ‰æœåŠ¡çš„æµ‹è¯•
- **Docker æ„å»º**: è‡ªåŠ¨æ„å»ºå¹¶æ¨é€é•œåƒåˆ° GitHub Container Registry
- **é›†æˆæµ‹è¯•**: ä½¿ç”¨ docker-compose å¯åŠ¨å®Œæ•´ç³»ç»Ÿè¿›è¡Œæµ‹è¯•
- **è‡ªåŠ¨éƒ¨ç½²**: 
  - `develop` åˆ†æ”¯è‡ªåŠ¨éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
  - åˆ›å»º release æ—¶è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ

### æ‰‹åŠ¨éƒ¨ç½²
```bash
# éƒ¨ç½²åˆ°æµ‹è¯•ç¯å¢ƒ
make deploy-staging

# éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
make deploy-prod
```

è¯¦ç»†çš„ CI/CD é…ç½®è¯´æ˜è¯·å‚è€ƒ [CI/CD Setup Guide](docs/ci-cd-setup.md)

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Forké¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨MITè®¸å¯è¯ - æŸ¥çœ‹ [LICENSE](LICENSE) æ–‡ä»¶äº†è§£è¯¦æƒ…