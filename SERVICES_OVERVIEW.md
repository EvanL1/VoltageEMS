# VoltageEMS 服务功能概览

## 项目概述

VoltageEMS是一个基于Rust构建的微服务架构工业物联网能源管理系统，专注于工业设备通信、数据处理和能源管理。系统采用Redis为中心的数据总线架构，支持多种工业协议，具有高性能、高可靠性和易扩展的特点。

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Web Application                        │
│            Web UI | Mobile App │ HMI/SCADA                  │
└─────────────────────┬───────────────────────────────────────┘
                          │
                   ┌──────┴──────┐
                   │ API Gateway │
                   └──────┬──────┘
                          │
┌─────────────────────────┴───────────────────────────────────┐
│                    Redis Message                            │
│              Pub/Sub | Key-Value | Streams                  │
└──┬──────────┬────────┬─────────┬──────────┬──────────┬──────┘
   │          │        │         │          │          │
┌──┴───┐  ┌───┴──┐  ┌──┴───┐  ┌──┴───┐  ┌───┴────┐  ┌──┴──┐
│comsrv│  │modsrv│  │hissrv│  │netsrv│  │alarmsrv│  │ ... │
└──┬───┘  └──────┘  └──────┘  └──────┘  └────────┘  └─────┘
   │
┌──┴──────────────────────────────┐
│            Devices              │
│   Modbus | IEC60870 | CAN | ... │
└─────────────────────────────────┘
```

## 核心服务

### 1. **comsrv** - 工业协议通信网关
**核心功能**: 作为工业协议网关，负责与各种工业设备进行通信，支持多协议接入和数据采集。

**主要特性**:
- 支持Modbus TCP/RTU、IEC60870-5-104、CAN等多种工业协议
- 插件化架构，支持协议扩展和自定义传输层
- 扁平化Redis存储架构，采用`{channelID}:{type}:{pointID}`键值格式
- 异步启动架构，支持超时处理和错误恢复

**支持的协议**: Modbus TCP/RTU、IEC60870-5-104、CAN、GPIO、I2C、SPI  
**配置方式**: YAML配置文件 + CSV点表配置，支持通道级别配置  
**依赖关系**: 发布遥测数据到Redis，订阅Redis控制命令

### 2. **modsrv** - 物模型和计算引擎
**核心功能**: 设备物模型管理和实时计算引擎，处理设备数据建模、验证和复杂计算。

**主要特性**:
- 完整的设备物模型定义系统（属性、遥测、命令、事件）
- 内置计算引擎，支持sum、avg、min、max、scale等函数
- 实时数据流处理，支持自动计算触发
- DAG计算工作流，支持复杂的数据处理链

**支持的协议**: REST API，支持设备模型CRUD操作  
**配置方式**: 配置中心、本地文件、环境变量多种配置源  
**依赖关系**: 订阅Redis遥测数据，执行计算后发布结果

### 3. **rulesrv** - DAG规则引擎
**核心功能**: 基于有向无环图(DAG)的规则引擎，执行复杂的业务逻辑和自动化控制策略。

**主要特性**:
- JSON格式定义DAG规则，支持复杂条件和动作链
- 可插拔的动作处理器，支持设备控制和外部系统调用
- 实时规则执行监控和状态管理
- 支持规则的动态加载和热更新

**支持的协议**: REST API，支持规则管理和执行监控  
**配置方式**: JSON规则文件，支持动态配置更新  
**依赖关系**: 订阅modsrv计算结果，执行规则后可触发设备控制

### 4. **hissrv** - 历史数据服务
**核心功能**: 历史数据存储和管理，将实时数据持久化到时序数据库并提供查询服务。

**主要特性**:
- 支持InfluxDB等多种时序数据库后端
- 批量写入优化，提高存储性能
- 数据保留策略管理，自动清理过期数据
- 查询优化和聚合功能

**支持的协议**: InfluxDB、Redis存储接口，REST API查询  
**配置方式**: 存储后端配置、批量写入参数、保留策略设置  
**依赖关系**: 订阅Redis实时数据，写入InfluxDB等时序数据库

### 5. **netsrv** - 网络服务
**核心功能**: 云端数据转发服务，将本地数据推送到外部云服务和第三方系统。

**主要特性**:
- 支持MQTT、HTTP等多种网络协议
- 可配置的数据格式转换和过滤
- 云端连接状态监控和重连机制
- 支持AWS IoT、阿里云等主流云平台

**支持的协议**: MQTT、HTTP、云端API接口  
**配置方式**: 多网络目标配置、数据格式配置、连接参数  
**依赖关系**: 从Redis获取数据，推送到外部云服务

### 6. **alarmsrv** - 告警服务
**核心功能**: 实时告警检测和管理，监控系统状态并生成分级告警。

**主要特性**:
- 规则引擎驱动的告警检测
- 告警分类、优先级和生命周期管理
- 支持多种告警通知方式
- 告警历史记录和统计分析

**支持的协议**: REST API，支持告警查询和管理  
**配置方式**: 告警规则配置、监控范围和通知策略  
**依赖关系**: 扫描Redis数据，基于规则生成告警

### 7. **apigateway** - API网关
**核心功能**: 统一API入口，提供身份认证、请求路由和实时数据WebSocket接口。

**主要特性**:
- JWT认证和基于角色的访问控制
- 微服务路由和负载均衡
- 实时数据WebSocket推送
- API限流和监控

**支持的协议**: HTTP REST API、WebSocket  
**配置方式**: 路由配置、认证配置、服务发现  
**依赖关系**: 作为前端网关，代理访问所有后端服务

## 系统特点

### 数据架构
- **Redis中心化**: 所有服务通过Redis进行数据交换和通信
- **扁平化存储**: 使用`{channelID}:{type}:{pointID}`格式实现O(1)查询性能
- **事件驱动**: 基于Redis pub/sub的异步事件驱动架构

### 技术特性
- **高性能**: Rust语言实现，内存安全和零成本抽象
- **模块化设计**: 微服务架构，服务间松耦合，可独立部署
- **可扩展性**: 插件化协议支持，易于扩展新的工业协议
- **高可用性**: 异步处理、超时机制和错误恢复

### 配置管理
- **统一配置**: 支持配置中心和动态配置更新
- **多源配置**: 支持环境变量、配置文件、配置中心
- **热更新**: 支持运行时配置更新，无需重启服务

### 监控体系
- **完整日志**: 结构化日志，支持分级和轮转
- **性能监控**: 集成Prometheus指标收集
- **告警管理**: 实时告警检测和通知

## 快速开始

### 环境要求
- Rust 1.70+
- Redis 6.0+
- Docker (可选)

### 构建运行
```bash
# 编译整个workspace
cargo build --workspace

# 运行单个服务
cd services/comsrv
cargo run

# 使用Docker运行
docker-compose up -d
```

### 配置说明
1. **Redis配置**: 所有服务需要连接到Redis实例
2. **服务配置**: 每个服务有独立的配置文件
3. **协议配置**: comsrv需要配置设备连接和点表

## 开发指南

### 添加新协议
1. 在`services/comsrv/src/plugins/protocols/`创建新协议目录
2. 实现`ProtocolPlugin` trait
3. 在插件注册表中注册新协议

### 添加新服务
1. 在`services/`目录创建新服务
2. 添加到workspace的`Cargo.toml`
3. 实现与Redis的数据交互

### 测试
```bash
# 运行所有测试
cargo test --workspace

# 运行特定服务测试
cargo test -p comsrv
```

## 版本信息

- 当前版本: 1.0.0
- Rust版本: 1.70+
- 协议支持: Modbus TCP/RTU, IEC60870-5-104, CAN
- 数据库: Redis 6.0+, InfluxDB 2.0+

---

*本文档由VoltageEMS项目团队维护，最后更新时间: 2025-07-18*