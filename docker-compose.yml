services:
  # Redis - High-performance data store (official Redis 8)
  voltage-redis:
    image: redis:8-alpine
    container_name: voltage-redis
    network_mode: host
    labels:
      - "voltageems.role=infrastructure"
      - "voltageems.protected=true"
      - "voltageems.description=Redis data store - avoid unnecessary restarts"
    volumes:
      - redis-data:/data
      - redis-socket:/run/redis:rw # Unix socket directory for better performance
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes", "--save", "60", "1"]
    environment:
      - NO_PROXY="*"
      - no_proxy="*"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Communication service with full hardware access (Linux production)
  comsrv:
    image: voltageems:latest
    container_name: voltageems-comsrv
    command: ["comsrv"]
    network_mode: host
    privileged: true # Full privileged mode for device access
    # Complete /dev access for all industrial devices (serial, CAN, GPIO, I2C, SPI, etc.)
    volumes:
      - /dev:/dev:rw # Mount entire /dev directory with read-write access
      - ${VOLTAGE_BASE_PATH:-./data}/config/comsrv:/app/config/comsrv:ro
      - ${VOLTAGE_BASE_PATH:-./data}:/app/data:rw
      - ${VOLTAGE_LOG_PATH:-./logs}:/app/logs
      - redis-socket:/run/redis:ro
      - voltage-shm:/shm/rtdb:rw  # Shared memory (writer - Round 118)
    environment:
      - SERVICE_NAME=comsrv
      - SERVICE_PORT=6001
      - RUST_LOG=${RUST_LOG:-info}
      - REDIS_URL=${REDIS_URL:-redis://127.0.0.1:6379}
      - VOLTAGE_DB_PATH=/app/data/voltage.db
      - CSV_BASE_PATH=/app/config/comsrv
      - CONFIG_BASE_PATH=/app/config/comsrv
      - VOLTAGE_LOG_DIR=/app/logs
      - ENABLE_SHARED_MEMORY=${ENABLE_SHARED_MEMORY:-true}  # Round 118: zero-copy data sharing
      - NO_PROXY="*"
      - no_proxy="*"
    depends_on:
      voltage-redis:
        condition: service_healthy
    restart: unless-stopped

  # Model service (includes rules engine on port 6002)
  modsrv:
    image: voltageems:latest
    container_name: voltageems-modsrv
    command: ["modsrv"]
    network_mode: host
    environment:
      - SERVICE_NAME=modsrv
      - SERVICE_PORT=6002
      - RUST_LOG=${RUST_LOG:-info}
      - REDIS_URL=${REDIS_URL:-redis://127.0.0.1:6379}
      - VOLTAGE_DB_PATH=/app/data/voltage.db
      - VOLTAGE_LOG_DIR=/app/logs
      - ENABLE_SHARED_MEMORY=${ENABLE_SHARED_MEMORY:-true}  # Round 118: zero-copy data sharing
      - NO_PROXY="*"
      - no_proxy="*"
    depends_on:
      voltage-redis:
        condition: service_healthy
    volumes:
      - ${VOLTAGE_BASE_PATH:-./data}/config:/app/config:ro
      - ${VOLTAGE_BASE_PATH:-./data}:/app/data:rw
      - ${VOLTAGE_LOG_PATH:-./logs}:/app/logs
      - redis-socket:/run/redis:ro # Read-only access to Unix socket
      - voltage-shm:/shm/rtdb:ro  # Shared memory (reader - Round 118)
    restart: unless-stopped

  # ============================================
  # Python 辅助服务
  # ============================================

  # InfluxDB - 时序数据库 (hissrv 依赖)
  influxdb:
    image: influxdb:2-alpine
    container_name: voltage-influxdb
    network_mode: host
    labels:
      - "voltageems.role=infrastructure"
      - "voltageems.protected=true"
      - "voltageems.description=InfluxDB time-series database"
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_USERNAME:-admin}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD:-voltage123}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG:-voltage}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET:-history}
      - NO_PROXY="*"
      - no_proxy="*"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # History Service - 历史数据存储 (端口 6004)
  hissrv:
    image: voltageems-ss:latest
    container_name: voltageems-hissrv
    network_mode: host
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    environment:
      - SERVICE_NAME=hissrv
      - SERVICE_PORT=6004
      - INFLUXDB_URL=${INFLUXDB_URL:-http://127.0.0.1:8086}
      - INFLUXDB_ORG=${INFLUXDB_ORG:-voltage}
      - INFLUXDB_BUCKET=${INFLUXDB_BUCKET:-history}
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-}
      - REDIS_URL=${REDIS_URL:-redis://127.0.0.1:6379}
      - LOG_DIR=/app/logs
      - NO_PROXY="*"
      - no_proxy="*"
    volumes:
      - ${VOLTAGE_BASE_PATH:-./data}/config/hissrv:/app/config
      - ${VOLTAGE_LOG_PATH:-./logs}:/app/logs
    depends_on:
      voltage-redis:
        condition: service_healthy
      influxdb:
        condition: service_healthy
    restart: unless-stopped

  # API Gateway - API 网关、WebSocket、认证 (端口 6005)
  apigateway:
    image: voltageems-ss:latest
    container_name: voltageems-apigateway
    network_mode: host
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    environment:
      - SERVICE_NAME=apigateway
      - SERVICE_PORT=6005
      - REDIS_URL=${REDIS_URL:-redis://127.0.0.1:6379}
      - COMSRV_URL=${COMSRV_URL:-http://127.0.0.1:6001}
      - MODSRV_URL=${MODSRV_URL:-http://127.0.0.1:6002}
      - VOLTAGE_DB_PATH=/app/data/voltage.db
      - LOG_DIR=/app/logs
      - NO_PROXY="*"
      - no_proxy="*"
    volumes:
      - ${VOLTAGE_BASE_PATH:-./data}/config/apigateway:/app/config
      - ${VOLTAGE_BASE_PATH:-./data}/data:/app/data:rw
      - ${VOLTAGE_LOG_PATH:-./logs}:/app/logs
    depends_on:
      voltage-redis:
        condition: service_healthy
    restart: unless-stopped

  # Network Service - 网络通讯服务 MQTT (端口 6006)
  netsrv:
    image: voltageems-ss:latest
    container_name: voltageems-netsrv
    network_mode: host
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    environment:
      - SERVICE_NAME=netsrv
      - SERVICE_PORT=6006
      - REDIS_URL=${REDIS_URL:-redis://127.0.0.1:6379}
      - LOG_DIR=/app/logs
      - NO_PROXY="*"
      - no_proxy="*"
    volumes:
      - ${VOLTAGE_BASE_PATH:-./data}/config/netsrv:/app/config
      - ${VOLTAGE_LOG_PATH:-./logs}:/app/logs
    depends_on:
      voltage-redis:
        condition: service_healthy
    restart: unless-stopped

  # Alarm Service - 告警管理服务 (端口 6007)
  alarmsrv:
    image: voltageems-ss:latest
    container_name: voltageems-alarmsrv
    network_mode: host
    user: "${HOST_UID:-1000}:${HOST_GID:-1000}"
    environment:
      - SERVICE_NAME=alarmsrv
      - SERVICE_PORT=6007
      - REDIS_URL=${REDIS_URL:-redis://127.0.0.1:6379}
      - VOLTAGE_DB_PATH=/app/data/voltage.db
      - LOG_DIR=/app/logs
      - NO_PROXY="*"
      - no_proxy="*"
    volumes:
      - ${VOLTAGE_BASE_PATH:-./data}/config/alarmsrv:/app/config
      - ${VOLTAGE_BASE_PATH:-./data}/data:/app/data:rw
      - ${VOLTAGE_LOG_PATH:-./logs}:/app/logs
    depends_on:
      voltage-redis:
        condition: service_healthy
    restart: unless-stopped

  # ============================================
  # 前端应用
  # ============================================

  # Vue.js Frontend - Web 管理界面 (端口 8080)
  apps:
    image: voltage-apps:latest
    container_name: voltage-apps
    network_mode: host
    labels:
      - "voltageems.role=frontend"
      - "voltageems.description=Vue.js web management interface"
    depends_on:
      - apigateway
    restart: unless-stopped

volumes:
  redis-data:
  redis-socket: # Shared Unix socket volume for better performance
  influxdb-data:
  influxdb-config:
  # Shared memory volume for zero-copy data sharing between comsrv and modsrv (Round 118)
  voltage-shm:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs
      o: size=16m,mode=1777
