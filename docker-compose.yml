version: '3.8'

services:
  # Redis with functions
  redis:
    image: voltageems-redis:latest
    build:
      context: .
      dockerfile: docker/redis/Dockerfile
    container_name: voltageems-redis
    ports:
      - "6379:6379"
    environment:
      - NO_PROXY="*"
      - no_proxy="*"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # InfluxDB时序数据库
  influxdb:
    image: influxdb:2.7-alpine
    container_name: voltageems-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=password123
      - DOCKER_INFLUXDB_INIT_ORG=voltageems
      - DOCKER_INFLUXDB_INIT_BUCKET=ems_data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=mytoken
      - NO_PROXY="*"
      - no_proxy="*"
    volumes:
      - influxdb-storage:/var/lib/influxdb2

  # Modbus模拟器
  modbus-simulator:
    image: voltageems-modbus-sim:latest
    build:
      context: .
      dockerfile: docker/modbus-sim/Dockerfile
    container_name: voltageems-modbus-sim
    ports:
      - "5020:502"
    environment:
      - NO_PROXY="*"
      - no_proxy="*"

  # Optional: Log Management Service (runs cleanup daily)
  log-manager:
    image: python:3.11-slim
    container_name: voltageems-log-manager
    volumes:
      - ./logs:/app/logs
      - ./scripts:/app/scripts
    working_dir: /app
    command: >
      sh -c "while true; do
        if [ -f /app/scripts/manage-logs.py ]; then
          python /app/scripts/manage-logs.py clean --days 30;
        fi;
        sleep 86400;
      done"
    restart: unless-stopped

  # API Gateway - 专注于数据聚合和业务逻辑
  apigateway:
    image: voltageems-apigateway:latest
    build:
      context: .
      dockerfile: services/apigateway/Dockerfile
    container_name: voltageems-apigateway
    ports:
      - "6005:6005"
    environment:
      - RUST_LOG=debug,apigateway=trace
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your-secret-key-change-in-production
      - NO_PROXY="*"
      - no_proxy="*"
    depends_on:
      - redis
    volumes:
      - ./config/apigateway:/app/config:ro
      - ./logs/apigateway:/app/logs

  # 通信服务
  comsrv:
    image: voltageems-comsrv:latest
    build:
      context: .
      dockerfile: services/comsrv/Dockerfile
    container_name: voltageems-comsrv
    ports:
      - "6000:6000"
    environment:
      - RUST_LOG=debug
      - REDIS_URL=redis://redis:6379
      - CSV_BASE_PATH=/app/config
      - NO_PROXY="*"
      - no_proxy="*"
    depends_on:
      - redis
    volumes:
      - ./config/comsrv:/app/config:ro
      - ./logs/comsrv:/app/logs
    command: ["/app/comsrv", "-c", "/app/config/comsrv.yaml"]

  # 模型服务
  modsrv:
    image: voltageems-modsrv:latest
    build:
      context: .
      dockerfile: services/modsrv/Dockerfile
    container_name: voltageems-modsrv
    ports:
      - "6001:6001"
    environment:
      - RUST_LOG=info,modsrv=debug
      - REDIS_URL=redis://redis:6379
      - NO_PROXY="*"
      - no_proxy="*"
    depends_on:
      - redis
    volumes:
      - ./config/modsrv:/app/config:ro
      - ./logs/modsrv:/app/logs

  # 历史服务
  hissrv:
    image: voltageems-hissrv:latest
    build:
      context: .
      dockerfile: services/hissrv/Dockerfile
    container_name: voltageems-hissrv
    ports:
      - "6004:6004"
    environment:
      - RUST_LOG=info,hissrv=debug
      - REDIS_URL=redis://redis:6379
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=mytoken
      - INFLUXDB_ORG=voltageems
      - INFLUXDB_BUCKET=ems_data
      - NO_PROXY="*"
      - no_proxy="*"
    depends_on:
      - redis
      - influxdb
    volumes:
      - ./config/hissrv:/app/config:ro
      - ./logs/hissrv:/app/logs

  # 告警服务
  alarmsrv:
    image: voltageems-alarmsrv:latest
    build:
      context: .
      dockerfile: services/alarmsrv/Dockerfile
    container_name: voltageems-alarmsrv
    ports:
      - "6002:6002"
    environment:
      - RUST_LOG=info,alarmsrv=debug
      - REDIS_URL=redis://redis:6379
      - NO_PROXY="*"
      - no_proxy="*"
    depends_on:
      - redis
    volumes:
      - ./config/alarmsrv:/app/config:ro
      - ./logs/alarmsrv:/app/logs

  # 规则引擎服务
  rulesrv:
    image: voltageems-rulesrv:latest
    build:
      context: .
      dockerfile: services/rulesrv/Dockerfile
    container_name: voltageems-rulesrv
    ports:
      - "6003:6003"
    environment:
      - RUST_LOG=info,rulesrv=debug
      - REDIS_URL=redis://redis:6379
      - NO_PROXY="*"
      - no_proxy="*"
    depends_on:
      - redis
    volumes:
      - ./config/rulesrv:/app/config:ro
      - ./logs/rulesrv:/app/logs

volumes:
  redis-data:
  influxdb-storage:
