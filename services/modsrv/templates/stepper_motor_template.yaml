id: "stepper_motor_template"
name: "Stepper Motor Template"
description: "Real-time monitoring and control model for stepper motors"
file_path: "templates/stepper_motor_template.yaml"
version: "2.0.0"

# 与comsrv兼容的通道配置
channel_config:
  channel_id: 1001
  protocol: "modbus_tcp"
  description: "Stepper Motor Control Channel"

# 设备属性定义
properties:
  - name: "motor_type"
    description: "Motor type and model"
    data_type: "string"
    default_value: "NEMA23"
  - name: "max_speed"
    description: "Maximum speed in RPM"
    data_type: "float"
    default_value: 3000.0
  - name: "max_torque"
    description: "Maximum torque in Nm"
    data_type: "float"
    default_value: 2.5

# 遥测数据定义（对应comsrv的测量点）
telemetry:
  - name: "current_position"
    description: "Current position in steps"
    data_type: "float"
    unit: "steps"
    redis_key: "1001:m:10001"
    point_type: "m"
    point_id: 10001
  - name: "current_speed"
    description: "Current speed in RPM"
    data_type: "float"
    unit: "RPM"
    redis_key: "1001:m:10002"
    point_type: "m"
    point_id: 10002
  - name: "current_torque"
    description: "Current torque in Nm"
    data_type: "float"
    unit: "Nm"
    redis_key: "1001:m:10003"
    point_type: "m"
    point_id: 10003
  - name: "motor_temperature"
    description: "Motor temperature in Celsius"
    data_type: "float"
    unit: "°C"
    redis_key: "1001:m:10004"
    point_type: "m"
    point_id: 10004
  - name: "motor_status"
    description: "Motor status (0=stopped, 1=running, 2=fault)"
    data_type: "int"
    redis_key: "1001:s:20001"
    point_type: "s"
    point_id: 20001
  - name: "emergency_stop"
    description: "Emergency stop status (0=normal, 1=emergency)"
    data_type: "int"
    redis_key: "1001:s:20002"
    point_type: "s"
    point_id: 20002

# 控制命令定义（对应comsrv的控制点）
commands:
  - name: "start_motor"
    description: "Start the stepper motor"
    redis_key: "1001:c:30001"
    point_type: "c"
    point_id: 30001
    parameters:
      - name: "initial_speed"
        description: "Initial speed in RPM"
        data_type: "float"
        default_value: 60.0
        min_value: 0.0
        max_value: 3000.0
  
  - name: "stop_motor"
    description: "Stop the stepper motor"
    redis_key: "1001:c:30001"
    point_type: "c"
    point_id: 30001
    parameters:
      - name: "deceleration"
        description: "Deceleration rate"
        data_type: "float"
        default_value: 15.0
        min_value: 1.0
        max_value: 100.0
  
  - name: "change_speed"
    description: "Change the motor speed"
    redis_key: "1001:a:30002"
    point_type: "a"
    point_id: 30002
    parameters:
      - name: "target_speed"
        description: "Target speed in RPM"
        data_type: "float"
        required: true
        min_value: 0.0
        max_value: 3000.0

  - name: "set_position"
    description: "Set target position"
    redis_key: "1001:a:30003"
    point_type: "a"
    point_id: 30003
    parameters:
      - name: "target_position"
        description: "Target position in steps"
        data_type: "float"
        required: true
        min_value: -1000000.0
        max_value: 1000000.0

# 计算规则定义
calculations:
  - name: "motor_efficiency"
    description: "Calculate motor efficiency"
    inputs:
      - "current_torque"
      - "current_speed"
    outputs:
      - name: "efficiency"
        data_type: "float"
        unit: "%"
    expression: "min(100.0, (current_torque * current_speed * 0.1047) / 2.5 * 100.0)"

  - name: "power_consumption"
    description: "Calculate power consumption"
    inputs:
      - "current_torque"
      - "current_speed"
    outputs:
      - name: "power"
        data_type: "float"
        unit: "W"
    expression: "current_torque * current_speed * 0.1047"

# 事件定义
events:
  - name: "motor_fault"
    description: "Motor fault detected"
    type: "alarm"
    priority: "high"
    conditions:
      - field: "motor_status"
        operator: "equals"
        value: 2
  
  - name: "temperature_warning"
    description: "Motor temperature too high"
    type: "warning"
    priority: "medium"
    conditions:
      - field: "motor_temperature"
        operator: "greater_than"
        value: 80.0

  - name: "emergency_stop_activated"
    description: "Emergency stop activated"
    type: "alarm"
    priority: "critical"
    conditions:
      - field: "emergency_stop"
        operator: "equals"
        value: 1

# 实例配置示例
instance_config:
  default_properties:
    motor_type: "NEMA23"
    max_speed: 3000.0
    max_torque: 2.5
  
  point_mappings:
    current_position: "1001:m:10001"
    current_speed: "1001:m:10002"
    current_torque: "1001:m:10003"
    motor_temperature: "1001:m:10004"
    motor_status: "1001:s:20001"
    emergency_stop: "1001:s:20002"
  
  command_mappings:
    start_motor:
      channel_id: 1001
      point_type: "c"
      point_id: 30001
    stop_motor:
      channel_id: 1001
      point_type: "c"
      point_id: 30001
    change_speed:
      channel_id: 1001
      point_type: "a"
      point_id: 30002
    set_position:
      channel_id: 1001
      point_type: "a"
      point_id: 30003

# 模板元数据
metadata:
  manufacturer: "Generic"
  model_number: "STEP-001"
  protocol_version: "1.0"
  author: "VoltageEMS"
  created_at: "2025-07-16T14:45:00Z"
  updated_at: "2025-07-16T14:45:00Z"
  tags: ["stepper", "motor", "control", "automation"]
