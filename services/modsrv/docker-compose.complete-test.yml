version: '3.8'

services:
  # Redis 8 æœåŠ¡ - å®Œå…¨å†…éƒ¨ç½‘ç»œ
  redis:
    image: redis:8-alpine
    container_name: modsrv-complete-redis
    volumes:
      - redis-data:/data
      - ./logs:/logs
    command: redis-server --appendonly yes --appendfsync everysec --loglevel notice --logfile /logs/redis.log
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 5s
    networks:
      - complete-test-net
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ComsRv æ•°æ®æ¨¡æ‹Ÿå™¨ - ç”Ÿæˆç¬¦åˆv3.2è§„èŒƒçš„æµ‹è¯•æ•°æ®
  comsrv-simulator:
    build: 
      context: ./docker/comsrv-simulator
      dockerfile: Dockerfile
    container_name: modsrv-complete-comsrv-simulator
    depends_on:
      redis:
        condition: service_healthy
    environment:
      - REDIS_URL=redis://redis:6379
      - LOG_LEVEL=INFO
      - SIMULATOR_LOG_FILE=/logs/comsrv-simulator.log
    volumes:
      - ./logs:/logs
    networks:
      - complete-test-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import redis; redis.from_url('redis://redis:6379').ping()"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ModSrv æœåŠ¡ - è®¾å¤‡æ¨¡å‹å¼•æ“
  modsrv:
    build:
      context: ../..
      dockerfile: services/modsrv/Dockerfile
    container_name: modsrv-complete-service
    depends_on:
      redis:
        condition: service_healthy
      comsrv-simulator:
        condition: service_healthy
    environment:
      - RUST_LOG=info,modsrv=debug
      - MODSRV_CONFIG_FILE=/config/config.yml
      - MODSRV_REDIS_URL=redis://redis:6379
      - REDIS_URL=redis://redis:6379
      - MODSRV_LOG_DIR=/logs
      - MODSRV_LOG_FILE=/logs/modsrv.log
    volumes:
      # ä¸»ç¨‹åºé…ç½®æ–‡ä»¶æ˜ å°„åˆ°æœ¬åœ° (è¯»å†™)
      - ./test-configs:/config
      # ä¸»ç¨‹åºæ—¥å¿—ç›®å½•æ˜ å°„åˆ°æœ¬åœ° (è¯»å†™)
      - ./logs:/logs
      # æ•°æ®ç›®å½•æ˜ å°„åˆ°æœ¬åœ° (è¯»å†™)
      - ./data:/data
      # æ¨¡æ¿æ–‡ä»¶æ˜ å°„åˆ°æœ¬åœ° (è¯»å†™)
      - ./templates:/templates
    command: ["/entrypoint.sh", "modsrv", "service"]
    networks:
      - complete-test-net
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8092/health"]
      interval: 15s
      timeout: 10s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # å®Œæ•´æµ‹è¯•å¥—ä»¶æ‰§è¡Œå™¨
  test-executor:
    image: alpine:3.18
    container_name: modsrv-complete-test-executor
    depends_on:
      modsrv:
        condition: service_healthy
      comsrv-simulator:
        condition: service_healthy
    volumes:
      - ./test-plan:/test-plan:ro
      - ./test-reports:/test-reports
      - ./scripts:/scripts:ro
      - ./logs:/logs
    networks:
      - complete-test-net
    working_dir: /workspace
    environment:
      - TEST_ENVIRONMENT=complete
      - TEST_LOG_LEVEL=DEBUG
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - MODSRV_HOST=modsrv
      - MODSRV_PORT=8092
    entrypoint: /bin/sh
    command: ["-c", "
      apk add --no-cache bash curl jq redis python3 py3-pip bc &&
      pip3 install redis requests &&
      echo 'ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•å¥—ä»¶...' &&
      mkdir -p /test-reports /logs/tests &&
      /scripts/run-complete-integration-tests.sh 2>&1 | tee /logs/tests/complete-test-$(date +%Y%m%d_%H%M%S).log &&
      echo 'ğŸ“‹ æµ‹è¯•å®Œæˆï¼Œæ—¥å¿—å·²ä¿å­˜åˆ° /logs/tests/' &&
      tail -f /dev/null
    "]
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # æ—¥å¿—æ”¶é›†å’Œç›‘æ§æœåŠ¡
  log-monitor:
    image: alpine:3.18
    container_name: modsrv-complete-log-monitor
    depends_on:
      - redis
      - comsrv-simulator
      - modsrv
    volumes:
      - ./logs:/logs
      - ./test-reports:/test-reports
    networks:
      - complete-test-net
    environment:
      - MONITOR_INTERVAL=30
    command: ["/bin/sh", "-c", "
      apk add --no-cache bash jq redis &&
      echo 'ğŸ“Š å¯åŠ¨æ—¥å¿—ç›‘æ§æœåŠ¡...' &&
      mkdir -p /logs/monitoring &&
      while true; do
        timestamp=$(date '+%Y-%m-%d %H:%M:%S');
        echo \"[$timestamp] === ç³»ç»ŸçŠ¶æ€ç›‘æ§ ===\" >> /logs/monitoring/system-monitor.log;
        echo \"RedisçŠ¶æ€:\" >> /logs/monitoring/system-monitor.log;
        redis-cli -h redis -p 6379 info stats | head -10 >> /logs/monitoring/system-monitor.log 2>/dev/null || echo 'Redisè¿æ¥å¤±è´¥' >> /logs/monitoring/system-monitor.log;
        echo \"Redisé”®ç»Ÿè®¡:\" >> /logs/monitoring/system-monitor.log;
        redis-cli -h redis -p 6379 info keyspace >> /logs/monitoring/system-monitor.log 2>/dev/null || echo 'Redisé”®æŸ¥è¯¢å¤±è´¥' >> /logs/monitoring/system-monitor.log;
        echo \"ComsRvæ•°æ®ç»Ÿè®¡:\" >> /logs/monitoring/system-monitor.log;
        redis-cli -h redis -p 6379 keys 'comsrv:*' | wc -l | xargs echo 'ComsRvé€šé“æ•°:' >> /logs/monitoring/system-monitor.log 2>/dev/null;
        echo \"ModSrvæ•°æ®ç»Ÿè®¡:\" >> /logs/monitoring/system-monitor.log;
        redis-cli -h redis -p 6379 keys 'modsrv:*' | wc -l | xargs echo 'ModSrvé”®æ•°:' >> /logs/monitoring/system-monitor.log 2>/dev/null;
        echo \"\" >> /logs/monitoring/system-monitor.log;
        sleep $$MONITOR_INTERVAL;
      done
    "]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # æ•°æ®éªŒè¯æœåŠ¡
  data-validator:
    image: python:3.11-alpine
    container_name: modsrv-complete-data-validator
    depends_on:
      modsrv:
        condition: service_healthy
    volumes:
      - ./logs:/logs
      - ./scripts:/scripts:ro
    networks:
      - complete-test-net
    environment:
      - REDIS_URL=redis://redis:6379
      - VALIDATION_INTERVAL=60
      - VALIDATOR_LOG=/logs/data-validation.log
    command: ["/bin/sh", "-c", "
      pip install redis requests &&
      echo 'ğŸ” å¯åŠ¨æ•°æ®éªŒè¯æœåŠ¡...' &&
      python3 -c \"
import redis
import json
import time
import logging
from datetime import datetime

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('/logs/data-validation.log'),
        logging.StreamHandler()
    ]
)

r = redis.from_url('redis://redis:6379')

def validate_data_format():
    try:
        # éªŒè¯comsrvæ•°æ®æ ¼å¼
        comsrv_keys = r.keys('comsrv:*')
        logging.info(f'å‘ç° {len(comsrv_keys)} ä¸ªcomsrvé€šé“')
        
        for key in comsrv_keys[:5]:  # æ£€æŸ¥å‰5ä¸ª
            key_str = key.decode('utf-8')
            data = r.hgetall(key_str)
            logging.info(f'é€šé“ {key_str}: {len(data)} ä¸ªç‚¹ä½')
            
            # éªŒè¯æ•°å€¼æ ¼å¼ï¼ˆ6ä½å°æ•°ï¼‰
            for point_id, value in list(data.items())[:3]:
                value_str = value.decode('utf-8')
                try:
                    float_val = float(value_str)
                    decimal_places = len(value_str.split('.')[-1]) if '.' in value_str else 0
                    if decimal_places != 6:
                        logging.warning(f'ç‚¹ä½ {point_id.decode()} ç²¾åº¦ä¸ç¬¦åˆè§„èŒƒ: {value_str}')
                    else:
                        logging.info(f'ç‚¹ä½ {point_id.decode()} æ ¼å¼æ­£ç¡®: {value_str}')
                except ValueError:
                    logging.error(f'ç‚¹ä½ {point_id.decode()} æ•°å€¼æ ¼å¼é”™è¯¯: {value_str}')
        
        # éªŒè¯modsrvæ•°æ®
        modsrv_keys = r.keys('modsrv:*')
        logging.info(f'å‘ç° {len(modsrv_keys)} ä¸ªmodsrvé”®')
        
        return True
    except Exception as e:
        logging.error(f'æ•°æ®éªŒè¯å¤±è´¥: {e}')
        return False

while True:
    logging.info('å¼€å§‹æ•°æ®æ ¼å¼éªŒè¯...')
    validate_data_format()
    time.sleep(int('$VALIDATION_INTERVAL'))
      \"
    "]
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  complete-test-net:
    driver: bridge
    internal: true  # å®Œå…¨å†…éƒ¨ç½‘ç»œï¼Œä¸æš´éœ²ä»»ä½•ç«¯å£
    ipam:
      config:
        - subnet: 172.31.0.0/16

volumes:
  redis-data:
    driver: local