# hissrv 配置文件 - 极简轮询模式
# 专为边端设备设计的历史数据归档服务

# 服务配置
service:
  name: "hissrv"
  polling_interval: 10s     # 轮询间隔
  enable_api: true          # 启用配置管理 API
  api_port: 8082            # API 服务端口

# Redis 配置
redis:
  url: "redis://localhost:6379"
  data_keys:
    # 从 comsrv 获取实时测量数据
    - pattern: "comsrv:*:m"
      type: "hash"
    
    # 从 modsrv 获取计算后的数据
    - pattern: "modsrv:*:measurement"
      type: "hash"

# InfluxDB 配置
influxdb:
  url: "http://localhost:8086"
  org: "voltage"
  bucket: "ems"
  token: "${INFLUXDB_TOKEN}"    # 从环境变量读取
  batch_size: 1000              # 批量写入大小
  write_timeout: 30s            # 写入超时

# 数据映射规则
mappings:
  # comsrv 实时测量数据映射
  - source: "comsrv:*:m"
    measurement: "raw_measurements"
    tags:
      - type: "extract"
        field: "channel"       # 从 key 中提取 channel ID
      - type: "static"
        value: "source=comsrv"
    fields:
      - name: "value"
        field_type: "float"
      - name: "point_id"
        field_type: "string"
  
  # modsrv 计算数据映射
  - source: "modsrv:*:measurement"
    measurement: "calculated_measurements"
    tags:
      - type: "extract"
        field: "model"         # 从 key 中提取 model name
      - type: "static"
        value: "source=modsrv"
    fields:
      - name: "value"
        field_type: "float"
      - name: "field_name"
        field_type: "string"

# 示例环境变量：
# export INFLUXDB_TOKEN=your_token_here
# export HISSRV_REDIS_URL=redis://password@redis-server:6379
# export RUST_LOG=hissrv=info