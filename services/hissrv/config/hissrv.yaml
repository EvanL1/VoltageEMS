# hissrv 配置文件 - 极简轮询模式
# 专为边端设备设计的历史数据归档服务

# 服务配置
service:
  name: "hissrv"
  polling_interval: 10s     # 轮询间隔
  enable_api: true          # 启用配置管理 API
  api_port: 8082            # API 服务端口

# Redis 配置
redis:
  url: "redis://localhost:6379"
  data_keys:
    # 从列表中获取 JSON 格式的归档数据
    - pattern: "archive:pending"
      type: "list"
    
    # 从 Hash 中获取聚合后的数据
    - pattern: "archive:1m:*"
      type: "hash"
    
    - pattern: "archive:5m:*"
      type: "hash"

# InfluxDB 配置
influxdb:
  url: "http://localhost:8086"
  org: "voltage"
  bucket: "ems"
  token: "${INFLUXDB_TOKEN}"    # 从环境变量读取
  batch_size: 1000              # 批量写入大小
  write_timeout: 30s            # 写入超时

# 数据映射规则
mappings:
  # 1分钟聚合数据映射
  - source: "archive:1m:*"
    measurement: "metrics_1m"
    tags:
      - type: "extract"
        field: "channel"       # 从 key 中提取 channel
      - type: "static"
        value: "interval=1m"   # 静态标签
    fields:
      - name: "voltage_avg"
        field_type: "float"
      - name: "voltage_max"
        field_type: "float"
      - name: "voltage_min"
        field_type: "float"
      - name: "current_avg"
        field_type: "float"
      - name: "power_avg"
        field_type: "float"
  
  # 5分钟聚合数据映射
  - source: "archive:5m:*"
    measurement: "metrics_5m"
    tags:
      - type: "extract"
        field: "channel"
      - type: "static"
        value: "interval=5m"
    fields:
      - name: "voltage_avg"
        field_type: "float"
      - name: "current_avg"
        field_type: "float"
      - name: "power_avg"
        field_type: "float"

# 示例环境变量：
# export INFLUXDB_TOKEN=your_token_here
# export HISSRV_REDIS_URL=redis://password@redis-server:6379
# export RUST_LOG=hissrv=info