# hissrv configuration file - default polling mode
# Historical data archival service designed for edge devices

# Service configuration
service:
  name: "hissrv"
  polling_interval: 10s     # Polling interval
  enable_api: true          # Enable configuration management API
  api_port: 8082            # API service port

# Redis configuration
redis:
  url: "redis://localhost:6379"
  data_keys:
    # Get real-time measurement data from comsrv
    - pattern: "comsrv:*:m"
      type: "hash"
    
    # Get calculated data from modsrv
    - pattern: "modsrv:*:measurement"
      type: "hash"

# InfluxDB configuration
influxdb:
  url: "http://localhost:8086"
  org: "voltage"
  bucket: "ems"
  token: "${INFLUXDB_TOKEN}"    # Read from environment variable
  batch_size: 1000              # Batch write size
  write_timeout: 30s            # Write timeout

# Data mapping rules
mappings:
  # comsrv real-time measurement data mapping
  - source: "comsrv:*:m"
    measurement: "raw_measurements"
    tags:
      - type: "extract"
        field: "channel"       # Extract channel ID from key
      - type: "static"
        value: "source=comsrv"
    fields:
      - name: "value"
        field_type: "float"
      - name: "point_id"
        field_type: "string"
  
  # modsrv calculated data mapping
  - source: "modsrv:*:measurement"
    measurement: "calculated_measurements"
    tags:
      - type: "extract"
        field: "model"         # Extract model name from key
      - type: "static"
        value: "source=modsrv"
    fields:
      - name: "value"
        field_type: "float"
      - name: "field_name"
        field_type: "string"

# Example environment variables:
# export INFLUXDB_TOKEN=your_token_here
# export HISSRV_REDIS_URL=redis://password@redis-server:6379
# export RUST_LOG=hissrv=info