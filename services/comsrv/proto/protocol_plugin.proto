syntax = "proto3";

package comsrv.plugin.v1;

// 插件服务接口
service ProtocolPlugin {
  // 获取插件信息
  rpc GetInfo(Empty) returns (PluginInfo);
  
  // 解析原始数据
  rpc ParseData(ParseRequest) returns (ParseResponse);
  
  // 编码控制命令
  rpc EncodeCommand(EncodeRequest) returns (EncodeResponse);
  
  // 批量读取（主动轮询模式）
  rpc BatchRead(BatchReadRequest) returns (BatchReadResponse);
  
  // 健康检查
  rpc HealthCheck(Empty) returns (HealthStatus);
}

// 基础消息定义
message Empty {}

message PluginInfo {
  string name = 1;
  string version = 2;
  string protocol_type = 3;
  repeated string supported_features = 4;
  map<string, string> metadata = 5;
}

message ParseRequest {
  bytes raw_data = 1;
  map<string, string> context = 2;  // 通道配置等上下文信息
}

message ParseResponse {
  repeated PointData points = 1;
  string error = 2;
}

message PointData {
  uint32 point_id = 1;
  oneof value {
    double float_value = 2;
    int64 int_value = 3;
    bool bool_value = 4;
    string string_value = 5;
  }
  int64 timestamp = 6;
  uint32 quality = 7;  // 数据质量标志
}

message CommandValue {
  oneof value {
    double float_value = 1;
    int64 int_value = 2;
    bool bool_value = 3;
    string string_value = 4;
  }
}

message EncodeRequest {
  uint32 channel_id = 1;
  uint32 point_id = 2;
  CommandValue value = 3;
  map<string, string> context = 4;
}

message EncodeResponse {
  bytes encoded_data = 1;
  string error = 2;
}

message BatchReadRequest {
  uint32 channel_id = 1;                     // 通道ID
  repeated uint32 point_ids = 2;             // 要读取的点位  
  map<string, string> connection_params = 3;  // 连接参数
  map<string, string> read_params = 4;       // 读取参数
}

message BatchReadResponse {
  repeated PointData points = 1;
  string error = 2;
}

message HealthStatus {
  bool healthy = 1;
  string message = 2;
  map<string, string> details = 3;
}