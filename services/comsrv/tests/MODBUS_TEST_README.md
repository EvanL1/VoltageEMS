# Modbus 测试工具说明

## 概述

本目录包含用于测试comsrv Modbus通信功能的工具：

1. **modbus_server_simulator.py** - Modbus TCP服务器模拟器
2. **test_modbus_client.py** - Modbus客户端测试脚本
3. **start_modbus_simulator.sh** - 服务器启动脚本

## Modbus服务器模拟器

### 功能特性

- 完全匹配comsrv配置文件的地址和从站ID
- 支持四遥（遥测、遥信、遥控、遥调）
- 实时数据更新（正弦波模拟）
- 支持所有标准Modbus功能码

### 数据映射

根据comsrv配置文件 (`config/test_points/ModbusTCP_Demo/mapping_*.csv`)：

#### 遥测 (YC) - 模拟量输入
| 点位ID | 从站ID | 地址 | 功能码 | 说明 |
|--------|--------|------|--------|------|
| 1001 | 1 | 1001 | 03 | 电压 ~220V |
| 1002 | 1 | 1003 | 03 | 电流 ~15A (×0.1) |
| 1003 | 1 | 1005 | 03 | 功率 ~3300W |
| 1004 | 1 | 1007 | 03 | 温度 ~25°C (×0.1) |
| 1005 | 1 | 1009 | 03 | 频率 ~50Hz (×0.1) |
| 1006 | 2 | 2001 | 04 | 电压 ~380V |
| 1007 | 2 | 2002 | 04 | 电流 ~10A (×0.1) |
| 1008 | 2 | 2003 | 04 | 功率 ~5000W |

#### 遥信 (YX) - 开关量输入
| 点位ID | 从站ID | 地址 | 功能码 | 类型 |
|--------|--------|------|--------|------|
| 2001 | 1 | 1 | 01 | 线圈 |
| 2002 | 1 | 2 | 01 | 线圈 |
| 2003 | 1 | 3 | 01 | 线圈 |
| 2004 | 1 | 4 | 02 | 离散输入 |
| 2005 | 1 | 5 | 02 | 离散输入 |

#### 遥控 (YK) - 开关量输出
| 点位ID | 从站ID | 地址 | 功能码 | 操作 |
|--------|--------|------|--------|------|
| 4001 | 1 | 1001 | 05 | 写单个线圈 |
| 4002 | 1 | 1002 | 05 | 写单个线圈 |
| 4006 | 2 | 2001 | 15 | 写多个线圈 |
| 4007 | 2 | 2002 | 15 | 写多个线圈 |

#### 遥调 (YT) - 模拟量输出
| 点位ID | 从站ID | 地址 | 功能码 | 数据类型 |
|--------|--------|------|--------|----------|
| 3001 | 1 | 2001-2002 | 16 | float32 |
| 3002 | 1 | 2003-2004 | 16 | float32 |
| 3003 | 1 | 2005-2006 | 16 | float32 |

## 使用方法

### 1. 启动Modbus服务器

```bash
# 使用默认端口 5020
./scripts/start_modbus_simulator.sh

# 指定端口
./scripts/start_modbus_simulator.sh --port 5021

# 启用调试模式
./scripts/start_modbus_simulator.sh --debug
```

或直接运行Python脚本：

```bash
python3 tests/modbus_server_simulator.py --port 5020
```

### 2. 测试服务器

在另一个终端运行测试客户端：

```bash
python3 tests/test_modbus_client.py
```

测试客户端会自动测试：
- 读取遥测数据（FC03, FC04）
- 读取遥信状态（FC01, FC02）
- 写入遥控命令（FC05, FC15）
- 写入遥调设定值（FC06, FC16）

### 3. 与comsrv集成测试

启动Modbus服务器后，运行comsrv：

```bash
# 启动Modbus模拟器
./scripts/start_modbus_simulator.sh

# 在另一个终端启动comsrv
cargo run --bin comsrv
```

然后可以通过API查看数据：

```bash
# 查看通道状态
curl http://127.0.0.1:3000/api/channels

# 查看实时数据
curl http://127.0.0.1:3000/api/channels/1001/data
```

## 功能验证

### 遥测数据验证
- 数据按正弦波模式变化
- 每秒更新一次
- 支持缩放因子（scale）

### 遥信状态验证
- 随机切换状态（10%概率/秒）
- 支持位操作和字节打包

### 遥控命令验证
- 写入后立即生效
- 支持单个和批量写入

### 遥调设定验证
- 支持float32数据类型
- 大端字节序（ABCD）
- 跨两个寄存器存储

## 调试技巧

1. **查看实时数据**：服务器每10秒打印一次当前数据值

2. **启用调试日志**：使用 `--debug` 参数查看详细通信日志

3. **网络抓包**：使用Wireshark过滤 `tcp.port == 5020` 查看Modbus协议帧

4. **手动测试**：使用modbus-cli等工具手动读写：
   ```bash
   # 读取保持寄存器
   modbus read -s 1 -a 1001 -c 5 127.0.0.1:5020
   
   # 写入线圈
   modbus write -s 1 -a 1001 -v 1 127.0.0.1:5020
   ```

## 常见问题

1. **端口被占用**
   ```
   OSError: [Errno 48] Address already in use
   ```
   解决：使用 `lsof -i :5020` 查找占用进程，或换用其他端口

2. **连接被拒绝**
   ```
   ConnectionRefusedError: [Errno 61] Connection refused
   ```
   解决：确保服务器已启动，检查防火墙设置

3. **数据不更新**
   - 检查从站ID是否正确（1或2）
   - 确认地址范围在配置内
   - 查看服务器日志是否有错误

## 扩展开发

如需添加更多测试点位：

1. 修改 `_initialize_data()` 方法添加新地址
2. 在 `_update_values()` 中添加更新逻辑
3. 更新本文档的数据映射表