# Fixlog 2025-07-09

## CSV点表加载支持和协议修复

### 修复内容

1. **协议工厂插件系统集成**
   - 修复了 `ProtocolFactory::validate_config` 使用插件系统进行协议验证
   - 确保协议创建时使用注册的插件而不是旧的 HashMap 方式

2. **TCP Transport 主机名支持**
   - 修复了 TCP transport 的 `validate()` 方法，移除了 SocketAddr 解析
   - 支持使用主机名（如 "modbus_tcp_simulator"）而不仅仅是 IP 地址
   - 解决了 Docker 容器间通信的主机名解析问题

3. **Modbus RTU 参数兼容性**
   - 修复了 Modbus RTU 插件同时支持 `device_path` 和 `port_name` 参数
   - 保持向后兼容性，避免配置文件修改

4. **CSV 点表自动加载**
   - 在 `ProtocolFactory::create_protocol_with_config_manager` 中实现了 CSV 点表自动加载
   - 从 ConfigManager 获取已加载的 combined_points
   - 解决了协议初始化时点位为空的问题

5. **配置版本字段默认值**
   - 为 `AppConfig` 添加了版本字段的默认值函数
   - 配置文件不再需要显式声明 version 字段

### 测试验证

1. **集成测试通过**
   - 成功创建 10 个通道（3 CAN + 3 IEC104 + 2 Modbus TCP + 2 Modbus RTU）
   - CSV 点表成功加载：11 个协议映射，7 个轮询点位

2. **示例 CSV 文件**
   - 创建了完整的测试 CSV 文件集，包含四种点类型
   - 位置：`/tests/integration/config/Modbus_TCP_Test_1/`

### Git 操作

1. 清理了过时的文件和文档
2. 解决了与远程 develop 分支的合并冲突
3. 成功推送更改到远程仓库

## 相关文件
- `services/comsrv/src/core/protocols/common/combase/protocol_factory.rs`
- `services/comsrv/src/core/transport/tcp.rs`
- `services/comsrv/src/core/protocols/modbus/plugin.rs`
- `services/comsrv/src/core/config/types/app.rs`

## CI/CD 修复

### 修复内容

1. **GitHub Actions CI 失败修复**
   - 修复了 `cargo fmt` 检查失败的问题
   - 修复了 modbus/common.rs 第400行的尾随空格
   - 对整个 comsrv 服务运行了 `cargo fmt` 格式化代码

2. **修复缺失文件引用**
   - 注释掉了 Cargo.toml 中不存在的 `optimized_points_demo` 示例
   - 注释掉了 mod.rs 中不存在的 `unified_loader` 模块引用

### 影响文件
- 格式化了89个 Rust 源文件
- 主要修复了格式问题，包括缩进、空格和代码对齐

### 验证
- 本地运行 `cargo fmt --check` 通过
- 成功提交并推送到 develop 分支
- CI pipeline 应该能够通过