# API Gateway 改进方案

## 当前架构

- 直接连接 Redis 读取实时数据
- 代理转发到后端服务
- 完善的健康检查机制
- JWT 认证和权限控制

## 需要改进的地方

### 1. 添加 InfluxDB 支持（历史数据查询）

```rust
// 新增历史数据读取器
pub struct HistoryReader {
    influx_client: Arc<InfluxClient>,
}

impl HistoryReader {
    // 查询历史数据
    pub async fn query_history(
        &self,
        measurement: &str,
        start_time: DateTime<Utc>,
        end_time: DateTime<Utc>,
        tags: HashMap<String, String>,
    ) -> Result<Vec<DataPoint>, ApiGatewayError> {
        // 构建 InfluxDB 查询
        let query = Query::new(format!(
            "SELECT * FROM {} WHERE time >= '{}' AND time <= '{}'",
            measurement, start_time, end_time
        ));
        
        self.influx_client.query(query).await
    }
}
```

### 2. 统一数据接口

```rust
// 统一的数据查询接口
#[derive(Deserialize)]
pub struct DataQuery {
    pub source: DataSource,      // realtime | history
    pub channels: Vec<u32>,
    pub points: Vec<String>,
    pub time_range: Option<TimeRange>,
    pub aggregation: Option<AggregationType>,
}

pub enum DataSource {
    Realtime,   // Redis
    History,    // InfluxDB
    Mixed,      // 结合实时和历史
}
```

### 3. 添加缓存层

```rust
// 使用 Redis 作为缓存
pub struct CacheManager {
    redis: Arc<RedisClient>,
    ttl: Duration,
}

impl CacheManager {
    pub async fn get_or_fetch<F, T>(
        &self,
        key: &str,
        fetch_fn: F,
    ) -> Result<T, ApiGatewayError>
    where
        F: Future<Output = Result<T, ApiGatewayError>>,
        T: Serialize + DeserializeOwned,
    {
        // 先查缓存
        if let Some(cached) = self.redis.get(key).await? {
            return Ok(serde_json::from_str(&cached)?);
        }
        
        // 缓存未命中，执行查询
        let result = fetch_fn.await?;
        
        // 写入缓存
        self.redis.setex(key, &serde_json::to_string(&result)?, self.ttl).await?;
        
        Ok(result)
    }
}
```

### 4. 增强健康检查

```yaml
# 新增健康检查配置
health_check:
  # 基础健康检查
  basic:
    endpoint: /health
    
  # 详细健康检查
  detailed:
    endpoint: /health/detailed
    include_metrics: true
    check_dependencies:
      - redis:
          ping: true
          memory_usage: true
      - influxdb:
          ping: true
          query_test: true
      - services:
          timeout: 5s
          check_response_time: true
```

### 5. GraphQL 支持（可选）

```graphql
# 统一查询接口
type Query {
  # 实时数据
  realtime(channels: [Int!]!): RealtimeData
  
  # 历史数据
  history(
    channels: [Int!]!
    startTime: DateTime!
    endTime: DateTime!
    aggregation: AggregationType
  ): HistoryData
  
  # 告警查询
  alarms(
    status: AlarmStatus
    level: AlarmLevel
    limit: Int
  ): [Alarm!]!
  
  # 服务健康状态
  health: HealthStatus!
}

# 订阅实时更新
type Subscription {
  channelUpdates(channels: [Int!]!): ChannelData!
  alarmUpdates(levels: [AlarmLevel!]): Alarm!
}
```

## 实施计划

### 第一阶段：基础改进
1. 实现 InfluxDB 连接和查询
2. 添加历史数据 API
3. 实现简单缓存机制

### 第二阶段：功能增强
1. 统一数据查询接口
2. 增强健康检查
3. 添加性能监控

### 第三阶段：高级特性
1. GraphQL 支持
2. 数据聚合功能
3. 智能缓存策略

## 配置示例

```yaml
# apigateway 配置
server:
  host: "0.0.0.0"
  port: 8080

redis:
  url: "redis://localhost:6379"
  
influxdb:
  url: "http://localhost:8086"
  token: "your-token"
  org: "voltage"
  bucket: "voltage_data"
  
cache:
  enabled: true
  ttl: 300  # 5分钟
  
services:
  comsrv: "http://localhost:8001"
  modsrv: "http://localhost:8002"
  hissrv: "http://localhost:8003"
  alarmsrv: "http://localhost:8004"
  netsrv: "http://localhost:8006"
  rulesrv: "http://localhost:8005"
```