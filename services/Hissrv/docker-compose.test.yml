version: '3.8'

services:
  # Redis服务 - 中心消息总线
  redis:
    image: redis:8-alpine
    container_name: hissrv-test-redis
    command: redis-server --appendonly yes --save 60 1000
    volumes:
      - redis_data:/data
      - ./test-configs/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - hissrv-test
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # InfluxDB服务 - 时序数据库 (2.7版本)
  influxdb:
    image: influxdb:2.7-alpine
    container_name: hissrv-test-influxdb
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=admin123
      - DOCKER_INFLUXDB_INIT_ORG=voltageems
      - DOCKER_INFLUXDB_INIT_BUCKET=hissrv_data
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=test-token-hissrv-12345
    volumes:
      - influxdb_data:/var/lib/influxdb2
    networks:
      - hissrv-test
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # hissrv服务 - 主要测试对象
  hissrv:
    build:
      context: ../..
      dockerfile: services/Hissrv/Dockerfile
    container_name: hissrv-test-main
    depends_on:
      - redis
      - influxdb
    environment:
      - RUST_LOG=debug
      - HISSRV_REDIS__HOST=redis
      - HISSRV_REDIS__PORT=6379
      - HISSRV_INFLUXDB__URL=http://influxdb:8086
      - HISSRV_INFLUXDB__DATABASE=hissrv_data
    volumes:
      - ./config/hissrv.test.yaml:/app/config/hissrv.yaml:ro
      - ./test-logs:/app/logs
      - ./test-configs:/app/test-configs:ro
    networks:
      - hissrv-test
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "5"

  # comsrv模拟器 - 模拟通信服务
  comsrv-simulator:
    image: redis:8-alpine
    container_name: hissrv-test-comsrv
    depends_on:
      - redis
    volumes:
      - ./test-scripts:/scripts:ro
    networks:
      - hissrv-test
    command: >
      sh -c "
        echo '开始comsrv数据模拟...' &&
        sleep 5 &&
        while true; do
          redis-cli -h redis -p 6379 HSET comsrv:1001:m 10001 '25.123456' 10002 '26.234567' 10003 '27.345678' &&
          redis-cli -h redis -p 6379 PUBLISH comsrv:1001:m '10001:25.123456' &&
          redis-cli -h redis -p 6379 HSET comsrv:1001:s 20001 '1' 20002 '0' 20003 '1' &&
          redis-cli -h redis -p 6379 PUBLISH comsrv:1001:s '20001:1' &&
          redis-cli -h redis -p 6379 HSET comsrv:1002:m 10101 '30.456789' 10102 '31.567890' &&
          redis-cli -h redis -p 6379 PUBLISH comsrv:1002:m '10101:30.456789' &&
          sleep 10
        done
      "
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # modsrv模拟器 - 模拟模型服务
  modsrv-simulator:
    image: redis:8-alpine
    container_name: hissrv-test-modsrv
    depends_on:
      - redis
    networks:
      - hissrv-test
    command: >
      sh -c "
        echo '开始modsrv数据模拟...' &&
        sleep 8 &&
        while true; do
          redis-cli -h redis -p 6379 PUBLISH modsrv:measurement 'power_total:1250.567890' &&
          redis-cli -h redis -p 6379 PUBLISH modsrv:control 'switch_status:1' &&
          sleep 15
        done
      "
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # alarmsrv模拟器 - 模拟告警服务
  alarmsrv-simulator:
    image: redis:8-alpine
    container_name: hissrv-test-alarmsrv
    depends_on:
      - redis
    networks:
      - hissrv-test
    command: >
      sh -c "
        echo '开始alarmsrv数据模拟...' &&
        sleep 12 &&
        while true; do
          redis-cli -h redis -p 6379 PUBLISH alarmsrv:alarm 'high_temp:critical' &&
          redis-cli -h redis -p 6379 PUBLISH alarmsrv:event 'system_start:info' &&
          sleep 20
        done
      "
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # 数据验证器 - 验证InfluxDB中的数据
  data-validator:
    image: redis:8-alpine
    container_name: hissrv-test-validator
    depends_on:
      - influxdb
      - hissrv
    networks:
      - hissrv-test
    command: >
      sh -c "
        echo '等待服务启动...' &&
        sleep 40 &&
        echo '开始验证数据写入...' &&
        while true; do
          echo '=== 检查Redis数据 ===' &&
          echo 'comsrv:1001:m Hash:' &&
          redis-cli -h redis -p 6379 HGETALL comsrv:1001:m &&
          echo 'comsrv:1001:s Hash:' &&
          redis-cli -h redis -p 6379 HGETALL comsrv:1001:s &&
          echo 'comsrv:1002:m Hash:' &&
          redis-cli -h redis -p 6379 HGETALL comsrv:1002:m &&
          echo '=== Redis键列表 ===' &&
          redis-cli -h redis -p 6379 KEYS 'comsrv:*' &&
          echo '=== Pub/Sub验证 ===' &&
          timeout 5 redis-cli -h redis -p 6379 PSUBSCRIBE 'comsrv:*' 'modsrv:*' 'alarmsrv:*' || true &&
          sleep 60
        done
      "
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "3"

networks:
  hissrv-test:
    driver: bridge
    internal: true  # 不对外暴露端口

volumes:
  redis_data:
  influxdb_data:
  hissrv_logs: