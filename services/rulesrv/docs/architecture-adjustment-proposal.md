# VoltageEMS 架构调整建议

## 现状分析

### 当前架构的问题

1. **过度微服务化**
   - 7个独立服务对于工业IoT系统来说过多
   - 每个服务都需要独立部署、监控、维护
   - 服务间通信开销大

2. **性能瓶颈**
   - rulesrv和modsrv大量读写Redis，但通过网络
   - 简单的映射查询也需要完整的HTTP请求
   - 无法利用Redis的原子操作

3. **复杂度高**
   - 开发需要理解7个服务的交互
   - 调试困难，需要追踪多个服务
   - 部署和运维成本高

4. **资源浪费**
   - 每个服务都有自己的运行时开销
   - 内存使用重复（每个服务都有Redis连接池等）

## 推荐的新架构

### 三层架构模型

```
┌─────────────────────────────────────────────────────┐
│                   前端层                             │
│              Nginx (反向代理)                        │
└─────────────────────────────────────────────────────┘
                        │
┌─────────────────────────────────────────────────────┐
│                   核心服务层                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐│
│  │   comsrv    │  │   datasrv   │  │   apisrv    ││
│  │ (通信采集)   │  │ (数据处理)  │  │  (API网关)  ││
│  └─────────────┘  └─────────────┘  └─────────────┘│
└─────────────────────────────────────────────────────┘
                        │
┌─────────────────────────────────────────────────────┐
│                   数据层                             │
│  ┌──────────────────────────────────────┐          │
│  │          Redis + Lua Functions        │          │
│  │  (rules, models, alarms, routing)     │          │
│  └──────────────────────────────────────┘          │
│  ┌──────────────────────────────────────┐          │
│  │            InfluxDB                   │          │
│  │         (时序数据存储)                 │          │
│  └──────────────────────────────────────┘          │
└─────────────────────────────────────────────────────┘
```

### 服务合并方案

#### 1. **comsrv** - 保持独立 ✅
- 负责所有协议通信
- 需要插件架构和网络IO
- 保持当前设计

#### 2. **datasrv** - 新的数据处理服务 🆕
合并以下功能：
- **hissrv功能**：历史数据存储
- **alarmsrv部分功能**：告警生成和管理
- **netsrv功能**：数据转发和路由

使用Rust实现需要外部IO的部分。

#### 3. **apisrv** - 轻量级API网关 🆕
- 提供统一的REST API
- 调用Redis Lua Functions
- WebSocket推送
- 认证和授权

#### 4. **Redis Lua Functions** - 核心业务逻辑 🆕
- **规则引擎**（原rulesrv）
- **模型映射**（原modsrv）
- **告警条件检查**（原alarmsrv部分）
- **数据路由规则**（原netsrv部分）

## 调整后的优势

### 1. 性能提升
- 核心逻辑在Redis内执行，延迟降低90%
- 批量操作原子化
- 减少网络往返

### 2. 简化运维
- 从7个服务减少到3个
- 更容易监控和维护
- 资源使用减少50%

### 3. 开发效率
- 更清晰的职责划分
- Lua脚本可热更新
- 调试更简单

### 4. 可靠性提升
- 减少故障点
- 原子操作保证一致性
- 更好的错误恢复

## 实施路径

### 第一阶段（1-2周）
1. ✅ rulesrv迁移到Lua（已完成设计）
2. ✅ modsrv迁移到Lua（已完成设计）
3. 创建apisrv框架

### 第二阶段（2-3周）
1. 合并hissrv到datasrv
2. 迁移alarmsrv的告警条件到Lua
3. 迁移netsrv的路由规则到Lua

### 第三阶段（1-2周）
1. 整合API网关
2. 性能测试和优化
3. 文档更新

### 第四阶段（持续）
1. 监控和调优
2. 功能迭代
3. 逐步下线旧服务

## 风险控制

1. **渐进式迁移**
   - 新旧架构并存
   - 逐步切换流量
   - 可随时回滚

2. **兼容性保证**
   - API保持兼容
   - 数据格式不变
   - 客户端无感知

3. **测试覆盖**
   - 单元测试
   - 集成测试
   - 性能测试
   - 压力测试

## 关键决策点

### 需要保留微服务的场景
- 需要独立扩展（如comsrv可能需要多实例）
- 技术栈差异大（如需要特定语言特性）
- 安全隔离要求

### 适合合并的场景
- 功能紧密相关
- 共享大量数据
- 性能要求高

## 结论

**建议进行架构调整**，但要：

1. **保持核心功能稳定**：comsrv继续独立运行
2. **渐进式改造**：先迁移简单服务，积累经验
3. **性能优先**：将高频操作迁移到Lua
4. **简化为主**：减少服务数量，降低复杂度

这样的调整将使VoltageEMS成为一个更加高效、可靠、易维护的工业IoT平台。

## 预期收益

- **性能**：关键操作提升10-30倍
- **成本**：服务器资源减少50%
- **开发**：新功能开发速度提升2倍
- **运维**：故障排查时间减少70%

## 下一步行动

1. 获得团队共识
2. 制定详细迁移计划
3. 搭建测试环境
4. 开始第一阶段实施