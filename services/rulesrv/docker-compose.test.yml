version: '3.8'

services:
  redis:
    image: redis:8-alpine
    container_name: rulesrv-redis-test
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis-test-data:/data
    networks:
      - rulesrv-test

  rulesrv:
    build:
      context: ../..
      dockerfile: services/rulesrv/Dockerfile
    container_name: rulesrv-test
    depends_on:
      - redis
    environment:
      - RUST_LOG=debug,rulesrv=trace
      - REDIS_URL=redis://redis:6379
      - SERVICE_PORT=6003
    ports:
      - "6003:6003"
    volumes:
      - ./config:/app/config:ro
      - ./examples:/app/examples:ro
    networks:
      - rulesrv-test
    command: ["/app/rulesrv", "service"]
    build:
      context: ../..
      dockerfile: services/rulesrv/Dockerfile.test
    container_name: rulesrv-test-runner
    depends_on:
      - redis
      - rulesrv
    environment:
      - RUST_LOG=debug
      - REDIS_URL=redis://redis:6379
      - RULESRV_URL=http://rulesrv:6003
    volumes:
      - ./tests:/app/tests:ro
      - ./examples:/app/examples:ro
      - test-results:/app/results
    networks:
      - rulesrv-test
    command: |
      bash -c "
        echo 'Waiting for services to start...'
        sleep 5
        
        echo 'Loading example rules...'
        for file in /app/examples/*.json; do
          echo \"Loading rules from \$file\"
          jq -c '.[]' \$file | while read rule; do
            curl -s -X POST http://rulesrv:6003/rules \
              -H 'Content-Type: application/json' \
              -d \"{\\\"rule\\\": \$rule}\" || true
          done
        done
        
        echo 'Running tests...'
        cargo test --all-features -- --test-threads=1 --nocapture
        
        echo 'Running API tests...'
        curl -s http://rulesrv:6003/health | jq .
        curl -s http://rulesrv:6003/rules | jq .
        
        echo 'Tests completed!'
      "

networks:
  rulesrv-test:
    driver: bridge

volumes:
  redis-test-data:
  test-results: