# 告警服务 (Alarm Service - alarmsrv)

## 功能概述

alarmsrv 是 VoltageEMS 系统的智能告警管理服务，负责实时监控系统数据、生成告警、管理告警生命周期，并将告警信息推送到相关人员和系统。该服务提供了完整的告警处理流程，包括告警触发、分类、抑制、升级和通知。

## 主要功能

### 1. 告警检测
- **实时监控**: 从 Redis 订阅数据变化，实时检测异常
- **多维度规则**: 支持阈值、趋势、异常模式等多种检测规则
- **组合告警**: 支持多个条件组合触发告警
- **智能检测**: 基于机器学习的异常检测

### 2. 告警分类
- **严重级别**: 紧急、重要、警告、信息四个级别
- **类型分类**: 设备故障、通信异常、数据异常、系统告警
- **自动分类**: 基于规则引擎的自动分类
- **标签管理**: 灵活的标签系统便于管理

### 3. 告警处理
- **去重抑制**: 避免重复告警，智能抑制告警风暴
- **告警升级**: 长时间未处理自动升级
- **关联分析**: 关联相关告警，找出根因
- **工单集成**: 自动创建维护工单

### 4. 通知管理
- **多渠道通知**: 支持邮件、短信、钉钉、企业微信
- **分级通知**: 根据告警级别选择通知方式
- **值班管理**: 集成值班表，智能分配告警
- **通知确认**: 支持告警确认和反馈

## 架构设计

```mermaid
graph TB
    subgraph "alarmsrv 内部架构"
        AE[告警引擎<br/>Alarm Engine]
        
        subgraph "检测层"
            RD[规则检测器]
            TD[阈值检测器]
            PD[模式检测器]
            AD[异常检测器]
        end
        
        subgraph "处理层"
            AC[告警分类器]
            AS[告警抑制器]
            AA[告警聚合器]
            AE2[告警升级器]
        end
        
        subgraph "存储层"
            AR[告警存储]
            RR[规则存储]
            HR[历史存储]
            SR[状态存储]
        end
        
        subgraph "通知层"
            NM[通知管理器]
            EC[邮件通道]
            SC[短信通道]
            DC[钉钉通道]
            WC[企微通道]
        end
        
        subgraph "管理层"
            RM[规则管理]
            TM[模板管理]
            UM[用户管理]
            SM[统计管理]
        end
    end
    
    subgraph "外部系统"
        RDS[Redis]
        DB[数据库]
        MSG[消息服务]
        WEB[Web 界面]
        CLOUD[云平台]
    end
    
    RDS -->|数据订阅| AE
    AE --> RD & TD & PD & AD
    RD & TD & PD & AD --> AC
    AC --> AS
    AS --> AA
    AA --> AE2
    
    AE2 --> AR
    AR --> DB
    
    AE2 --> NM
    NM --> EC & SC & DC & WC
    EC & SC & DC & WC --> MSG
    
    RM & TM & UM --> WEB
    SM -->|统计数据| WEB
    AE2 -->|告警上传| CLOUD
```

## 配置说明

### 主配置文件 (alarmsrv.yaml)
```yaml
server:
  port: 8084
  
redis:
  url: "redis://127.0.0.1:6379"
  subscribe_patterns:
    - "telemetry:*"
    - "signal:*"
    - "device:status:*"
    
database:
  url: "postgres://user:pass@localhost/alarms"
  max_connections: 10
  
rules:
  config_path: "./rules"
  reload_interval: 60s
  
classification:
  enabled: true
  rules_file: "./classification_rules.yaml"
  
suppression:
  enabled: true
  window: 300s
  threshold: 5
  
notification:
  channels:
    - type: "email"
      enabled: true
      smtp:
        host: "smtp.example.com"
        port: 587
        username: "alarm@example.com"
        password: "password"
        
    - type: "dingtalk"
      enabled: true
      webhook: "https://oapi.dingtalk.com/robot/send?access_token=xxx"
      
    - type: "wecom"
      enabled: true
      webhook: "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=xxx"
```

### 告警规则配置 (rules/voltage_alarm.yaml)
```yaml
name: "电压异常告警"
description: "监控电压超限情况"
enabled: true
priority: "high"

conditions:
  - field: "voltage_a"
    operator: ">"
    value: 250
    duration: 60s
    
  - field: "voltage_a"
    operator: "<"
    value: 180
    duration: 60s
    
actions:
  - type: "create_alarm"
    severity: "critical"
    message: "A相电压异常: ${value}V"
    tags: ["voltage", "phase_a", "critical"]
    
  - type: "notify"
    channels: ["email", "dingtalk"]
    template: "voltage_alarm_template"
```

### 分类规则配置
```yaml
classifications:
  - name: "设备故障"
    rules:
      - tags_contain: ["device", "fault"]
      - message_match: "设备.*故障"
      
  - name: "通信异常"
    rules:
      - tags_contain: ["communication", "timeout"]
      - source_match: "comsrv"
      
  - name: "数据异常"
    rules:
      - tags_contain: ["data", "invalid"]
      - severity_in: ["warning", "critical"]
```

## API 接口

### 告警管理 API
- `GET /api/alarms`: 获取告警列表
- `GET /api/alarms/{id}`: 获取告警详情
- `PUT /api/alarms/{id}/ack`: 确认告警
- `PUT /api/alarms/{id}/close`: 关闭告警
- `POST /api/alarms/{id}/comment`: 添加备注

### 规则管理 API
- `GET /api/rules`: 获取规则列表
- `POST /api/rules`: 创建新规则
- `PUT /api/rules/{id}`: 更新规则
- `DELETE /api/rules/{id}`: 删除规则
- `POST /api/rules/{id}/test`: 测试规则

### 通知管理 API
- `GET /api/notifications`: 获取通知配置
- `PUT /api/notifications`: 更新通知配置
- `POST /api/notifications/test`: 测试通知发送

### 统计分析 API
- `GET /api/statistics/summary`: 告警统计摘要
- `GET /api/statistics/trends`: 告警趋势分析
- `GET /api/statistics/top`: Top N 告警分析

## 告警生命周期

```mermaid
stateDiagram-v2
    [*] --> 触发: 满足告警条件
    触发 --> 抑制检查: 生成告警
    抑制检查 --> 已抑制: 满足抑制条件
    抑制检查 --> 活跃: 不满足抑制条件
    活跃 --> 通知: 发送通知
    通知 --> 已通知: 通知成功
    已通知 --> 确认: 人工确认
    已通知 --> 升级: 超时未处理
    升级 --> 已通知: 重新通知
    确认 --> 处理中: 开始处理
    处理中 --> 已解决: 问题解决
    已解决 --> [*]: 告警结束
    已抑制 --> [*]: 抑制结束
```

## 部署说明

### Docker 部署
```bash
docker build -t alarmsrv .
docker run -d --name alarmsrv \
  -v ./config:/app/config \
  -v ./rules:/app/rules \
  -p 8084:8084 \
  --network voltageems_net \
  alarmsrv
```

### 本地开发
```bash
cd services/alarmsrv
cargo build --release
RUST_LOG=info cargo run
```

## 监控指标

- `alarmsrv_alarms_total`: 告警总数
- `alarmsrv_alarms_active`: 活跃告警数
- `alarmsrv_notifications_sent`: 通知发送数
- `alarmsrv_rules_evaluated`: 规则评估次数
- `alarmsrv_suppression_rate`: 告警抑制率

## 最佳实践

1. **规则设计**
   - 避免过于敏感的阈值
   - 使用持续时间避免瞬时波动
   - 合理设置告警级别

2. **告警抑制**
   - 配置告警风暴抑制
   - 设置维护窗口
   - 使用依赖关系避免级联告警

3. **通知策略**
   - 分级通知，避免告警疲劳
   - 配置值班表和升级策略
   - 定期回顾和优化规则

## 故障排查

1. **告警未触发**: 检查规则配置和数据订阅
2. **告警风暴**: 调整抑制规则和阈值
3. **通知失败**: 验证通知渠道配置
4. **性能问题**: 优化规则复杂度，增加资源

## 相关服务

- **comsrv**: 设备数据和状态来源
- **modsrv**: 计算结果触发告警
- **hissrv**: 查询历史告警数据
- **netsrv**: 上传告警到云平台