# AlarmSrv 改造方案

## 当前架构

- 主动扫描模式：定期扫描 `comsrv:{channelID}:{type}` Hash
- 基于阈值的简单告警
- 独立运行，不依赖其他服务

## 改造目标

1. 支持基于 ModSrv 计算结果的高级告警
2. 保持向后兼容性
3. 提高告警响应速度
4. 减少重复计算

## 实施方案

### 第一阶段：添加 Redis 订阅支持

```rust
// 添加订阅 modsrv 更新通知
pub async fn start_modsrv_listener(
    redis_client: Arc<AlarmRedisClient>,
    rules_engine: Arc<RwLock<AlarmRulesEngine>>,
) -> Result<()> {
    let patterns = vec![
        "modsrv:*:update",
        "modsrv:*:measurement"
    ];
    
    // 订阅并处理消息
    redis_client.psubscribe(patterns, |channel, message| {
        // 解析 modsrv 数据并应用高级规则
    }).await?;
}
```

### 第二阶段：扩展规则引擎

```yaml
# 高级告警规则示例
rules:
  - id: power_factor_low
    type: model_based
    model: power_meter
    condition:
      field: power_factor
      operator: "<"
      value: 0.85
    level: warning
    
  - id: phase_imbalance
    type: model_based
    model: power_meter
    condition:
      expression: "abs(voltage_a - voltage_b) / voltage_a > 0.05"
    level: critical
```

### 第三阶段：集成 Lua 脚本告警

利用现有的 `sync.lua` 中的告警队列：

```lua
-- sync.lua 已支持的告警触发
if threshold and tonumber(value) > tonumber(threshold) then
    local alarm_data = string.format("%s:%s:%s:%s:%s", 
        alarm_id, model_id, point_name, value, timestamp)
    redis.call('LPUSH', 'alarm:queue', alarm_data)
end
```

AlarmSrv 监听 `alarm:queue`：

```rust
// 处理 Lua 脚本生成的告警
pub async fn process_alarm_queue(&self) -> Result<()> {
    loop {
        let alarm_data = self.redis_client.brpop("alarm:queue", 0).await?;
        self.process_lua_alarm(alarm_data).await?;
    }
}
```

## 配置示例

```yaml
# alarmsrv 配置
alarm:
  # 保留原有扫描模式
  scanner:
    enabled: true
    interval: 5s
    channels: [1001, 1002]
    
  # 新增订阅模式
  subscriber:
    enabled: true
    patterns:
      - "modsrv:*:update"
      - "comsrv:*:alarm"
      
  # 告警规则
  rules:
    # 基础规则（原有）
    basic:
      - channel: 1001
        point: 1
        threshold: 250
        
    # 模型规则（新增）
    model:
      - model: power_meter
        checks:
          - field: power_factor
            min: 0.85
          - expression: "thd_voltage < 5.0"
```

## 优势

1. **兼容性**：保留原有功能，平滑升级
2. **灵活性**：支持多种告警源和规则
3. **性能**：利用 ModSrv 的计算结果，避免重复计算
4. **实时性**：通过订阅模式提高响应速度

## 实施计划

1. **第1周**：添加 Redis 订阅框架
2. **第2周**：扩展规则引擎支持模型数据
3. **第3周**：集成 Lua 脚本告警队列
4. **第4周**：测试和优化