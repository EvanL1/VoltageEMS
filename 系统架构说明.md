# VoltageEMS 系统架构说明

## 系统概述

VoltageEMS 是一个基于微服务架构的工业物联网能源管理系统，专为电力监控、能源管理和设备控制而设计。系统采用 Rust 语言开发核心服务，确保高性能和可靠性，同时提供友好的 Web 界面进行监控和管理。

## 核心特性

- **高性能**: 基于 Rust 开发，内存安全，性能卓越
- **可扩展**: 微服务架构，各服务独立部署和扩展
- **多协议**: 支持 Modbus、CAN、IEC60870 等工业协议
- **云原生**: 容器化部署，支持主流云平台
- **实时性**: 毫秒级数据采集和响应
- **可视化**: 集成 Grafana，提供丰富的数据展示

## 整体架构

```mermaid
graph TB
    subgraph "边缘层 Edge Layer"
        DEV1[Modbus 设备]
        DEV2[CAN 设备]
        DEV3[IEC60870 设备]
        DEV4[GPIO 设备]
    end
    
    subgraph "数据采集层 Data Collection"
        COMSRV[通信服务<br/>comsrv]
    end
    
    subgraph "数据总线 Data Bus"
        REDIS[(Redis<br/>实时数据库)]
    end
    
    subgraph "业务处理层 Business Logic"
        MODSRV[模型服务<br/>modsrv]
        HISSRV[历史服务<br/>hissrv]
        ALARMSRV[告警服务<br/>alarmsrv]
        NETSRV[网络服务<br/>netsrv]
    end
    
    subgraph "数据存储层 Data Storage"
        INFLUX[(InfluxDB<br/>时序数据库)]
        PG[(PostgreSQL<br/>关系数据库)]
    end
    
    subgraph "应用层 Application Layer"
        WEB[Web 前端<br/>Vue.js]
        GRAFANA[Grafana<br/>数据可视化]
        API[API 网关<br/>apigateway]
    end
    
    subgraph "云平台 Cloud Platform"
        AWS[AWS IoT Core]
        ALI[阿里云 IoT]
        AZURE[Azure IoT Hub]
    end
    
    %% 数据流
    DEV1 & DEV2 & DEV3 & DEV4 -->|协议通信| COMSRV
    COMSRV -->|实时数据| REDIS
    
    REDIS -->|订阅| MODSRV
    REDIS -->|订阅| HISSRV
    REDIS -->|订阅| ALARMSRV
    REDIS -->|订阅| NETSRV
    
    MODSRV -->|计算结果| REDIS
    HISSRV -->|持久化| INFLUX
    ALARMSRV -->|告警数据| PG
    NETSRV -->|数据上传| AWS & ALI & AZURE
    
    API -->|查询| REDIS & INFLUX & PG
    WEB -->|API 调用| API
    GRAFANA -->|数据查询| INFLUX
    
    %% 样式
    classDef service fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef storage fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef app fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef device fill:#e8f5e9,stroke:#1b5e20,stroke-width:2px
    classDef cloud fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    
    class COMSRV,MODSRV,HISSRV,ALARMSRV,NETSRV service
    class REDIS,INFLUX,PG storage
    class WEB,GRAFANA,API app
    class DEV1,DEV2,DEV3,DEV4 device
    class AWS,ALI,AZURE cloud
```

## 数据流架构

```mermaid
sequenceDiagram
    participant D as 工业设备
    participant C as comsrv
    participant R as Redis
    participant M as modsrv
    participant H as hissrv
    participant A as alarmsrv
    participant N as netsrv
    participant I as InfluxDB
    participant CL as 云平台
    participant W as Web界面
    
    D->>C: 1. 设备数据
    C->>R: 2. 写入实时数据
    
    par 并行处理
        R->>M: 3a. 触发计算
        M->>R: 4a. 写入计算结果
    and
        R->>H: 3b. 数据持久化
        H->>I: 4b. 写入时序数据
    and
        R->>A: 3c. 告警检测
        A->>A: 4c. 生成告警
    and
        R->>N: 3d. 数据转发
        N->>CL: 4d. 上传云端
    end
    
    W->>R: 5. 查询实时数据
    W->>I: 6. 查询历史数据
```

## 服务说明

### 1. 通信服务 (comsrv)
- **功能**: 工业协议通信和数据采集
- **端口**: 8081
- **职责**: 
  - 支持多种工业协议
  - 设备连接管理
  - 数据格式转换
  - 实时数据写入 Redis

### 2. 模型服务 (modsrv)
- **功能**: 实时计算和控制逻辑
- **端口**: 8082
- **职责**:
  - DAG 工作流引擎
  - 内置算法库
  - 自定义脚本支持
  - 控制指令下发

### 3. 历史服务 (hissrv)
- **功能**: 历史数据存储和查询
- **端口**: 8090
- **职责**:
  - 数据持久化到 InfluxDB
  - 历史数据查询 API
  - Grafana 数据源
  - 数据聚合和降采样

### 4. 网络服务 (netsrv)
- **功能**: 数据转发和云平台集成
- **端口**: 8083
- **职责**:
  - MQTT/HTTP 数据推送
  - 云平台适配器
  - 离线缓存
  - 数据格式转换

### 5. 告警服务 (alarmsrv)
- **功能**: 智能告警管理
- **端口**: 8084
- **职责**:
  - 实时告警检测
  - 告警分类和抑制
  - 多渠道通知
  - 告警生命周期管理

## 技术栈

### 后端技术
- **编程语言**: Rust
- **Web 框架**: Actix-web
- **异步运行时**: Tokio
- **配置管理**: Figment
- **日志系统**: tracing/env_logger

### 数据存储
- **实时数据**: Redis
- **时序数据**: InfluxDB
- **关系数据**: PostgreSQL
- **配置文件**: YAML/JSON

### 前端技术
- **框架**: Vue.js 3
- **UI 组件**: Element Plus
- **图表**: ECharts
- **可视化**: Grafana
- **桌面应用**: Electron

### 部署技术
- **容器化**: Docker
- **编排**: Docker Compose
- **监控**: Prometheus + Grafana
- **日志**: ELK Stack

## 部署架构

```mermaid
graph TB
    subgraph "生产环境部署"
        subgraph "负载均衡"
            LB[Nginx/HAProxy]
        end
        
        subgraph "服务集群"
            C1[comsrv-1]
            C2[comsrv-2]
            M1[modsrv-1]
            M2[modsrv-2]
            H1[hissrv-1]
            A1[alarmsrv-1]
            N1[netsrv-1]
        end
        
        subgraph "数据层"
            RD1[(Redis 主)]
            RD2[(Redis 从)]
            IF[(InfluxDB 集群)]
            PG1[(PostgreSQL 主)]
            PG2[(PostgreSQL 从)]
        end
        
        subgraph "监控"
            PM[Prometheus]
            GF[Grafana]
            AL[AlertManager]
        end
    end
    
    LB --> C1 & C2 & M1 & M2 & H1 & A1 & N1
    C1 & C2 --> RD1
    M1 & M2 --> RD1
    H1 --> IF
    A1 --> PG1
    
    RD1 -.复制.-> RD2
    PG1 -.复制.-> PG2
    
    所有服务 --> PM
    PM --> GF
    PM --> AL
```

## 安全架构

### 网络安全
- TLS/SSL 加密通信
- VPN 隧道保护
- 防火墙规则
- DDoS 防护

### 应用安全
- JWT 身份认证
- RBAC 权限控制
- API 限流
- 数据加密

### 数据安全
- 敏感数据脱敏
- 备份加密
- 审计日志
- 访问控制

## 性能指标

- **数据采集**: 支持 10,000+ 数据点/秒
- **计算延迟**: < 100ms
- **存储容量**: PB 级数据存储
- **并发连接**: 1,000+ 设备同时连接
- **系统可用性**: 99.9%

## 扩展性设计

### 水平扩展
- 无状态服务设计
- 负载均衡分发
- 数据分片存储
- 消息队列解耦

### 垂直扩展
- 资源动态分配
- 缓存优化
- 算法优化
- 硬件加速

## 开发指南

### 环境搭建
```bash
# 克隆代码
git clone https://github.com/voltageems/voltageems.git

# 启动依赖服务
docker-compose up -d redis influxdb postgres

# 编译服务
cd services/comsrv && cargo build

# 运行服务
cargo run
```

### 新增服务
1. 在 `services/` 目录创建新服务
2. 实现 Redis 数据订阅/发布
3. 配置 Docker 镜像
4. 更新 docker-compose.yml
5. 编写服务文档

### 贡献指南
1. Fork 项目
2. 创建功能分支
3. 提交代码
4. 编写测试
5. 提交 Pull Request

## 运维指南

### 监控告警
- Prometheus 采集指标
- Grafana 展示面板
- AlertManager 告警通知
- 日志集中分析

### 备份恢复
- Redis 定期快照
- InfluxDB 连续备份
- PostgreSQL 主从复制
- 配置文件版本控制

### 故障处理
- 服务健康检查
- 自动故障转移
- 熔断降级机制
- 灾难恢复计划

## 路线图

### 短期计划
- [ ] 支持 OPC UA 协议
- [ ] 增加边缘计算能力
- [ ] 优化数据压缩算法
- [ ] 完善 API 文档

### 中期计划
- [ ] AI 预测性维护
- [ ] 分布式部署支持
- [ ] 多租户架构
- [ ] 移动端应用

### 长期愿景
- [ ] 支持更多工业协议
- [ ] 建立生态系统
- [ ] 行业解决方案
- [ ] 国际化支持