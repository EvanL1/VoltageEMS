# Motor Control Rules
# Defines business logic and command values for motor operations
# Rule engine (rulesrv) knows WHAT values to send for each operation

rule_set:
  name: "Motor Control Rules"
  description: "Industrial motor controller operation rules and command sequences"
  version: "1.0.0"

rules:
  # ============================================
  # Fault Management Rules
  # ============================================

  motor_fault_auto_reset:
    name: "Auto Reset Motor Fault"
    description: "Automatically reset motor fault after delay"
    enabled: true
    trigger:
      type: "condition"
      expression: "motor_01.M33 == 1"  # fault_status == true
      delay: 5000  # Wait 5 seconds before auto-reset
    conditions:
      - "motor_01.M19 < 5"  # operating_hours < 5 (prevent reset loop)
    actions:
      - target: "motor_01.A5"  # fault_reset action
        value: 1               # Send 1 to trigger reset

  motor_fault_alert:
    name: "Motor Fault Alert"
    description: "Alert when motor enters fault state"
    enabled: true
    trigger:
      type: "condition"
      expression: "motor_01.M33 == 1"  # fault_status
    actions:
      - type: "alert"
        severity: "critical"
        message: "Motor fault detected: Error code ${motor_01.M3}"

  # ============================================
  # Manual Control Rules
  # ============================================

  motor_manual_start:
    name: "Start Motor"
    description: "Manual motor start sequence"
    enabled: true
    trigger:
      type: "manual"
      confirm: false
    conditions:
      - "motor_01.M30 == 1"  # ready_to_switch_on == true
      - "motor_01.M33 == 0"  # fault_status == false
    actions:
      - target: "motor_01.A1"  # control_word
        value: 0x000F          # Start sequence (bits 0-3 set)

  motor_manual_stop:
    name: "Stop Motor"
    description: "Normal motor stop"
    enabled: true
    trigger:
      type: "manual"
    conditions:
      - "motor_01.M32 == 1"  # operation_enabled == true
    actions:
      - target: "motor_01.A1"  # control_word
        value: 0x0006          # Stop sequence

  motor_emergency_stop:
    name: "Emergency Stop"
    description: "Emergency stop - immediate halt"
    enabled: true
    trigger:
      type: "manual"
      priority: "critical"
      confirm: false  # No confirmation for emergency
    actions:
      - target: "motor_01.A6"  # emergency_stop action
        value: 1               # Trigger emergency stop

  motor_quick_stop:
    name: "Quick Stop"
    description: "Quick stop with controlled deceleration"
    enabled: true
    trigger:
      type: "manual"
    actions:
      - target: "motor_01.A4"  # quick_stop action
        value: 1               # Trigger quick stop

  # ============================================
  # Operation Mode Control
  # ============================================

  set_position_mode:
    name: "Position Control Mode"
    description: "Switch to position control mode"
    enabled: true
    trigger:
      type: "manual"
    conditions:
      - "motor_01.M31 == 1"  # switched_on == true
      - "motor_01.M32 == 0"  # operation_enabled == false (must be disabled to switch)
    actions:
      - target: "motor_01.A2"  # set_operation_mode
        value: 1               # Position mode = 1

  set_velocity_mode:
    name: "Velocity Control Mode"
    description: "Switch to velocity control mode"
    enabled: true
    trigger:
      type: "manual"
    conditions:
      - "motor_01.M31 == 1"  # switched_on == true
      - "motor_01.M32 == 0"  # operation_enabled == false
    actions:
      - target: "motor_01.A2"  # set_operation_mode
        value: 3               # Velocity mode = 3

  set_torque_mode:
    name: "Torque Control Mode"
    description: "Switch to torque control mode"
    enabled: true
    trigger:
      type: "manual"
    conditions:
      - "motor_01.M31 == 1"  # switched_on == true
      - "motor_01.M32 == 0"  # operation_enabled == false
    actions:
      - target: "motor_01.A2"  # set_operation_mode
        value: 4               # Torque mode = 4

  set_homing_mode:
    name: "Homing Mode"
    description: "Switch to homing mode for reference positioning"
    enabled: true
    trigger:
      type: "manual"
    conditions:
      - "motor_01.M31 == 1"  # switched_on == true
      - "motor_01.M32 == 0"  # operation_enabled == false
    actions:
      - target: "motor_01.A2"  # set_operation_mode
        value: 6               # Homing mode = 6

  # ============================================
  # Parameter Management
  # ============================================

  save_motor_parameters:
    name: "Save Parameters"
    description: "Save current motor parameters to non-volatile memory"
    enabled: true
    trigger:
      type: "manual"
      confirm: true  # Require confirmation
    conditions:
      - "motor_01.M32 == 0"  # operation_enabled == false (motor stopped)
    actions:
      - target: "motor_01.A39"  # save_parameters
        value: 0x65766173       # ASCII "save" = 0x65766173

  restore_default_parameters:
    name: "Restore Factory Defaults"
    description: "Restore all parameters to factory default values"
    enabled: true
    trigger:
      type: "manual"
      confirm: true  # Require confirmation
      confirm_message: "This will reset ALL motor parameters to factory defaults. Continue?"
    conditions:
      - "motor_01.M32 == 0"  # operation_enabled == false
    actions:
      - target: "motor_01.A40"  # restore_defaults
        value: 0x64656661       # ASCII "defa" = 0x64656661

  clear_fault_history:
    name: "Clear Fault History"
    description: "Clear all fault history records"
    enabled: true
    trigger:
      type: "manual"
    conditions:
      - "motor_01.M33 == 0"  # fault_status == false (no active fault)
    actions:
      - target: "motor_01.A41"  # clear_fault_history
        value: 1                # Send 1 to clear

  # ============================================
  # Setpoint Control (Parameterized)
  # ============================================

  set_motor_speed:
    name: "Set Target Speed"
    description: "Set target velocity for speed control"
    enabled: true
    trigger:
      type: "manual"
      parameters:
        - name: "speed"
          type: "float"
          unit: "rpm"
          min: -3000
          max: 3000
          default: 0
    conditions:
      - "motor_01.M2 == 3"     # operation_mode == velocity (3)
      - "motor_01.M32 == 1"    # operation_enabled == true
    actions:
      - target: "motor_01.A10"  # target_velocity
        value: "${speed}"       # Use parameter value

  set_motor_position:
    name: "Set Target Position"
    description: "Set target position for position control"
    enabled: true
    trigger:
      type: "manual"
      parameters:
        - name: "position"
          type: "int32"
          unit: "counts"
          min: -1000000
          max: 1000000
          default: 0
    conditions:
      - "motor_01.M2 == 1"     # operation_mode == position (1)
      - "motor_01.M32 == 1"    # operation_enabled == true
    actions:
      - target: "motor_01.A11"  # target_position
        value: "${position}"    # Use parameter value

  set_motor_torque:
    name: "Set Target Torque"
    description: "Set target torque for torque control"
    enabled: true
    trigger:
      type: "manual"
      parameters:
        - name: "torque"
          type: "float"
          unit: "%"
          min: -100
          max: 100
          default: 0
    conditions:
      - "motor_01.M2 == 4"     # operation_mode == torque (4)
      - "motor_01.M32 == 1"    # operation_enabled == true
    actions:
      - target: "motor_01.A12"  # target_torque
        value: "${torque}"      # Use parameter value

  # ============================================
  # Complex Sequences
  # ============================================

  homing_sequence:
    name: "Execute Homing"
    description: "Complete homing sequence to establish reference position"
    enabled: true
    trigger:
      type: "manual"
    sequence:
      # Step 1: Switch to homing mode
      - conditions:
          - "motor_01.M31 == 1"  # switched_on
        actions:
          - target: "motor_01.A2"  # set_operation_mode
            value: 6               # Homing mode
        delay: 100

      # Step 2: Configure homing parameters
      - actions:
          - target: "motor_01.A29"  # homing_method
            value: 17              # Method 17: Negative limit switch
          - target: "motor_01.A30"  # homing_speed_switch
            value: 100             # 100 rpm for switch search
          - target: "motor_01.A31"  # homing_speed_zero
            value: 10              # 10 rpm for zero search
        delay: 100

      # Step 3: Start homing
      - actions:
          - target: "motor_01.A1"   # control_word
            value: 0x001F          # Start homing (bit 4 set)

      # Step 4: Wait for completion
      - wait_condition: "motor_01.M43 == 1"  # homing_attained
        timeout: 30000  # 30 second timeout
        on_timeout:
          - type: "alert"
            message: "Homing timeout - check motor status"

  startup_sequence:
    name: "Complete Startup"
    description: "Full startup sequence from power-on to operational"
    enabled: true
    trigger:
      type: "manual"
    sequence:
      # Step 1: Clear any faults
      - conditions:
          - "motor_01.M33 == 1"  # fault exists
        actions:
          - target: "motor_01.A5"  # fault_reset
            value: 1
        delay: 500

      # Step 2: Enable voltage
      - actions:
          - target: "motor_01.A1"  # control_word
            value: 0x0006         # Shutdown → Ready
        delay: 100

      # Step 3: Switch on
      - conditions:
          - "motor_01.M30 == 1"  # ready_to_switch_on
        actions:
          - target: "motor_01.A1"  # control_word
            value: 0x0007         # Ready → Switched On
        delay: 100

      # Step 4: Enable operation
      - conditions:
          - "motor_01.M31 == 1"  # switched_on
        actions:
          - target: "motor_01.A1"  # control_word
            value: 0x000F         # Switched On → Operation Enabled

  # ============================================
  # Automatic Protection Rules
  # ============================================

  overtemperature_protection:
    name: "Overtemperature Protection"
    description: "Stop motor on overtemperature"
    enabled: true
    trigger:
      type: "condition"
      expression: "motor_01.M9 > 85"  # motor_temperature > 85°C
    conditions:
      - "motor_01.M32 == 1"  # operation_enabled
    actions:
      - target: "motor_01.A6"  # emergency_stop
        value: 1
      - type: "alert"
        severity: "critical"
        message: "Motor overtemperature: ${motor_01.M9}°C"

  overcurrent_protection:
    name: "Overcurrent Protection"
    description: "Reduce speed on overcurrent"
    enabled: true
    trigger:
      type: "condition"
      expression: "motor_01.M8 > motor_01.M27 * 1.1"  # actual_current > limit * 110%
      hold_time: 1000  # Must persist for 1 second
    conditions:
      - "motor_01.M2 == 3"  # in velocity mode
    actions:
      - target: "motor_01.A10"  # target_velocity
        value: "${motor_01.M5 * 0.8}"  # Reduce to 80% of current speed
      - type: "alert"
        severity: "warning"
        message: "Motor current limited - reducing speed"