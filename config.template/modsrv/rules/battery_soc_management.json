{
  "id": "battery_soc_management",
  "name": "Battery SOC Management Rule",
  "description": "Automatic battery state of charge management with diesel generator backup and PV curtailment",
  "enabled": true,
  "priority": 100,
  "flow_json": {
    "nodes": [
      {
        "id": "start",
        "type": "start",
        "position": { "x": 250, "y": 50 },
        "data": { "label": "Start" }
      },
      {
        "id": "read_soc",
        "type": "input",
        "position": { "x": 150, "y": 150 },
        "data": {
          "label": "Read current SOC",
          "source_type": "measurement_point",
          "instance_id": "battery_system",
          "point_id": "soc_current"
        }
      },
      {
        "id": "load_config",
        "type": "input",
        "position": { "x": 350, "y": 150 },
        "data": {
          "label": "Load threshold config",
          "config_params": [
            "soc_recover_threshold",
            "soc_upper_limit",
            "soc_lower_limit"
          ]
        }
      },
      {
        "id": "soc_condition",
        "type": "decision",
        "position": { "x": 250, "y": 280 },
        "data": {
          "label": "SOC conditions",
          "conditions": [
            {
              "condition": "SOC <= SOC_l && DG.status == 'stopped'",
              "output": "low_soc",
              "description": "Low battery, DG backup needed"
            },
            {
              "condition": "SOC >= SOC_r && DG.status == 'running'",
              "output": "normal_mode",
              "description": "Battery recovered, normal mode"
            },
            {
              "condition": "SOC >= SOC_u",
              "output": "high_soc",
              "description": "High SOC, curtail PV"
            }
          ]
        }
      },
      {
        "id": "rule1_low_soc_backup",
        "type": "action",
        "position": { "x": 100, "y": 450 },
        "data": {
          "label": "Rule 1: low_soc_backup",
          "actions": [
            {
              "action": "control",
              "target": "diesel_generator",
              "command": "start",
              "description": "Turn on the DG"
            },
            {
              "action": "set_power",
              "target": "diesel_generator",
              "value": "P_pMax",
              "expression": "P_d = P_pMax",
              "description": "Set DG power to PV rated power"
            }
          ]
        }
      },
      {
        "id": "check_dg_running",
        "type": "decision",
        "position": { "x": 100, "y": 600 },
        "data": {
          "label": "DG Running?",
          "condition": "DG.status == 'running'"
        }
      },
      {
        "id": "rule2_normal_mode",
        "type": "action",
        "position": { "x": 350, "y": 450 },
        "data": {
          "label": "Rule 2: normal_mode",
          "actions": [
            {
              "action": "control",
              "target": "diesel_generator",
              "command": "stop",
              "description": "Turn off the DG"
            },
            {
              "action": "set_power",
              "target": "pv_system",
              "value": "P_pMax",
              "expression": "P_p = P_pMax",
              "description": "Set PV power to rated power"
            }
          ]
        }
      },
      {
        "id": "rule3_high_soc_curtail",
        "type": "action",
        "position": { "x": 600, "y": 450 },
        "data": {
          "label": "Rule 3: High_soc_curtail",
          "actions": [
            {
              "action": "set_power",
              "target": "pv_system",
              "value": "P_l",
              "expression": "P_p = P_l",
              "description": "Set PV power to current load"
            }
          ]
        }
      },
      {
        "id": "end",
        "type": "end",
        "position": { "x": 250, "y": 700 },
        "data": { "label": "End" }
      }
    ],
    "edges": [
      { "id": "e_start_read", "source": "start", "target": "read_soc", "type": "default" },
      { "id": "e_start_config", "source": "start", "target": "load_config", "type": "default" },
      { "id": "e_read_decision", "source": "read_soc", "target": "soc_condition", "type": "default" },
      { "id": "e_config_decision", "source": "load_config", "target": "soc_condition", "type": "default" },
      {
        "id": "e_decision_rule1",
        "source": "soc_condition",
        "sourceHandle": "low_soc",
        "target": "rule1_low_soc_backup",
        "type": "conditional",
        "label": "SOC <= SOC_l & DG Stopped"
      },
      { "id": "e_rule1_check", "source": "rule1_low_soc_backup", "target": "check_dg_running", "type": "default" },
      {
        "id": "e_check_end_yes",
        "source": "check_dg_running",
        "sourceHandle": "yes",
        "target": "end",
        "type": "conditional",
        "label": "Yes"
      },
      {
        "id": "e_check_rule1_no",
        "source": "check_dg_running",
        "sourceHandle": "no",
        "target": "rule1_low_soc_backup",
        "type": "conditional",
        "label": "No"
      },
      {
        "id": "e_decision_rule2",
        "source": "soc_condition",
        "sourceHandle": "normal_mode",
        "target": "rule2_normal_mode",
        "type": "conditional",
        "label": "SOC >= SOC_r & DG Running"
      },
      { "id": "e_rule2_end", "source": "rule2_normal_mode", "target": "end", "type": "default" },
      {
        "id": "e_decision_rule3",
        "source": "soc_condition",
        "sourceHandle": "high_soc",
        "target": "rule3_high_soc_curtail",
        "type": "conditional",
        "label": "SOC >= SOC_u"
      },
      { "id": "e_rule3_end", "source": "rule3_high_soc_curtail", "target": "end", "type": "default" }
    ],
    "viewport": { "x": 0, "y": 0, "zoom": 1 },
    "metadata": {
      "execution_interval": 5,
      "retry_on_failure": true,
      "max_retries": 3,
      "variables": {
        "SOC": "Current SOC for the battery",
        "SOC_r": "SOC Recover Threshold",
        "SOC_u": "SOC Upper Limit",
        "SOC_l": "SOC Lower Limit",
        "P_e": "Current power of the ESS, '+' means discharger, '-' means charge",
        "P_d": "Current power of Diesel Generator",
        "P_p": "Current power of PV",
        "P_l": "Current load",
        "P_pMax": "Rated Power of PV system"
      }
    }
  }
}
